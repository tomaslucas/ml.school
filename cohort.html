<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ml.school - Building Machine Learning Systems That Don’t Suck</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="ml.school - Building Machine Learning Systems That Don’t Suck">
<meta property="og:description" content="Machine Learning School">
<meta property="og:site_name" content="ml.school">
<meta name="twitter:title" content="ml.school - Building Machine Learning Systems That Don’t Suck">
<meta name="twitter:description" content="Machine Learning School">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ml.school</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cohort.html">Building Machine Learning Systems That Don’t Suck</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cohort.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Building Machine Learning Systems That Don’t Suck</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#session-1---introduction-and-initial-setup" id="toc-session-1---introduction-and-initial-setup" class="nav-link active" data-scroll-target="#session-1---introduction-and-initial-setup">Session 1 - Introduction and Initial Setup</a></li>
  <li><a href="#session-2---exploratory-data-analysis" id="toc-session-2---exploratory-data-analysis" class="nav-link" data-scroll-target="#session-2---exploratory-data-analysis">Session 2 - Exploratory Data Analysis</a></li>
  <li><a href="#session-3---splitting-and-transforming-the-data" id="toc-session-3---splitting-and-transforming-the-data" class="nav-link" data-scroll-target="#session-3---splitting-and-transforming-the-data">Session 3 - Splitting and Transforming the Data</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-preprocessing-script" id="toc-step-1---creating-the-preprocessing-script" class="nav-link" data-scroll-target="#step-1---creating-the-preprocessing-script">Step 1 - Creating the Preprocessing Script</a></li>
  <li><a href="#step-2---caching-configuration" id="toc-step-2---caching-configuration" class="nav-link" data-scroll-target="#step-2---caching-configuration">Step 2 - Caching Configuration</a></li>
  <li><a href="#step-3---pipeline-configuration" id="toc-step-3---pipeline-configuration" class="nav-link" data-scroll-target="#step-3---pipeline-configuration">Step 3 - Pipeline Configuration</a></li>
  <li><a href="#step-4---setting-up-the-processing-step" id="toc-step-4---setting-up-the-processing-step" class="nav-link" data-scroll-target="#step-4---setting-up-the-processing-step">Step 4 - Setting up the Processing Step</a></li>
  <li><a href="#step-5---creating-the-pipeline" id="toc-step-5---creating-the-pipeline" class="nav-link" data-scroll-target="#step-5---creating-the-pipeline">Step 5 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-4---training-the-model" id="toc-session-4---training-the-model" class="nav-link" data-scroll-target="#session-4---training-the-model">Session 4 - Training the Model</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-training-script" id="toc-step-1---creating-the-training-script" class="nav-link" data-scroll-target="#step-1---creating-the-training-script">Step 1 - Creating the Training Script</a></li>
  <li><a href="#step-2---setting-up-the-training-step" id="toc-step-2---setting-up-the-training-step" class="nav-link" data-scroll-target="#step-2---setting-up-the-training-step">Step 2 - Setting up the Training Step</a></li>
  <li><a href="#step-3---creating-the-pipeline" id="toc-step-3---creating-the-pipeline" class="nav-link" data-scroll-target="#step-3---creating-the-pipeline">Step 3 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-5---custom-training-container" id="toc-session-5---custom-training-container" class="nav-link" data-scroll-target="#session-5---custom-training-container">Session 5 - Custom Training Container</a>
  <ul class="collapse">
  <li><a href="#step-1---preparing-the-docker-image" id="toc-step-1---preparing-the-docker-image" class="nav-link" data-scroll-target="#step-1---preparing-the-docker-image">Step 1 - Preparing the Docker Image</a></li>
  <li><a href="#step-2---building-the-docker-image" id="toc-step-2---building-the-docker-image" class="nav-link" data-scroll-target="#step-2---building-the-docker-image">Step 2 - Building the Docker Image</a></li>
  <li><a href="#step-3---pushing-docker-image-to-ecr" id="toc-step-3---pushing-docker-image-to-ecr" class="nav-link" data-scroll-target="#step-3---pushing-docker-image-to-ecr">Step 3 - Pushing Docker Image to ECR</a></li>
  <li><a href="#step-4---setting-up-the-training-step" id="toc-step-4---setting-up-the-training-step" class="nav-link" data-scroll-target="#step-4---setting-up-the-training-step">Step 4 - Setting up the Training Step</a></li>
  <li><a href="#step-5---creating-the-pipeline-1" id="toc-step-5---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-5---creating-the-pipeline-1">Step 5 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-6---tuning-the-model" id="toc-session-6---tuning-the-model" class="nav-link" data-scroll-target="#session-6---tuning-the-model">Session 6 - Tuning the Model</a>
  <ul class="collapse">
  <li><a href="#step-1---enabling-tuning" id="toc-step-1---enabling-tuning" class="nav-link" data-scroll-target="#step-1---enabling-tuning">Step 1 - Enabling Tuning</a></li>
  <li><a href="#step-2---setting-up-a-tuning-step" id="toc-step-2---setting-up-a-tuning-step" class="nav-link" data-scroll-target="#step-2---setting-up-a-tuning-step">Step 2 - Setting up a Tuning Step</a></li>
  <li><a href="#step-3---creating-the-pipeline-1" id="toc-step-3---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-3---creating-the-pipeline-1">Step 3 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-7---evaluating-the-model" id="toc-session-7---evaluating-the-model" class="nav-link" data-scroll-target="#session-7---evaluating-the-model">Session 7 - Evaluating the Model</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-evaluation-script" id="toc-step-1---creating-the-evaluation-script" class="nav-link" data-scroll-target="#step-1---creating-the-evaluation-script">Step 1 - Creating the Evaluation Script</a></li>
  <li><a href="#step-2---referencing-the-model-assets" id="toc-step-2---referencing-the-model-assets" class="nav-link" data-scroll-target="#step-2---referencing-the-model-assets">Step 2 - Referencing the Model Assets</a></li>
  <li><a href="#step-3---mapping-the-output-to-a-property-file" id="toc-step-3---mapping-the-output-to-a-property-file" class="nav-link" data-scroll-target="#step-3---mapping-the-output-to-a-property-file">Step 3 - Mapping the Output to a Property File</a></li>
  <li><a href="#step-4---setting-up-the-evaluation-step" id="toc-step-4---setting-up-the-evaluation-step" class="nav-link" data-scroll-target="#step-4---setting-up-the-evaluation-step">Step 4 - Setting up the Evaluation Step</a></li>
  <li><a href="#step-5---creating-the-pipeline-2" id="toc-step-5---creating-the-pipeline-2" class="nav-link" data-scroll-target="#step-5---creating-the-pipeline-2">Step 5 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-8---registering-the-model" id="toc-session-8---registering-the-model" class="nav-link" data-scroll-target="#session-8---registering-the-model">Session 8 - Registering the Model</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-the-model-package-group" id="toc-step-1---configuring-the-model-package-group" class="nav-link" data-scroll-target="#step-1---configuring-the-model-package-group">Step 1 - Configuring the Model Package Group</a></li>
  <li><a href="#step-2---creating-the-model" id="toc-step-2---creating-the-model" class="nav-link" data-scroll-target="#step-2---creating-the-model">Step 2 - Creating the Model</a></li>
  <li><a href="#step-3---configuring-model-metrics" id="toc-step-3---configuring-model-metrics" class="nav-link" data-scroll-target="#step-3---configuring-model-metrics">Step 3 - Configuring Model Metrics</a></li>
  <li><a href="#step-4---registering-the-model" id="toc-step-4---registering-the-model" class="nav-link" data-scroll-target="#step-4---registering-the-model">Step 4 - Registering the Model</a></li>
  <li><a href="#step-5---creating-the-pipeline-3" id="toc-step-5---creating-the-pipeline-3" class="nav-link" data-scroll-target="#step-5---creating-the-pipeline-3">Step 5 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-9---conditional-registration" id="toc-session-9---conditional-registration" class="nav-link" data-scroll-target="#session-9---conditional-registration">Session 9 - Conditional Registration</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-the-accuracy-threshold" id="toc-step-1---configuring-the-accuracy-threshold" class="nav-link" data-scroll-target="#step-1---configuring-the-accuracy-threshold">Step 1 - Configuring the Accuracy Threshold</a></li>
  <li><a href="#step-2---setting-up-a-fail-step" id="toc-step-2---setting-up-a-fail-step" class="nav-link" data-scroll-target="#step-2---setting-up-a-fail-step">Step 2 - Setting up a Fail Step</a></li>
  <li><a href="#step-3---defining-the-condition" id="toc-step-3---defining-the-condition" class="nav-link" data-scroll-target="#step-3---defining-the-condition">Step 3 - Defining the Condition</a></li>
  <li><a href="#step-4---setting-up-the-condition-step" id="toc-step-4---setting-up-the-condition-step" class="nav-link" data-scroll-target="#step-4---setting-up-the-condition-step">Step 4 - Setting up the Condition Step</a></li>
  <li><a href="#step-5---creating-the-pipeline-4" id="toc-step-5---creating-the-pipeline-4" class="nav-link" data-scroll-target="#step-5---creating-the-pipeline-4">Step 5 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-10---serving-the-model" id="toc-session-10---serving-the-model" class="nav-link" data-scroll-target="#session-10---serving-the-model">Session 10 - Serving the Model</a>
  <ul class="collapse">
  <li><a href="#step-1---retrieving-list-of-approved-models" id="toc-step-1---retrieving-list-of-approved-models" class="nav-link" data-scroll-target="#step-1---retrieving-list-of-approved-models">Step 1 - Retrieving List of Approved Models</a></li>
  <li><a href="#step-2---downloading-the-model" id="toc-step-2---downloading-the-model" class="nav-link" data-scroll-target="#step-2---downloading-the-model">Step 2 - Downloading the Model</a></li>
  <li><a href="#step-3---creating-the-serving-script" id="toc-step-3---creating-the-serving-script" class="nav-link" data-scroll-target="#step-3---creating-the-serving-script">Step 3 - Creating the Serving Script</a></li>
  <li><a href="#step-4---running-the-flask-application" id="toc-step-4---running-the-flask-application" class="nav-link" data-scroll-target="#step-4---running-the-flask-application">Step 4 - Running the Flask Application</a></li>
  </ul></li>
  <li><a href="#session-11---deploying-the-model" id="toc-session-11---deploying-the-model" class="nav-link" data-scroll-target="#session-11---deploying-the-model">Session 11 - Deploying the Model</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-the-endpoint-name" id="toc-step-1---configuring-the-endpoint-name" class="nav-link" data-scroll-target="#step-1---configuring-the-endpoint-name">Step 1 - Configuring the Endpoint Name</a></li>
  <li><a href="#step-2---creating-a-model-package" id="toc-step-2---creating-a-model-package" class="nav-link" data-scroll-target="#step-2---creating-a-model-package">Step 2 - Creating a Model Package</a></li>
  <li><a href="#step-3---deploying-the-model" id="toc-step-3---deploying-the-model" class="nav-link" data-scroll-target="#step-3---deploying-the-model">Step 3 - Deploying the Model</a></li>
  <li><a href="#step-4---testing-the-endpoint" id="toc-step-4---testing-the-endpoint" class="nav-link" data-scroll-target="#step-4---testing-the-endpoint">Step 4 - Testing the Endpoint</a></li>
  </ul></li>
  <li><a href="#session-12---deploying-from-the-pipeline" id="toc-session-12---deploying-from-the-pipeline" class="nav-link" data-scroll-target="#session-12---deploying-from-the-pipeline">Session 12 - Deploying From the Pipeline</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-data-capture-settings" id="toc-step-1---configuring-data-capture-settings" class="nav-link" data-scroll-target="#step-1---configuring-data-capture-settings">Step 1 - Configuring Data Capture Settings</a></li>
  <li><a href="#step-2---setting-up-the-lambda-function" id="toc-step-2---setting-up-the-lambda-function" class="nav-link" data-scroll-target="#step-2---setting-up-the-lambda-function">Step 2 - Setting up the Lambda Function</a></li>
  <li><a href="#step-3---setting-up-lambda-permissions" id="toc-step-3---setting-up-lambda-permissions" class="nav-link" data-scroll-target="#step-3---setting-up-lambda-permissions">Step 3 - Setting up Lambda Permissions</a></li>
  <li><a href="#step-4---creating-the-lambda-function" id="toc-step-4---creating-the-lambda-function" class="nav-link" data-scroll-target="#step-4---creating-the-lambda-function">Step 4 - Creating the Lambda Function</a></li>
  <li><a href="#step-5---setting-up-the-lambda-step" id="toc-step-5---setting-up-the-lambda-step" class="nav-link" data-scroll-target="#step-5---setting-up-the-lambda-step">Step 5 - Setting up the Lambda Step</a></li>
  <li><a href="#step-6---modifying-the-condition-step" id="toc-step-6---modifying-the-condition-step" class="nav-link" data-scroll-target="#step-6---modifying-the-condition-step">Step 6 - Modifying the Condition Step</a></li>
  <li><a href="#step-7---creating-the-pipeline" id="toc-step-7---creating-the-pipeline" class="nav-link" data-scroll-target="#step-7---creating-the-pipeline">Step 7 - Creating the Pipeline</a></li>
  <li><a href="#step-8---testing-the-endpoint" id="toc-step-8---testing-the-endpoint" class="nav-link" data-scroll-target="#step-8---testing-the-endpoint">Step 8 - Testing the Endpoint</a></li>
  </ul></li>
  <li><a href="#session-13---deploying-from-an-event" id="toc-session-13---deploying-from-an-event" class="nav-link" data-scroll-target="#session-13---deploying-from-an-event">Session 13 - Deploying From an Event</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-the-model-package-group-1" id="toc-step-1---configuring-the-model-package-group-1" class="nav-link" data-scroll-target="#step-1---configuring-the-model-package-group-1">Step 1 - Configuring the Model Package Group</a></li>
  <li><a href="#step-2---setting-up-eventbridge" id="toc-step-2---setting-up-eventbridge" class="nav-link" data-scroll-target="#step-2---setting-up-eventbridge">Step 2 - Setting Up EventBridge</a></li>
  <li><a href="#step-3---configuring-the-lambda-permissions" id="toc-step-3---configuring-the-lambda-permissions" class="nav-link" data-scroll-target="#step-3---configuring-the-lambda-permissions">Step 3 - Configuring the Lambda Permissions</a></li>
  <li><a href="#step-4---registering-the-model-1" id="toc-step-4---registering-the-model-1" class="nav-link" data-scroll-target="#step-4---registering-the-model-1">Step 4 - Registering the Model</a></li>
  <li><a href="#step-5---modifying-the-condition-step" id="toc-step-5---modifying-the-condition-step" class="nav-link" data-scroll-target="#step-5---modifying-the-condition-step">Step 5 - Modifying the Condition Step</a></li>
  <li><a href="#step-6---creating-the-pipeline" id="toc-step-6---creating-the-pipeline" class="nav-link" data-scroll-target="#step-6---creating-the-pipeline">Step 6 - Creating the Pipeline</a></li>
  </ul></li>
  <li><a href="#session-14---building-an-inference-pipeline" id="toc-session-14---building-an-inference-pipeline" class="nav-link" data-scroll-target="#session-14---building-an-inference-pipeline">Session 14 - Building an Inference Pipeline</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-preprocessing-script-1" id="toc-step-1---creating-the-preprocessing-script-1" class="nav-link" data-scroll-target="#step-1---creating-the-preprocessing-script-1">Step 1 - Creating the Preprocessing Script</a></li>
  <li><a href="#step-2---creating-the-postprocessing-script" id="toc-step-2---creating-the-postprocessing-script" class="nav-link" data-scroll-target="#step-2---creating-the-postprocessing-script">Step 2 - Creating the Postprocessing Script</a></li>
  <li><a href="#step-3---setting-up-the-inference-pipeline" id="toc-step-3---setting-up-the-inference-pipeline" class="nav-link" data-scroll-target="#step-3---setting-up-the-inference-pipeline">Step 3 - Setting up the Inference Pipeline</a></li>
  <li><a href="#step-4---configuring-the-model-package-group" id="toc-step-4---configuring-the-model-package-group" class="nav-link" data-scroll-target="#step-4---configuring-the-model-package-group">Step 4 - Configuring the Model Package Group</a></li>
  <li><a href="#step-5---registering-the-model" id="toc-step-5---registering-the-model" class="nav-link" data-scroll-target="#step-5---registering-the-model">Step 5 - Registering the Model</a></li>
  <li><a href="#step-6---modifying-the-deploy-step" id="toc-step-6---modifying-the-deploy-step" class="nav-link" data-scroll-target="#step-6---modifying-the-deploy-step">Step 6 - Modifying the Deploy Step</a></li>
  <li><a href="#step-7---modifying-the-condition-step" id="toc-step-7---modifying-the-condition-step" class="nav-link" data-scroll-target="#step-7---modifying-the-condition-step">Step 7 - Modifying the Condition Step</a></li>
  <li><a href="#step-8---creating-the-pipeline" id="toc-step-8---creating-the-pipeline" class="nav-link" data-scroll-target="#step-8---creating-the-pipeline">Step 8 - Creating the Pipeline</a></li>
  <li><a href="#step-9---testing-the-endpoint" id="toc-step-9---testing-the-endpoint" class="nav-link" data-scroll-target="#step-9---testing-the-endpoint">Step 9 - Testing the Endpoint</a></li>
  </ul></li>
  <li><a href="#session-15---custom-inference-script" id="toc-session-15---custom-inference-script" class="nav-link" data-scroll-target="#session-15---custom-inference-script">Session 15 - Custom Inference Script</a>
  <ul class="collapse">
  <li><a href="#step-1---creating-the-inference-script" id="toc-step-1---creating-the-inference-script" class="nav-link" data-scroll-target="#step-1---creating-the-inference-script">Step 1 - Creating the Inference Script</a></li>
  <li><a href="#step-2---creating-the-model-1" id="toc-step-2---creating-the-model-1" class="nav-link" data-scroll-target="#step-2---creating-the-model-1">Step 2 - Creating the Model</a></li>
  <li><a href="#step-3---configuring-the-model-package-group" id="toc-step-3---configuring-the-model-package-group" class="nav-link" data-scroll-target="#step-3---configuring-the-model-package-group">Step 3 - Configuring the Model Package Group</a></li>
  <li><a href="#step-4---registering-the-model-2" id="toc-step-4---registering-the-model-2" class="nav-link" data-scroll-target="#step-4---registering-the-model-2">Step 4 - Registering the Model</a></li>
  <li><a href="#step-5---modifying-the-deploy-step" id="toc-step-5---modifying-the-deploy-step" class="nav-link" data-scroll-target="#step-5---modifying-the-deploy-step">Step 5 - Modifying the Deploy Step</a></li>
  <li><a href="#step-6---modifying-the-condition-step-1" id="toc-step-6---modifying-the-condition-step-1" class="nav-link" data-scroll-target="#step-6---modifying-the-condition-step-1">Step 6 - Modifying the Condition Step</a></li>
  <li><a href="#step-7---creating-the-pipeline-1" id="toc-step-7---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-7---creating-the-pipeline-1">Step 7 - Creating the Pipeline</a></li>
  <li><a href="#step-8---testing-the-endpoint-1" id="toc-step-8---testing-the-endpoint-1" class="nav-link" data-scroll-target="#step-8---testing-the-endpoint-1">Step 8 - Testing the Endpoint</a></li>
  </ul></li>
  <li><a href="#session-16---data-quality-baseline" id="toc-session-16---data-quality-baseline" class="nav-link" data-scroll-target="#session-16---data-quality-baseline">Session 16 - Data Quality Baseline</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-baseline-location" id="toc-step-1---configuring-baseline-location" class="nav-link" data-scroll-target="#step-1---configuring-baseline-location">Step 1 - Configuring Baseline Location</a></li>
  <li><a href="#step-2---generating-data-quality-baseline" id="toc-step-2---generating-data-quality-baseline" class="nav-link" data-scroll-target="#step-2---generating-data-quality-baseline">Step 2 - Generating Data Quality Baseline</a></li>
  <li><a href="#step-3---setting-up-model-metrics" id="toc-step-3---setting-up-model-metrics" class="nav-link" data-scroll-target="#step-3---setting-up-model-metrics">Step 3 - Setting up Model Metrics</a></li>
  <li><a href="#step-4---registering-the-model-3" id="toc-step-4---registering-the-model-3" class="nav-link" data-scroll-target="#step-4---registering-the-model-3">Step 4 - Registering the Model</a></li>
  <li><a href="#step-5---modifying-the-condition-step-1" id="toc-step-5---modifying-the-condition-step-1" class="nav-link" data-scroll-target="#step-5---modifying-the-condition-step-1">Step 5 - Modifying the Condition Step</a></li>
  <li><a href="#step-6---creating-the-pipeline-1" id="toc-step-6---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-6---creating-the-pipeline-1">Step 6 - Creating the Pipeline</a></li>
  <li><a href="#step-7---checking-constraints-and-statistics" id="toc-step-7---checking-constraints-and-statistics" class="nav-link" data-scroll-target="#step-7---checking-constraints-and-statistics">Step 7 - Checking Constraints and Statistics</a></li>
  </ul></li>
  <li><a href="#session-17---model-quality-baseline" id="toc-session-17---model-quality-baseline" class="nav-link" data-scroll-target="#session-17---model-quality-baseline">Session 17 - Model Quality Baseline</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-baseline-location-1" id="toc-step-1---configuring-baseline-location-1" class="nav-link" data-scroll-target="#step-1---configuring-baseline-location-1">Step 1 - Configuring Baseline Location</a></li>
  <li><a href="#step-2---creating-the-model-2" id="toc-step-2---creating-the-model-2" class="nav-link" data-scroll-target="#step-2---creating-the-model-2">Step 2 - Creating the Model</a></li>
  <li><a href="#step-3---setting-up-the-transform-step" id="toc-step-3---setting-up-the-transform-step" class="nav-link" data-scroll-target="#step-3---setting-up-the-transform-step">Step 3 - Setting up the Transform Step</a></li>
  <li><a href="#step-4---generating-model-quality-baseline" id="toc-step-4---generating-model-quality-baseline" class="nav-link" data-scroll-target="#step-4---generating-model-quality-baseline">Step 4 - Generating Model Quality Baseline</a></li>
  <li><a href="#step-5---setting-up-model-metrics" id="toc-step-5---setting-up-model-metrics" class="nav-link" data-scroll-target="#step-5---setting-up-model-metrics">Step 5 - Setting up Model Metrics</a></li>
  <li><a href="#step-6---registering-the-model" id="toc-step-6---registering-the-model" class="nav-link" data-scroll-target="#step-6---registering-the-model">Step 6 - Registering the Model</a></li>
  <li><a href="#step-7---modifying-the-condition-step-1" id="toc-step-7---modifying-the-condition-step-1" class="nav-link" data-scroll-target="#step-7---modifying-the-condition-step-1">Step 7 - Modifying the Condition Step</a></li>
  <li><a href="#step-8---creating-the-pipeline-1" id="toc-step-8---creating-the-pipeline-1" class="nav-link" data-scroll-target="#step-8---creating-the-pipeline-1">Step 8 - Creating the Pipeline</a></li>
  <li><a href="#step-9---checking-constraints" id="toc-step-9---checking-constraints" class="nav-link" data-scroll-target="#step-9---checking-constraints">Step 9 - Checking Constraints</a></li>
  </ul></li>
  <li><a href="#session-18---data-monitoring" id="toc-session-18---data-monitoring" class="nav-link" data-scroll-target="#session-18---data-monitoring">Session 18 - Data Monitoring</a>
  <ul class="collapse">
  <li><a href="#step-1---deploying-the-model" id="toc-step-1---deploying-the-model" class="nav-link" data-scroll-target="#step-1---deploying-the-model">Step 1 - Deploying the Model</a></li>
  <li><a href="#step-2---generating-fake-traffic" id="toc-step-2---generating-fake-traffic" class="nav-link" data-scroll-target="#step-2---generating-fake-traffic">Step 2 - Generating Fake Traffic</a></li>
  <li><a href="#step-3---creating-custom-preprocessing-script" id="toc-step-3---creating-custom-preprocessing-script" class="nav-link" data-scroll-target="#step-3---creating-custom-preprocessing-script">Step 3 - Creating Custom Preprocessing Script</a></li>
  <li><a href="#step-4---uploading-preprocessing-script" id="toc-step-4---uploading-preprocessing-script" class="nav-link" data-scroll-target="#step-4---uploading-preprocessing-script">Step 4 - Uploading Preprocessing Script</a></li>
  <li><a href="#step-5---creating-monitoring-schedule" id="toc-step-5---creating-monitoring-schedule" class="nav-link" data-scroll-target="#step-5---creating-monitoring-schedule">Step 5 - Creating Monitoring Schedule</a></li>
  <li><a href="#step-6---checking-violations" id="toc-step-6---checking-violations" class="nav-link" data-scroll-target="#step-6---checking-violations">Step 6 - Checking Violations</a></li>
  <li><a href="#step-7---deleting-monitoring-schedule" id="toc-step-7---deleting-monitoring-schedule" class="nav-link" data-scroll-target="#step-7---deleting-monitoring-schedule">Step 7 - Deleting Monitoring Schedule</a></li>
  </ul></li>
  <li><a href="#session-19---model-monitoring" id="toc-session-19---model-monitoring" class="nav-link" data-scroll-target="#session-19---model-monitoring">Session 19 - Model Monitoring</a>
  <ul class="collapse">
  <li><a href="#step-1---configuring-ground-truth-location" id="toc-step-1---configuring-ground-truth-location" class="nav-link" data-scroll-target="#step-1---configuring-ground-truth-location">Step 1 - Configuring Ground Truth Location</a></li>
  <li><a href="#step-2---deploying-the-model" id="toc-step-2---deploying-the-model" class="nav-link" data-scroll-target="#step-2---deploying-the-model">Step 2 - Deploying the Model</a></li>
  <li><a href="#step-3---generating-fake-traffic" id="toc-step-3---generating-fake-traffic" class="nav-link" data-scroll-target="#step-3---generating-fake-traffic">Step 3 - Generating Fake Traffic</a></li>
  <li><a href="#step-4---generating-fake-labels" id="toc-step-4---generating-fake-labels" class="nav-link" data-scroll-target="#step-4---generating-fake-labels">Step 4 - Generating Fake Labels</a></li>
  <li><a href="#step-5---creating-monitoring-schedule-1" id="toc-step-5---creating-monitoring-schedule-1" class="nav-link" data-scroll-target="#step-5---creating-monitoring-schedule-1">Step 5 - Creating Monitoring Schedule</a></li>
  <li><a href="#step-6---checking-violations-1" id="toc-step-6---checking-violations-1" class="nav-link" data-scroll-target="#step-6---checking-violations-1">Step 6 - Checking Violations</a></li>
  <li><a href="#step-7---deleting-monitoring-schedule-1" id="toc-step-7---deleting-monitoring-schedule-1" class="nav-link" data-scroll-target="#step-7---deleting-monitoring-schedule-1">Step 7 - Deleting Monitoring Schedule</a></li>
  </ul></li>
  <li><a href="#session-20---shadow-deployments" id="toc-session-20---shadow-deployments" class="nav-link" data-scroll-target="#session-20---shadow-deployments">Session 20 - Shadow Deployments</a>
  <ul class="collapse">
  <li><a href="#step-1---getting-the-latest-models" id="toc-step-1---getting-the-latest-models" class="nav-link" data-scroll-target="#step-1---getting-the-latest-models">Step 1 - Getting The Latest Models</a></li>
  <li><a href="#step-2---creating-the-models" id="toc-step-2---creating-the-models" class="nav-link" data-scroll-target="#step-2---creating-the-models">Step 2 - Creating the Models</a></li>
  <li><a href="#step-3---creating-the-endpoint-configuration" id="toc-step-3---creating-the-endpoint-configuration" class="nav-link" data-scroll-target="#step-3---creating-the-endpoint-configuration">Step 3 - Creating the Endpoint Configuration</a></li>
  <li><a href="#step-4---creating-the-endpoint" id="toc-step-4---creating-the-endpoint" class="nav-link" data-scroll-target="#step-4---creating-the-endpoint">Step 4 - Creating the Endpoint</a></li>
  <li><a href="#step-5---generating-traffic" id="toc-step-5---generating-traffic" class="nav-link" data-scroll-target="#step-5---generating-traffic">Step 5 - Generating Traffic</a></li>
  <li><a href="#step-6---checking-captured-data" id="toc-step-6---checking-captured-data" class="nav-link" data-scroll-target="#step-6---checking-captured-data">Step 6 - Checking Captured Data</a></li>
  <li><a href="#step-7---deleting-the-endpoint" id="toc-step-7---deleting-the-endpoint" class="nav-link" data-scroll-target="#step-7---deleting-the-endpoint">Step 7 - Deleting the Endpoint</a></li>
  </ul></li>
  <li><a href="#running-the-pipeline" id="toc-running-the-pipeline" class="nav-link" data-scroll-target="#running-the-pipeline">Running the Pipeline</a></li>
  <li><a href="#deleting-the-endpoint" id="toc-deleting-the-endpoint" class="nav-link" data-scroll-target="#deleting-the-endpoint">Deleting the Endpoint</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/svpino/ml.school/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Building Machine Learning Systems That Don’t Suck</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This notebook creates a <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_building_pipeline.html">SageMaker Pipeline</a> to build an end-to-end Machine Learning system to solve the problem of classifying penguin species. With a SageMaker Pipeline, you can create, automate, and manage end-to-end Machine Learning workflows at scale.</p>
<p>You can find more information about Amazon SageMaker in the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html">Amazon SageMaker Developer Guide</a>. The <a href="https://aws.amazon.com/blogs/machine-learning/">AWS Machine Learning Blog</a> is an excellent source to stay up-to-date with SageMaker.</p>
<p>This example uses the <a href="https://www.kaggle.com/parulpandey/palmer-archipelago-antarctica-penguin-data">Penguins dataset</a>.</p>
<p><img src="images/penguins.png" alt="Penguins" width="800"></p>
<p>This notebook is part of the <a href="https://www.ml.school">Machine Learning School</a> program.</p>
<section id="session-1---introduction-and-initial-setup" class="level2">
<h2 class="anchored" data-anchor-id="session-1---introduction-and-initial-setup">Session 1 - Introduction and Initial Setup</h2>
<p>The machine learning system we’ll build during this program consists of four main pipelines: A <strong>training</strong> pipeline, an <strong>inference</strong> pipeline, a <strong>deployment</strong> pipeline, and a <strong>monitoring</strong> pipeline.</p>
<p>Here is an architectural diagram showing how the system is structured:</p>
<p><a href="images/diagram.png" target="_blank"> <img src="images/diagram.png" alt="SageMaker architectural diagram of the system" style="max-width: 740px;"></a></p>
<p>Throughout the sessions, we’ll build each of these pipelines. We’ll also build variations to show you different alternatives and best practices.</p>
<p>Let’s start by setting up the environment and preparing to run the notebook.</p>
<p>We can run this notebook in <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-local-mode.html">Local Mode</a> to test some of the system components in your local environment. Unfortunately, not every component is supported in Local Mode.</p>
<p>Setting the <code>LOCAL_MODE</code> variable to <code>True</code> will run every supported pipeline component locally. Setting the variable to <code>False</code> will run the pipeline in SageMaker.</p>
<div id="32c4d764" class="cell" data-tags="[]" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>LOCAL_MODE <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now load the environment variables we need to run the notebook.</p>
<div id="3164a3af" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> os.environ[<span class="st">"BUCKET"</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>role <span class="op">=</span> os.environ[<span class="st">"ROLE"</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>COMET_API_KEY <span class="op">=</span> os.environ.get(<span class="st">"COMET_API_KEY"</span>, <span class="va">None</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>COMET_PROJECT_NAME <span class="op">=</span> os.environ.get(<span class="st">"COMET_PROJECT_NAME"</span>, <span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you are running the pipeline in Local Mode on an ARM64 machine (for example, on Apple Silicon), you will need to use a custom Docker image to train and evaluate the model. Let’s create a variable indicating if we are running on an ARM64 machine.</p>
<div id="7bc40d28" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can retrieve the architecture of the local</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># computer using the `uname -m` command.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>architecture <span class="op">=</span> <span class="op">!</span>(uname <span class="op">-</span>m)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>IS_ARM64_ARCHITECTURE <span class="op">=</span> architecture[<span class="dv">0</span>] <span class="op">==</span> <span class="st">"arm64"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create a configuration dictionary with different settings depending on whether we are running the pipeline in Local Mode. We’ll use this dictionary to configure the pipeline components.</p>
<div id="3b3f17e5" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline_context <span class="im">import</span> LocalPipelineSession, PipelineSession</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>pipeline_session <span class="op">=</span> PipelineSession(default_bucket<span class="op">=</span>bucket) <span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> LOCAL_MODE:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"session"</span>: LocalPipelineSession(default_bucket<span class="op">=</span>bucket),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instance_type"</span>: <span class="st">"local"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to use a custom Docker image when we run the pipeline</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in Local Model on an ARM64 machine.</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image"</span>: (</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sagemaker-tensorflow-toolkit-local"</span> <span class="cf">if</span> IS_ARM64_ARCHITECTURE <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> {</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"session"</span>: pipeline_session,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instance_type"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image"</span>: <span class="va">None</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># These specific settings refer to the SageMaker</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow container we'll use.</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"framework_version"</span>] <span class="op">=</span> <span class="st">"2.12"</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"py_version"</span>] <span class="op">=</span> <span class="st">"py310"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now initialize a few variables that we’ll need throughout the notebook:</p>
<div id="942a01b5" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>S3_LOCATION <span class="op">=</span> <span class="ss">f"s3://</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">/penguins"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sagemaker_session <span class="op">=</span> sagemaker.session.Session()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sagemaker_client <span class="op">=</span> boto3.client(<span class="st">"sagemaker"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>iam_client <span class="op">=</span> boto3.client(<span class="st">"iam"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>region <span class="op">=</span> boto3.Session().region_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="session-2---exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="session-2---exploratory-data-analysis">Session 2 - Exploratory Data Analysis</h2>
<p>Let’s run Exploratory Data Analysis on the <a href="https://www.kaggle.com/parulpandey/palmer-archipelago-antarctica-penguin-data">Penguins dataset</a>. The goal of this session is to understand the data and the problem we are trying to solve.</p>
<p>Let’s load the Penguins dataset:</p>
<div id="f1cd2f0e-446d-48a9-a008-b4f1cc593bfc" class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>penguins <span class="op">=</span> pd.read_csv(DATA_FILEPATH)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>penguins.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.1</td>
<td>18.7</td>
<td>181.0</td>
<td>3750.0</td>
<td>MALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>39.5</td>
<td>17.4</td>
<td>186.0</td>
<td>3800.0</td>
<td>FEMALE</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>40.3</td>
<td>18.0</td>
<td>195.0</td>
<td>3250.0</td>
<td>FEMALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Adelie</td>
<td>Torgersen</td>
<td>36.7</td>
<td>19.3</td>
<td>193.0</td>
<td>3450.0</td>
<td>FEMALE</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We can see the dataset contains the following columns:</p>
<ol type="1">
<li><code>species</code>: The species of a penguin. This is the column we want to predict.</li>
<li><code>island</code>: The island where the penguin was found</li>
<li><code>culmen_length_mm</code>: The length of the penguin’s culmen (bill) in millimeters</li>
<li><code>culmen_depth_mm</code>: The depth of the penguin’s culmen in millimeters</li>
<li><code>flipper_length_mm</code>: The length of the penguin’s flipper in millimeters</li>
<li><code>body_mass_g</code>: The body mass of the penguin in grams</li>
<li><code>sex</code>: The sex of the penguin</li>
</ol>
<p>If you are curious, here is the description of a penguin’s culmen:</p>
<p><img src="images/culmen.jpeg" alt="Culmen" width="600"></p>
<p>Now, let’s get the summary statistics for the features in our dataset.</p>
<div id="f2107c25-e730-4e22-a1b8-5bda53e61124" class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>penguins.describe(include<span class="op">=</span><span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">species</th>
<th data-quarto-table-cell-role="th">island</th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
<th data-quarto-table-cell-role="th">sex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>344</td>
<td>344</td>
<td>342.000000</td>
<td>342.000000</td>
<td>342.000000</td>
<td>342.000000</td>
<td>334</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>3</td>
<td>3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>Adelie</td>
<td>Biscoe</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>MALE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>152</td>
<td>168</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>168</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>NaN</td>
<td>NaN</td>
<td>43.921930</td>
<td>17.151170</td>
<td>200.915205</td>
<td>4201.754386</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>NaN</td>
<td>NaN</td>
<td>5.459584</td>
<td>1.974793</td>
<td>14.061714</td>
<td>801.954536</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>NaN</td>
<td>NaN</td>
<td>32.100000</td>
<td>13.100000</td>
<td>172.000000</td>
<td>2700.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>NaN</td>
<td>NaN</td>
<td>39.225000</td>
<td>15.600000</td>
<td>190.000000</td>
<td>3550.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>NaN</td>
<td>NaN</td>
<td>44.450000</td>
<td>17.300000</td>
<td>197.000000</td>
<td>4050.000000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>NaN</td>
<td>NaN</td>
<td>48.500000</td>
<td>18.700000</td>
<td>213.000000</td>
<td>4750.000000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>NaN</td>
<td>NaN</td>
<td>59.600000</td>
<td>21.500000</td>
<td>231.000000</td>
<td>6300.000000</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Let’s now display the distribution of values for the three categorical columns in our data:</p>
<div id="1242122a-726e-4c37-a718-dd8e873d1612" class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>species_distribution <span class="op">=</span> penguins[<span class="st">"species"</span>].value_counts()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>island_distribution <span class="op">=</span> penguins[<span class="st">"island"</span>].value_counts()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sex_distribution <span class="op">=</span> penguins[<span class="st">"sex"</span>].value_counts()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(species_distribution, end<span class="op">=</span><span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(island_distribution, end<span class="op">=</span><span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sex_distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>species
Adelie       152
Gentoo       124
Chinstrap     68
Name: count, dtype: int64

island
Biscoe       168
Dream        124
Torgersen     52
Name: count, dtype: int64

sex
MALE      168
FEMALE    165
.           1
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>The distribution of the categories in our data are:</p>
<ul>
<li><code>species</code>: There are 3 species of penguins in the dataset: Adelie (<code>152</code>), Gentoo (<code>124</code>), and Chinstrap (<code>68</code>).</li>
<li><code>island</code>: Penguins are from 3 islands: Biscoe (<code>168</code>), Dream (<code>124</code>), and Torgersen (<code>52</code>).</li>
<li><code>sex</code>: We have <code>168</code> male penguins, <code>165</code> female penguins, and <code>1</code> penguin with an ambiguous gender (<code>.</code>).</li>
</ul>
<p>Let’s replace the ambiguous value in the <code>sex</code> column with a <code>null</code> value:</p>
<div id="cf1cf582-8831-4f83-bb17-2175afb193e8" class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>penguins[<span class="st">"sex"</span>] <span class="op">=</span> penguins[<span class="st">"sex"</span>].replace(<span class="st">"."</span>, np.nan)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's display the new distribution of the column:</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>sex_distribution <span class="op">=</span> penguins[<span class="st">"sex"</span>].value_counts()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sex_distribution</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>sex
MALE      168
FEMALE    165
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>Next, let’s check for any missing values in the dataset.</p>
<div id="cc42cb08-275c-4b05-9d2b-77052da2f336" class="cell" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>penguins.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>species               0
island                0
culmen_length_mm      2
culmen_depth_mm       2
flipper_length_mm     2
body_mass_g           2
sex                  11
dtype: int64</code></pre>
</div>
</div>
<p>Let’s get rid of the missing values. For now, we are going to replace the missing values with the most frequent value in the column. Later, we’ll use a different strategy to replace missing numeric values.</p>
<div id="3c57d55d-afd6-467a-a7a8-ff04132770ed" class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>penguins.iloc[:, :] <span class="op">=</span> imputer.fit_transform(penguins)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's display again the number of missing values:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>penguins.isna().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>species              0
island               0
culmen_length_mm     0
culmen_depth_mm      0
flipper_length_mm    0
body_mass_g          0
sex                  0
dtype: int64</code></pre>
</div>
</div>
<p>Let’s visualize the distribution of categorical features.</p>
<div id="2852c740" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">10</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].bar(species_distribution.index, species_distribution.values)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Distribution of Species"</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].bar(island_distribution.index, island_distribution.values)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"Distribution of Island"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].bar(sex_distribution.index, sex_distribution.values)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_title(<span class="st">"Distribution of Sex"</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cohort_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s visualize the distribution of numerical columns.</p>
<div id="707cc972" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].hist(penguins[<span class="st">"culmen_length_mm"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">"Distribution of culmen_length_mm"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].hist(penguins[<span class="st">"culmen_depth_mm"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">"Distribution of culmen_depth_mm"</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].hist(penguins[<span class="st">"flipper_length_mm"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">"Distribution of flipper_length_mm"</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].hist(penguins[<span class="st">"body_mass_g"</span>], bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">"Distribution of body_mass_g"</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cohort_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s display the covariance matrix of the dataset. The “covariance” measures how changes in one variable are associated with changes in a second variable. In other words, the covariance measures the degree to which two variables are linearly associated.</p>
<div id="3daf3ba1-d218-4ad4-b862-af679b91273f" class="cell" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>penguins.cov(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">culmen_length_mm</td>
<td>29.679415</td>
<td>-2.516984</td>
<td>50.260588</td>
<td>2596.971151</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">culmen_depth_mm</td>
<td>-2.516984</td>
<td>3.877201</td>
<td>-16.108849</td>
<td>-742.660180</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flipper_length_mm</td>
<td>50.260588</td>
<td>-16.108849</td>
<td>197.269501</td>
<td>9792.552037</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">body_mass_g</td>
<td>2596.971151</td>
<td>-742.660180</td>
<td>9792.552037</td>
<td>640316.716388</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Here are three examples of what we get from interpreting the covariance matrix below:</p>
<ol type="1">
<li>The positive covariance of 50.26 between culmen length and flippler length suggests that larger values of culmen length are associated with larger values of flipper length. As one increases, generally so does the other.</li>
<li>The positive covariance of 2596.97 between culmen length and body mass suggests that heavier penguins generally have longer culmens. There is a tendency for these two variables to increase together.</li>
<li>The negative covariance of -742.66 between culmen depth and body mass suggests a general tendency that penguins with deeper culmens weigh less.</li>
</ol>
<p>Let’s now display the correlation matrix. “Correlation” measures both the strength and direction of the linear relationship between two variables:</p>
<div id="1d793e09-2cb9-47ff-a0e6-199a0f4fc1b3" class="cell" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>penguins.corr(numeric_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">culmen_length_mm</th>
<th data-quarto-table-cell-role="th">culmen_depth_mm</th>
<th data-quarto-table-cell-role="th">flipper_length_mm</th>
<th data-quarto-table-cell-role="th">body_mass_g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">culmen_length_mm</td>
<td>1.000000</td>
<td>-0.234635</td>
<td>0.656856</td>
<td>0.595720</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">culmen_depth_mm</td>
<td>-0.234635</td>
<td>1.000000</td>
<td>-0.582472</td>
<td>-0.471339</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">flipper_length_mm</td>
<td>0.656856</td>
<td>-0.582472</td>
<td>1.000000</td>
<td>0.871302</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">body_mass_g</td>
<td>0.595720</td>
<td>-0.471339</td>
<td>0.871302</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Here are three examples of what we get from interpreting the correlation matrix below:</p>
<ol type="1">
<li>Penguins that weight more tend to have longer flippers.</li>
<li>Penguins with a shallower culmen tend to have longer flippers.</li>
<li>Penguins with longer culmens tend to have longer flippers.</li>
</ol>
<p>Let’s display the distribution of species by island:</p>
<div id="1258c99d" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>unique_species <span class="op">=</span> penguins[<span class="st">"species"</span>].unique()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> species <span class="kw">in</span> unique_species:</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> penguins[penguins[<span class="st">"species"</span>] <span class="op">==</span> species]</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    ax.hist(data[<span class="st">"island"</span>], bins<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>species)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Island"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distribution of Species by Island"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cohort_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s display the distribution of species by sex.</p>
<div id="45b0a87f-028d-477f-9b65-199728c0b7ee" class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> species <span class="kw">in</span> unique_species:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> penguins[penguins[<span class="st">"species"</span>] <span class="op">==</span> species]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    ax.hist(data[<span class="st">"sex"</span>], bins<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span>species)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Sex"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Count"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Distribution of Species by Sex"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="cohort_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="session-3---splitting-and-transforming-the-data" class="level2">
<h2 class="anchored" data-anchor-id="session-3---splitting-and-transforming-the-data">Session 3 - Splitting and Transforming the Data</h2>
<p>In this session we’ll build a simple <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with one step to split and transform the data:</p>
<p><a href="images/processing-step.png" target="_blank"> <img src="images/processing-step.png" alt="High-level overview of the Preprocessing Step" style="max-width: 740px;"></a></p>
<p>We’ll use a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html">Scikit-Learn Pipeline</a> for the transformations, and a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> with a <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html#scikit-learn-processor">SKLearnProcessor</a> to execute a preprocessing script. Check the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipelines Overview</a> for an introduction to the fundamental components of a SageMaker Pipeline.</p>
<section id="step-1---creating-the-preprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-preprocessing-script">Step 1 - Creating the Preprocessing Script</h3>
<p>The first step we need in the pipeline is a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to run a script that will split and transform the data.</p>
<p>This Processing Step will create a SageMaker Processing Job in the background, run the script, and upload the output to S3. You can use Processing Jobs to perform data preprocessing, post-processing, feature engineering, data validation, and model evaluation. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>We will store the script in a folder called <code>processing</code> and add it to the system path so we can later import it as a module.</p>
<div id="78fe069e" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"processing"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the script:</p>
<div id="fb6ba7c0-1bd6-4fe5-8b7f-f6cbdfd3846c" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="20">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>script.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="im">import</span> os</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="im">import</span> tarfile</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="im">import</span> tempfile</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="im">import</span> joblib</span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer, make_column_selector</span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline</span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, OrdinalEncoder, StandardScaler</span>
<span id="cb23-14"><a href="#cb23-14"></a></span>
<span id="cb23-15"><a href="#cb23-15"></a></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="kw">def</span> preprocess(base_directory):</span>
<span id="cb23-17"><a href="#cb23-17"></a>    <span class="co">"""Load the supplied data, split it and transform it."""</span></span>
<span id="cb23-18"><a href="#cb23-18"></a>    df <span class="op">=</span> _read_data_from_input_csv_files(base_directory)</span>
<span id="cb23-19"><a href="#cb23-19"></a></span>
<span id="cb23-20"><a href="#cb23-20"></a>    target_transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb23-21"><a href="#cb23-21"></a>        transformers<span class="op">=</span>[(<span class="st">"species"</span>, OrdinalEncoder(), [<span class="dv">0</span>])],</span>
<span id="cb23-22"><a href="#cb23-22"></a>    )</span>
<span id="cb23-23"><a href="#cb23-23"></a></span>
<span id="cb23-24"><a href="#cb23-24"></a>    numeric_transformer <span class="op">=</span> make_pipeline(</span>
<span id="cb23-25"><a href="#cb23-25"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"mean"</span>),</span>
<span id="cb23-26"><a href="#cb23-26"></a>        StandardScaler(),</span>
<span id="cb23-27"><a href="#cb23-27"></a>    )</span>
<span id="cb23-28"><a href="#cb23-28"></a></span>
<span id="cb23-29"><a href="#cb23-29"></a>    categorical_transformer <span class="op">=</span> make_pipeline(</span>
<span id="cb23-30"><a href="#cb23-30"></a>        SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>),</span>
<span id="cb23-31"><a href="#cb23-31"></a>        OneHotEncoder(),</span>
<span id="cb23-32"><a href="#cb23-32"></a>    )</span>
<span id="cb23-33"><a href="#cb23-33"></a></span>
<span id="cb23-34"><a href="#cb23-34"></a>    features_transformer <span class="op">=</span> ColumnTransformer(</span>
<span id="cb23-35"><a href="#cb23-35"></a>        transformers<span class="op">=</span>[</span>
<span id="cb23-36"><a href="#cb23-36"></a>            (</span>
<span id="cb23-37"><a href="#cb23-37"></a>                <span class="st">"numeric"</span>,</span>
<span id="cb23-38"><a href="#cb23-38"></a>                numeric_transformer,</span>
<span id="cb23-39"><a href="#cb23-39"></a>                make_column_selector(dtype_exclude<span class="op">=</span><span class="st">"object"</span>),</span>
<span id="cb23-40"><a href="#cb23-40"></a>            ),</span>
<span id="cb23-41"><a href="#cb23-41"></a>            (<span class="st">"categorical"</span>, categorical_transformer, [<span class="st">"island"</span>]),</span>
<span id="cb23-42"><a href="#cb23-42"></a>        ],</span>
<span id="cb23-43"><a href="#cb23-43"></a>    )</span>
<span id="cb23-44"><a href="#cb23-44"></a></span>
<span id="cb23-45"><a href="#cb23-45"></a>    df_train, df_validation, df_test <span class="op">=</span> _split_data(df)</span>
<span id="cb23-46"><a href="#cb23-46"></a></span>
<span id="cb23-47"><a href="#cb23-47"></a>    _save_train_baseline(base_directory, df_train)</span>
<span id="cb23-48"><a href="#cb23-48"></a>    _save_test_baseline(base_directory, df_test)</span>
<span id="cb23-49"><a href="#cb23-49"></a></span>
<span id="cb23-50"><a href="#cb23-50"></a>    y_train <span class="op">=</span> target_transformer.fit_transform(</span>
<span id="cb23-51"><a href="#cb23-51"></a>        np.array(df_train.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb23-52"><a href="#cb23-52"></a>    )</span>
<span id="cb23-53"><a href="#cb23-53"></a>    y_validation <span class="op">=</span> target_transformer.transform(</span>
<span id="cb23-54"><a href="#cb23-54"></a>        np.array(df_validation.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb23-55"><a href="#cb23-55"></a>    )</span>
<span id="cb23-56"><a href="#cb23-56"></a>    y_test <span class="op">=</span> target_transformer.transform(</span>
<span id="cb23-57"><a href="#cb23-57"></a>        np.array(df_test.species.values).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb23-58"><a href="#cb23-58"></a>    )</span>
<span id="cb23-59"><a href="#cb23-59"></a></span>
<span id="cb23-60"><a href="#cb23-60"></a>    df_train <span class="op">=</span> df_train.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-61"><a href="#cb23-61"></a>    df_validation <span class="op">=</span> df_validation.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-62"><a href="#cb23-62"></a>    df_test <span class="op">=</span> df_test.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-63"><a href="#cb23-63"></a></span>
<span id="cb23-64"><a href="#cb23-64"></a>    X_train <span class="op">=</span> features_transformer.fit_transform(df_train)  <span class="co"># noqa: N806</span></span>
<span id="cb23-65"><a href="#cb23-65"></a>    X_validation <span class="op">=</span> features_transformer.transform(df_validation)  <span class="co"># noqa: N806</span></span>
<span id="cb23-66"><a href="#cb23-66"></a>    X_test <span class="op">=</span> features_transformer.transform(df_test)  <span class="co"># noqa: N806</span></span>
<span id="cb23-67"><a href="#cb23-67"></a></span>
<span id="cb23-68"><a href="#cb23-68"></a>    _save_splits(</span>
<span id="cb23-69"><a href="#cb23-69"></a>        base_directory,</span>
<span id="cb23-70"><a href="#cb23-70"></a>        X_train,</span>
<span id="cb23-71"><a href="#cb23-71"></a>        y_train,</span>
<span id="cb23-72"><a href="#cb23-72"></a>        X_validation,</span>
<span id="cb23-73"><a href="#cb23-73"></a>        y_validation,</span>
<span id="cb23-74"><a href="#cb23-74"></a>        X_test,</span>
<span id="cb23-75"><a href="#cb23-75"></a>        y_test,</span>
<span id="cb23-76"><a href="#cb23-76"></a>    )</span>
<span id="cb23-77"><a href="#cb23-77"></a>    _save_model(base_directory, target_transformer, features_transformer)</span>
<span id="cb23-78"><a href="#cb23-78"></a></span>
<span id="cb23-79"><a href="#cb23-79"></a></span>
<span id="cb23-80"><a href="#cb23-80"></a><span class="kw">def</span> _read_data_from_input_csv_files(base_directory):</span>
<span id="cb23-81"><a href="#cb23-81"></a>    <span class="co">"""Read the data from the input CSV files.</span></span>
<span id="cb23-82"><a href="#cb23-82"></a></span>
<span id="cb23-83"><a href="#cb23-83"></a><span class="co">    This function reads every CSV file available and</span></span>
<span id="cb23-84"><a href="#cb23-84"></a><span class="co">    concatenates them into a single dataframe.</span></span>
<span id="cb23-85"><a href="#cb23-85"></a><span class="co">    """</span></span>
<span id="cb23-86"><a href="#cb23-86"></a>    input_directory <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb23-87"><a href="#cb23-87"></a>    files <span class="op">=</span> <span class="bu">list</span>(input_directory.glob(<span class="st">"*.csv"</span>))</span>
<span id="cb23-88"><a href="#cb23-88"></a></span>
<span id="cb23-89"><a href="#cb23-89"></a>    <span class="cf">if</span> <span class="bu">len</span>(files) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-90"><a href="#cb23-90"></a>        message <span class="op">=</span> <span class="ss">f"The are no CSV files in </span><span class="sc">{</span>input_directory<span class="sc">.</span>as_posix()<span class="sc">}</span><span class="ss">/"</span></span>
<span id="cb23-91"><a href="#cb23-91"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(message)</span>
<span id="cb23-92"><a href="#cb23-92"></a></span>
<span id="cb23-93"><a href="#cb23-93"></a>    raw_data <span class="op">=</span> [pd.read_csv(<span class="bu">file</span>) <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files]</span>
<span id="cb23-94"><a href="#cb23-94"></a>    df <span class="op">=</span> pd.concat(raw_data)</span>
<span id="cb23-95"><a href="#cb23-95"></a></span>
<span id="cb23-96"><a href="#cb23-96"></a>    <span class="co"># Shuffle the data</span></span>
<span id="cb23-97"><a href="#cb23-97"></a>    <span class="cf">return</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb23-98"><a href="#cb23-98"></a></span>
<span id="cb23-99"><a href="#cb23-99"></a></span>
<span id="cb23-100"><a href="#cb23-100"></a><span class="kw">def</span> _split_data(df):</span>
<span id="cb23-101"><a href="#cb23-101"></a>    <span class="co">"""Split the data into train, validation, and test."""</span></span>
<span id="cb23-102"><a href="#cb23-102"></a>    df_train, temp <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb23-103"><a href="#cb23-103"></a>    df_validation, df_test <span class="op">=</span> train_test_split(temp, test_size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-104"><a href="#cb23-104"></a></span>
<span id="cb23-105"><a href="#cb23-105"></a>    <span class="cf">return</span> df_train, df_validation, df_test</span>
<span id="cb23-106"><a href="#cb23-106"></a></span>
<span id="cb23-107"><a href="#cb23-107"></a></span>
<span id="cb23-108"><a href="#cb23-108"></a><span class="kw">def</span> _save_train_baseline(base_directory, df_train):</span>
<span id="cb23-109"><a href="#cb23-109"></a>    <span class="co">"""Save the untransformed training data to disk.</span></span>
<span id="cb23-110"><a href="#cb23-110"></a></span>
<span id="cb23-111"><a href="#cb23-111"></a><span class="co">    We will need the training data to compute a baseline to</span></span>
<span id="cb23-112"><a href="#cb23-112"></a><span class="co">    determine the quality of the data that the model receives</span></span>
<span id="cb23-113"><a href="#cb23-113"></a><span class="co">    when deployed.</span></span>
<span id="cb23-114"><a href="#cb23-114"></a><span class="co">    """</span></span>
<span id="cb23-115"><a href="#cb23-115"></a>    baseline_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"train-baseline"</span></span>
<span id="cb23-116"><a href="#cb23-116"></a>    baseline_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-117"><a href="#cb23-117"></a></span>
<span id="cb23-118"><a href="#cb23-118"></a>    df <span class="op">=</span> df_train.copy().dropna()</span>
<span id="cb23-119"><a href="#cb23-119"></a></span>
<span id="cb23-120"><a href="#cb23-120"></a>    <span class="co"># To compute the data quality baseline, we don't need the</span></span>
<span id="cb23-121"><a href="#cb23-121"></a>    <span class="co"># target variable, so we'll drop it from the dataframe.</span></span>
<span id="cb23-122"><a href="#cb23-122"></a>    df <span class="op">=</span> df.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-123"><a href="#cb23-123"></a></span>
<span id="cb23-124"><a href="#cb23-124"></a>    df.to_csv(baseline_path <span class="op">/</span> <span class="st">"train-baseline.csv"</span>, header<span class="op">=</span><span class="va">True</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-125"><a href="#cb23-125"></a></span>
<span id="cb23-126"><a href="#cb23-126"></a></span>
<span id="cb23-127"><a href="#cb23-127"></a><span class="kw">def</span> _save_test_baseline(base_directory, df_test):</span>
<span id="cb23-128"><a href="#cb23-128"></a>    <span class="co">"""Save the untransformed test data to disk.</span></span>
<span id="cb23-129"><a href="#cb23-129"></a></span>
<span id="cb23-130"><a href="#cb23-130"></a><span class="co">    We will need the test data to compute a baseline to</span></span>
<span id="cb23-131"><a href="#cb23-131"></a><span class="co">    determine the quality of the model predictions when deployed.</span></span>
<span id="cb23-132"><a href="#cb23-132"></a><span class="co">    """</span></span>
<span id="cb23-133"><a href="#cb23-133"></a>    baseline_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"test-baseline"</span></span>
<span id="cb23-134"><a href="#cb23-134"></a>    baseline_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-135"><a href="#cb23-135"></a></span>
<span id="cb23-136"><a href="#cb23-136"></a>    df <span class="op">=</span> df_test.copy().dropna()</span>
<span id="cb23-137"><a href="#cb23-137"></a></span>
<span id="cb23-138"><a href="#cb23-138"></a>    <span class="co"># We'll use the test baseline to generate predictions later,</span></span>
<span id="cb23-139"><a href="#cb23-139"></a>    <span class="co"># and we can't have a header line because the model won't be</span></span>
<span id="cb23-140"><a href="#cb23-140"></a>    <span class="co"># able to make a prediction for it.</span></span>
<span id="cb23-141"><a href="#cb23-141"></a>    df.to_csv(baseline_path <span class="op">/</span> <span class="st">"test-baseline.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-142"><a href="#cb23-142"></a></span>
<span id="cb23-143"><a href="#cb23-143"></a></span>
<span id="cb23-144"><a href="#cb23-144"></a><span class="kw">def</span> _save_splits(</span>
<span id="cb23-145"><a href="#cb23-145"></a>    base_directory,</span>
<span id="cb23-146"><a href="#cb23-146"></a>    X_train,  <span class="co"># noqa: N803</span></span>
<span id="cb23-147"><a href="#cb23-147"></a>    y_train,</span>
<span id="cb23-148"><a href="#cb23-148"></a>    X_validation,  <span class="co"># noqa: N803</span></span>
<span id="cb23-149"><a href="#cb23-149"></a>    y_validation,</span>
<span id="cb23-150"><a href="#cb23-150"></a>    X_test,  <span class="co"># noqa: N803</span></span>
<span id="cb23-151"><a href="#cb23-151"></a>    y_test,</span>
<span id="cb23-152"><a href="#cb23-152"></a>):</span>
<span id="cb23-153"><a href="#cb23-153"></a>    <span class="co">"""Save data splits to disk.</span></span>
<span id="cb23-154"><a href="#cb23-154"></a></span>
<span id="cb23-155"><a href="#cb23-155"></a><span class="co">    This function concatenates the transformed features</span></span>
<span id="cb23-156"><a href="#cb23-156"></a><span class="co">    and the target variable, and saves each one of the split</span></span>
<span id="cb23-157"><a href="#cb23-157"></a><span class="co">    sets to disk.</span></span>
<span id="cb23-158"><a href="#cb23-158"></a><span class="co">    """</span></span>
<span id="cb23-159"><a href="#cb23-159"></a>    train <span class="op">=</span> np.concatenate((X_train, y_train), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-160"><a href="#cb23-160"></a>    validation <span class="op">=</span> np.concatenate((X_validation, y_validation), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-161"><a href="#cb23-161"></a>    test <span class="op">=</span> np.concatenate((X_test, y_test), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-162"><a href="#cb23-162"></a></span>
<span id="cb23-163"><a href="#cb23-163"></a>    train_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"train"</span></span>
<span id="cb23-164"><a href="#cb23-164"></a>    validation_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"validation"</span></span>
<span id="cb23-165"><a href="#cb23-165"></a>    test_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"test"</span></span>
<span id="cb23-166"><a href="#cb23-166"></a></span>
<span id="cb23-167"><a href="#cb23-167"></a>    train_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-168"><a href="#cb23-168"></a>    validation_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-169"><a href="#cb23-169"></a>    test_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-170"><a href="#cb23-170"></a></span>
<span id="cb23-171"><a href="#cb23-171"></a>    pd.DataFrame(train).to_csv(train_path <span class="op">/</span> <span class="st">"train.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-172"><a href="#cb23-172"></a>    pd.DataFrame(validation).to_csv(</span>
<span id="cb23-173"><a href="#cb23-173"></a>        validation_path <span class="op">/</span> <span class="st">"validation.csv"</span>,</span>
<span id="cb23-174"><a href="#cb23-174"></a>        header<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb23-175"><a href="#cb23-175"></a>        index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb23-176"><a href="#cb23-176"></a>    )</span>
<span id="cb23-177"><a href="#cb23-177"></a>    pd.DataFrame(test).to_csv(test_path <span class="op">/</span> <span class="st">"test.csv"</span>, header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-178"><a href="#cb23-178"></a></span>
<span id="cb23-179"><a href="#cb23-179"></a></span>
<span id="cb23-180"><a href="#cb23-180"></a><span class="kw">def</span> _save_model(base_directory, target_transformer, features_transformer):</span>
<span id="cb23-181"><a href="#cb23-181"></a>    <span class="co">"""Save the Scikit-Learn transformation pipelines.</span></span>
<span id="cb23-182"><a href="#cb23-182"></a></span>
<span id="cb23-183"><a href="#cb23-183"></a><span class="co">    This function creates a model.tar.gz file that</span></span>
<span id="cb23-184"><a href="#cb23-184"></a><span class="co">    contains the two transformation pipelines we built</span></span>
<span id="cb23-185"><a href="#cb23-185"></a><span class="co">    to transform the data.</span></span>
<span id="cb23-186"><a href="#cb23-186"></a><span class="co">    """</span></span>
<span id="cb23-187"><a href="#cb23-187"></a>    <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> directory:</span>
<span id="cb23-188"><a href="#cb23-188"></a>        joblib.dump(target_transformer, Path(directory) <span class="op">/</span> <span class="st">"target.joblib"</span>)</span>
<span id="cb23-189"><a href="#cb23-189"></a>        joblib.dump(features_transformer, Path(directory) <span class="op">/</span> <span class="st">"features.joblib"</span>)</span>
<span id="cb23-190"><a href="#cb23-190"></a></span>
<span id="cb23-191"><a href="#cb23-191"></a>        model_path <span class="op">=</span> Path(base_directory) <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb23-192"><a href="#cb23-192"></a>        model_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-193"><a href="#cb23-193"></a></span>
<span id="cb23-194"><a href="#cb23-194"></a>        <span class="cf">with</span> tarfile.<span class="bu">open</span>(<span class="ss">f"</span><span class="sc">{</span>(model_path <span class="op">/</span> <span class="st">'model.tar.gz'</span>)<span class="sc">.</span>as_posix()<span class="sc">}</span><span class="ss">"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb23-195"><a href="#cb23-195"></a>            tar.add(Path(directory) <span class="op">/</span> <span class="st">"target.joblib"</span>, arcname<span class="op">=</span><span class="st">"target.joblib"</span>)</span>
<span id="cb23-196"><a href="#cb23-196"></a>            tar.add(</span>
<span id="cb23-197"><a href="#cb23-197"></a>                Path(directory) <span class="op">/</span> <span class="st">"features.joblib"</span>, arcname<span class="op">=</span><span class="st">"features.joblib"</span>,</span>
<span id="cb23-198"><a href="#cb23-198"></a>            )</span>
<span id="cb23-199"><a href="#cb23-199"></a></span>
<span id="cb23-200"><a href="#cb23-200"></a></span>
<span id="cb23-201"><a href="#cb23-201"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb23-202"><a href="#cb23-202"></a>    preprocess(base_directory<span class="op">=</span><span class="st">"/opt/ml/processing"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div id="d1f122a4-acff-4687-91b9-bfef13567d88" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> processing.script <span class="im">import</span> preprocess</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_generates_data_splits(directory):</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    output_directories <span class="op">=</span> os.listdir(directory)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"train"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"validation"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"test"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_generates_baselines(directory):</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    output_directories <span class="op">=</span> os.listdir(directory)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"train-baseline"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"test-baseline"</span> <span class="kw">in</span> output_directories</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_preprocess_creates_two_models(directory):</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    model_path <span class="op">=</span> directory <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    tar <span class="op">=</span> tarfile.<span class="bu">open</span>(model_path <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"r:gz"</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"features.joblib"</span> <span class="kw">in</span> tar.getnames()</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"target.joblib"</span> <span class="kw">in</span> tar.getnames()</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_splits_are_transformed(directory):</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"train"</span> <span class="op">/</span> <span class="st">"train.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    validation <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"validation"</span> <span class="op">/</span> <span class="st">"validation.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    test <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"test"</span> <span class="op">/</span> <span class="st">"test.csv"</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After transforming the data, the number of features should be 7:</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 3 - island (one-hot encoded)</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - culmen_length_mm = 1</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - culmen_depth_mm</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - flipper_length_mm</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># * 1 - body_mass_g</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    number_of_features <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The transformed splits should have an additional column for the target</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variable.</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> train.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> validation.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> test.shape[<span class="dv">1</span>] <span class="op">==</span> number_of_features <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_baseline_is_not_transformed(directory):</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>        directory <span class="op">/</span> <span class="st">"train-baseline"</span> <span class="op">/</span> <span class="st">"train-baseline.csv"</span>,</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>        header<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    island <span class="op">=</span> baseline.iloc[:, <span class="dv">0</span>].unique()</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Biscoe"</span> <span class="kw">in</span> island</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Torgersen"</span> <span class="kw">in</span> island</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Dream"</span> <span class="kw">in</span> island</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_test_baseline_is_not_transformed(directory):</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>        directory <span class="op">/</span> <span class="st">"test-baseline"</span> <span class="op">/</span> <span class="st">"test-baseline.csv"</span>, header<span class="op">=</span><span class="va">None</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>    island <span class="op">=</span> baseline.iloc[:, <span class="dv">1</span>].unique()</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Biscoe"</span> <span class="kw">in</span> island</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Torgersen"</span> <span class="kw">in</span> island</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"Dream"</span> <span class="kw">in</span> island</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_baseline_includes_header(directory):</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"train-baseline"</span> <span class="op">/</span> <span class="st">"train-baseline.csv"</span>)</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> baseline.columns[<span class="dv">0</span>] <span class="op">==</span> <span class="st">"island"</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_test_baseline_does_not_include_header(directory):</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> pd.read_csv(directory <span class="op">/</span> <span class="st">"test-baseline"</span> <span class="op">/</span> <span class="st">"test-baseline.csv"</span>)</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> baseline.columns[<span class="dv">0</span>] <span class="op">!=</span> <span class="st">"island"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---caching-configuration" class="level3">
<h3 class="anchored" data-anchor-id="step-2---caching-configuration">Step 2 - Caching Configuration</h3>
<p>Several SageMaker Pipeline steps support caching. When a step runs, and dependending on the configured caching policy, SageMaker will try to reuse the result of a previous successful run of the same step. You can find more information about this topic in <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-caching.html">Caching Pipeline Steps</a>.</p>
<p>Let’s define a caching policy that we’ll reuse on every step:</p>
<div id="d88e9ccf" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> CacheConfig</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>cache_config <span class="op">=</span> CacheConfig(enable_caching<span class="op">=</span><span class="va">True</span>, expire_after<span class="op">=</span><span class="st">"15d"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---pipeline-configuration" class="level3">
<h3 class="anchored" data-anchor-id="step-3---pipeline-configuration">Step 3 - Pipeline Configuration</h3>
<p>We can parameterize a SageMaker Pipeline to make it more flexible. In this case, we’ll use a parameter to pass the location of the dataset we want to process. We can execute the pipeline with different datasets by changing the value of this parameter. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-parameters.html">Pipeline Parameters</a> for more information.</p>
<div id="331fe373" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> ParameterString</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline_definition_config <span class="im">import</span> PipelineDefinitionConfig</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>pipeline_definition_config <span class="op">=</span> PipelineDefinitionConfig(use_custom_job_prefix<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>dataset_location <span class="op">=</span> ParameterString(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"dataset_location"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/data"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---setting-up-the-processing-step" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-the-processing-step">Step 4 - Setting up the Processing Step</h3>
<p>Let’s now define the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">ProcessingStep</a> that we’ll use in the pipeline to run the script that will split and transform the data.</p>
<p>A processor gives the Processing Step information about the hardware and software that SageMaker should use to launch a Processing Job. To run the script we created, we need access to Scikit-Learn, so we can use the <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/sklearn/sagemaker.sklearn.html#scikit-learn-processor">SKLearnProcessor</a> processor that comes out-of-the-box with the SageMaker’s Python SDK.</p>
<p>SageMaker manages the infrastructure of a Processing Job. It provisions resources for the duration of the job, and cleans up when it completes. The Processing Container image that SageMaker uses to run a Processing Job can either be a SageMaker built-in image or a custom image:</p>
<p><a href="images/processing-job.png" target="_blank"> <img src="images/processing-job.png" alt="High-level overview of a SageMaker Processing Job" style="max-width: 740px;"></a></p>
<p>The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job-frameworks.html">Data Processing with Framework Processors</a> page discusses other built-in processors you can use. The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-algo-docker-registry-paths.html">Docker Registry Paths and Example Code</a> page contains information about the available framework versions for each region.</p>
<div id="3aa4471a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.processing <span class="im">import</span> SKLearnProcessor</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> SKLearnProcessor(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"preprocess-data"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># By default, a new account doesn't have access to `ml.m5.xlarge` instances.</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If you haven't requested a quota increase yet, you can use an</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `ml.t3.medium` instance type instead. This will work out of the box, but</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the Processing Job will take significantly longer than it should have.</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># To get access to `ml.m5.xlarge` instances, you can request a quota</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># increase under the Service Quotas section in your AWS account.</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now define the Processing Step that we’ll use in the pipeline.</p>
<p>This step will specify the list of inputs that we’ll access from the preprocessing script. In this case, the input is the dataset we stored in S3. We also have a few outputs that we want SageMaker to capture when the Processing Job finishes.</p>
<div id="cdbd9303" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.processing <span class="im">import</span> ProcessingInput, ProcessingOutput</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> ProcessingStep</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>preprocessing_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"preprocess-data"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>processor.run(</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>(CODE_FOLDER <span class="op">/</span> <span class="st">'processing'</span> <span class="op">/</span> <span class="st">'script.py'</span>)<span class="sc">.</span>as_posix()<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>dataset_location,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/input"</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"train"</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/train"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/train"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"validation"</span>,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/validation"</span>,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/validation"</span>,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"test"</span>,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/test"</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/test"</span>,</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/model"</span>,</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/model"</span>,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"train-baseline"</span>,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/train-baseline"</span>,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/train-baseline"</span>,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"test-baseline"</span>,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/test-baseline"</span>,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/preprocessing/test-baseline"</span>,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-the-pipeline">Step 5 - Creating the Pipeline</h3>
<p>We can now create the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="e140642a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>session3_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session3-pipeline"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>session3_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-4---training-the-model" class="level2">
<h2 class="anchored" data-anchor-id="session-4---training-the-model">Session 4 - Training the Model</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">step to train a model</a>. Check <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/using_tf.html#train-a-model-with-tensorflow">Train a Model with TensorFlow</a> for more information about training a model with TensorFlow.</p>
<p><a href="images/training-step.png" target="_blank"> <img src="images/training-step.png" alt="High-level overview of the Training Step" style="max-width: 740px;"></a></p>
<p>We’ll also introduce experiment tracking using <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments.html">Amazon SageMaker Experiments</a> and <a href="https://www.comet.com/site/?utm_source=svpino_course&amp;utm_medium=partner&amp;utm_content=github">Comet</a>.</p>
<section id="step-1---creating-the-training-script" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-training-script">Step 1 - Creating the Training Script</h3>
<p>Let’s create the training script. This script is responsible for training a neural network using the train data, validating the model, and saving it so we can later use it.</p>
<p>We will store the script in a folder called <code>training</code> and add it to the system path so we can later import it as a module.</p>
<div id="ac0b891c" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"training"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the script inside the folder:</p>
<div id="d92b121d-dcb9-43e8-9ee3-3ececb583e7e" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="28">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>script.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="im">import</span> argparse</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="im">import</span> json</span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="im">import</span> os</span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="im">import</span> tarfile</span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="im">from</span> comet_ml <span class="im">import</span> Experiment</span>
<span id="cb31-8"><a href="#cb31-8"></a></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="im">import</span> keras</span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="im">from</span> keras <span class="im">import</span> Input</span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense</span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential</span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="im">from</span> keras.optimizers <span class="im">import</span> SGD</span>
<span id="cb31-16"><a href="#cb31-16"></a><span class="im">from</span> packaging <span class="im">import</span> version</span>
<span id="cb31-17"><a href="#cb31-17"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb31-18"><a href="#cb31-18"></a></span>
<span id="cb31-19"><a href="#cb31-19"></a></span>
<span id="cb31-20"><a href="#cb31-20"></a><span class="kw">def</span> train(</span>
<span id="cb31-21"><a href="#cb31-21"></a>    model_directory,</span>
<span id="cb31-22"><a href="#cb31-22"></a>    train_path,</span>
<span id="cb31-23"><a href="#cb31-23"></a>    validation_path,</span>
<span id="cb31-24"><a href="#cb31-24"></a>    pipeline_path,</span>
<span id="cb31-25"><a href="#cb31-25"></a>    experiment,</span>
<span id="cb31-26"><a href="#cb31-26"></a>    epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb31-27"><a href="#cb31-27"></a>    batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb31-28"><a href="#cb31-28"></a>):</span>
<span id="cb31-29"><a href="#cb31-29"></a>    <span class="bu">print</span>(<span class="ss">f"Keras version: </span><span class="sc">{</span>keras<span class="sc">.</span>__version__<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-30"><a href="#cb31-30"></a></span>
<span id="cb31-31"><a href="#cb31-31"></a>    X_train <span class="op">=</span> pd.read_csv(Path(train_path) <span class="op">/</span> <span class="st">"train.csv"</span>)</span>
<span id="cb31-32"><a href="#cb31-32"></a>    y_train <span class="op">=</span> X_train[X_train.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb31-33"><a href="#cb31-33"></a>    X_train <span class="op">=</span> X_train.drop(X_train.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-34"><a href="#cb31-34"></a></span>
<span id="cb31-35"><a href="#cb31-35"></a>    X_validation <span class="op">=</span> pd.read_csv(Path(validation_path) <span class="op">/</span> <span class="st">"validation.csv"</span>)</span>
<span id="cb31-36"><a href="#cb31-36"></a>    y_validation <span class="op">=</span> X_validation[X_validation.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb31-37"><a href="#cb31-37"></a>    X_validation <span class="op">=</span> X_validation.drop(X_validation.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-38"><a href="#cb31-38"></a></span>
<span id="cb31-39"><a href="#cb31-39"></a>    model <span class="op">=</span> Sequential(</span>
<span id="cb31-40"><a href="#cb31-40"></a>        [</span>
<span id="cb31-41"><a href="#cb31-41"></a>            Input(shape<span class="op">=</span>(X_train.shape[<span class="dv">1</span>],)),</span>
<span id="cb31-42"><a href="#cb31-42"></a>            Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb31-43"><a href="#cb31-43"></a>            Dense(<span class="dv">8</span>, activation<span class="op">=</span><span class="st">"relu"</span>),</span>
<span id="cb31-44"><a href="#cb31-44"></a>            Dense(<span class="dv">3</span>, activation<span class="op">=</span><span class="st">"softmax"</span>),</span>
<span id="cb31-45"><a href="#cb31-45"></a>        ]</span>
<span id="cb31-46"><a href="#cb31-46"></a>    )</span>
<span id="cb31-47"><a href="#cb31-47"></a></span>
<span id="cb31-48"><a href="#cb31-48"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb31-49"><a href="#cb31-49"></a>        optimizer<span class="op">=</span>SGD(learning_rate<span class="op">=</span><span class="fl">0.01</span>),</span>
<span id="cb31-50"><a href="#cb31-50"></a>        loss<span class="op">=</span><span class="st">"sparse_categorical_crossentropy"</span>,</span>
<span id="cb31-51"><a href="#cb31-51"></a>        metrics<span class="op">=</span>[<span class="st">"accuracy"</span>],</span>
<span id="cb31-52"><a href="#cb31-52"></a>    )</span>
<span id="cb31-53"><a href="#cb31-53"></a></span>
<span id="cb31-54"><a href="#cb31-54"></a>    model.fit(</span>
<span id="cb31-55"><a href="#cb31-55"></a>        X_train,</span>
<span id="cb31-56"><a href="#cb31-56"></a>        y_train,</span>
<span id="cb31-57"><a href="#cb31-57"></a>        validation_data<span class="op">=</span>(X_validation, y_validation),</span>
<span id="cb31-58"><a href="#cb31-58"></a>        epochs<span class="op">=</span>epochs,</span>
<span id="cb31-59"><a href="#cb31-59"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb31-60"><a href="#cb31-60"></a>        verbose<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb31-61"><a href="#cb31-61"></a>    )</span>
<span id="cb31-62"><a href="#cb31-62"></a></span>
<span id="cb31-63"><a href="#cb31-63"></a>    predictions <span class="op">=</span> np.argmax(model.predict(X_validation), axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb31-64"><a href="#cb31-64"></a>    val_accuracy <span class="op">=</span> accuracy_score(y_validation, predictions)</span>
<span id="cb31-65"><a href="#cb31-65"></a>    <span class="bu">print</span>(<span class="ss">f"Validation accuracy: </span><span class="sc">{</span>val_accuracy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-66"><a href="#cb31-66"></a></span>
<span id="cb31-67"><a href="#cb31-67"></a>    <span class="co"># Starting on version 3, Keras changed the model saving format.</span></span>
<span id="cb31-68"><a href="#cb31-68"></a>    <span class="co"># Since we are running the training script using two different versions</span></span>
<span id="cb31-69"><a href="#cb31-69"></a>    <span class="co"># of Keras, we need to check to see which version we are using and save</span></span>
<span id="cb31-70"><a href="#cb31-70"></a>    <span class="co"># the model accordingly.</span></span>
<span id="cb31-71"><a href="#cb31-71"></a>    model_filepath <span class="op">=</span> (</span>
<span id="cb31-72"><a href="#cb31-72"></a>        Path(model_directory) <span class="op">/</span> <span class="st">"001"</span></span>
<span id="cb31-73"><a href="#cb31-73"></a>        <span class="cf">if</span> version.parse(keras.__version__) <span class="op">&lt;</span> version.parse(<span class="st">"3"</span>)</span>
<span id="cb31-74"><a href="#cb31-74"></a>        <span class="cf">else</span> Path(model_directory) <span class="op">/</span> <span class="st">"penguins.keras"</span></span>
<span id="cb31-75"><a href="#cb31-75"></a>    )</span>
<span id="cb31-76"><a href="#cb31-76"></a></span>
<span id="cb31-77"><a href="#cb31-77"></a>    model.save(model_filepath)</span>
<span id="cb31-78"><a href="#cb31-78"></a></span>
<span id="cb31-79"><a href="#cb31-79"></a>    <span class="co"># Let's save the transformation pipelines inside the</span></span>
<span id="cb31-80"><a href="#cb31-80"></a>    <span class="co"># model directory so they get bundled together.</span></span>
<span id="cb31-81"><a href="#cb31-81"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(Path(pipeline_path) <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"r:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb31-82"><a href="#cb31-82"></a>        tar.extractall(model_directory)</span>
<span id="cb31-83"><a href="#cb31-83"></a></span>
<span id="cb31-84"><a href="#cb31-84"></a>    <span class="cf">if</span> experiment:</span>
<span id="cb31-85"><a href="#cb31-85"></a>        experiment.log_parameters(</span>
<span id="cb31-86"><a href="#cb31-86"></a>            {</span>
<span id="cb31-87"><a href="#cb31-87"></a>                <span class="st">"epochs"</span>: epochs,</span>
<span id="cb31-88"><a href="#cb31-88"></a>                <span class="st">"batch_size"</span>: batch_size,</span>
<span id="cb31-89"><a href="#cb31-89"></a>            }</span>
<span id="cb31-90"><a href="#cb31-90"></a>        )</span>
<span id="cb31-91"><a href="#cb31-91"></a>        experiment.log_dataset_hash(X_train)</span>
<span id="cb31-92"><a href="#cb31-92"></a>        experiment.log_confusion_matrix(</span>
<span id="cb31-93"><a href="#cb31-93"></a>            y_validation.astype(<span class="bu">int</span>), predictions.astype(<span class="bu">int</span>)</span>
<span id="cb31-94"><a href="#cb31-94"></a>        )</span>
<span id="cb31-95"><a href="#cb31-95"></a>        experiment.log_model(<span class="st">"penguins"</span>, model_filepath.as_posix())</span>
<span id="cb31-96"><a href="#cb31-96"></a></span>
<span id="cb31-97"><a href="#cb31-97"></a></span>
<span id="cb31-98"><a href="#cb31-98"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb31-99"><a href="#cb31-99"></a>    <span class="co"># Any hyperparameters provided by the training job are passed to</span></span>
<span id="cb31-100"><a href="#cb31-100"></a>    <span class="co"># the entry point as script arguments.</span></span>
<span id="cb31-101"><a href="#cb31-101"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb31-102"><a href="#cb31-102"></a>    parser.add_argument(<span class="st">"--epochs"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb31-103"><a href="#cb31-103"></a>    parser.add_argument(<span class="st">"--batch_size"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb31-104"><a href="#cb31-104"></a>    args, _ <span class="op">=</span> parser.parse_known_args()</span>
<span id="cb31-105"><a href="#cb31-105"></a></span>
<span id="cb31-106"><a href="#cb31-106"></a>    <span class="co"># Let's create a Comet experiment to log the metrics and parameters</span></span>
<span id="cb31-107"><a href="#cb31-107"></a>    <span class="co"># of this training job.</span></span>
<span id="cb31-108"><a href="#cb31-108"></a>    comet_api_key <span class="op">=</span> os.environ.get(<span class="st">"COMET_API_KEY"</span>, <span class="va">None</span>)</span>
<span id="cb31-109"><a href="#cb31-109"></a>    comet_project_name <span class="op">=</span> os.environ.get(<span class="st">"COMET_PROJECT_NAME"</span>, <span class="va">None</span>)</span>
<span id="cb31-110"><a href="#cb31-110"></a></span>
<span id="cb31-111"><a href="#cb31-111"></a>    experiment <span class="op">=</span> (</span>
<span id="cb31-112"><a href="#cb31-112"></a>        Experiment(</span>
<span id="cb31-113"><a href="#cb31-113"></a>            project_name<span class="op">=</span>comet_project_name,</span>
<span id="cb31-114"><a href="#cb31-114"></a>            api_key<span class="op">=</span>comet_api_key,</span>
<span id="cb31-115"><a href="#cb31-115"></a>            auto_metric_logging<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-116"><a href="#cb31-116"></a>            auto_param_logging<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-117"><a href="#cb31-117"></a>            log_code<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-118"><a href="#cb31-118"></a>        )</span>
<span id="cb31-119"><a href="#cb31-119"></a>        <span class="cf">if</span> comet_api_key <span class="kw">and</span> comet_project_name</span>
<span id="cb31-120"><a href="#cb31-120"></a>        <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb31-121"><a href="#cb31-121"></a>    )</span>
<span id="cb31-122"><a href="#cb31-122"></a></span>
<span id="cb31-123"><a href="#cb31-123"></a>    training_env <span class="op">=</span> json.loads(os.environ.get(<span class="st">"SM_TRAINING_ENV"</span>, {}))</span>
<span id="cb31-124"><a href="#cb31-124"></a>    job_name <span class="op">=</span> training_env.get(<span class="st">"job_name"</span>, <span class="va">None</span>) <span class="cf">if</span> training_env <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb31-125"><a href="#cb31-125"></a></span>
<span id="cb31-126"><a href="#cb31-126"></a>    <span class="co"># We want to use the SageMaker's training job name as the name</span></span>
<span id="cb31-127"><a href="#cb31-127"></a>    <span class="co"># of the experiment so we can easily recognize it.</span></span>
<span id="cb31-128"><a href="#cb31-128"></a>    <span class="cf">if</span> job_name <span class="kw">and</span> experiment:</span>
<span id="cb31-129"><a href="#cb31-129"></a>        experiment.set_name(job_name)</span>
<span id="cb31-130"><a href="#cb31-130"></a></span>
<span id="cb31-131"><a href="#cb31-131"></a>    train(</span>
<span id="cb31-132"><a href="#cb31-132"></a>        <span class="co"># This is the location where we need to save our model.</span></span>
<span id="cb31-133"><a href="#cb31-133"></a>        <span class="co"># SageMaker will create a model.tar.gz file with anything</span></span>
<span id="cb31-134"><a href="#cb31-134"></a>        <span class="co"># inside this directory when the training script finishes.</span></span>
<span id="cb31-135"><a href="#cb31-135"></a>        model_directory<span class="op">=</span>os.environ[<span class="st">"SM_MODEL_DIR"</span>],</span>
<span id="cb31-136"><a href="#cb31-136"></a>        <span class="co"># SageMaker creates one channel for each one of the inputs</span></span>
<span id="cb31-137"><a href="#cb31-137"></a>        <span class="co"># to the Training Step.</span></span>
<span id="cb31-138"><a href="#cb31-138"></a>        train_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_TRAIN"</span>],</span>
<span id="cb31-139"><a href="#cb31-139"></a>        validation_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_VALIDATION"</span>],</span>
<span id="cb31-140"><a href="#cb31-140"></a>        pipeline_path<span class="op">=</span>os.environ[<span class="st">"SM_CHANNEL_PIPELINE"</span>],</span>
<span id="cb31-141"><a href="#cb31-141"></a>        experiment<span class="op">=</span>experiment,</span>
<span id="cb31-142"><a href="#cb31-142"></a>        epochs<span class="op">=</span>args.epochs,</span>
<span id="cb31-143"><a href="#cb31-143"></a>        batch_size<span class="op">=</span>args.batch_size,</span>
<span id="cb31-144"><a href="#cb31-144"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div id="14ea27ce-c453-4cb0-b309-dbecd732957e" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> processing.script <span class="im">import</span> preprocess</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training.script <span class="im">import</span> train</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>, </span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        pipeline_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        experiment<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_bundles_model_assets(directory):</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    bundle <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"001"</span> <span class="kw">in</span> bundle</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    assets <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"saved_model.pb"</span> <span class="kw">in</span> assets</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_train_bundles_transformation_pipelines(directory):</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    bundle <span class="op">=</span> os.listdir(directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"target.joblib"</span> <span class="kw">in</span> bundle</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"features.joblib"</span> <span class="kw">in</span> bundle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---setting-up-the-training-step" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-the-training-step">Step 2 - Setting up the Training Step</h3>
<p>We can now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a> that we can add to the pipeline. This Training Step will create a SageMaker Training Job in the background, run the training script, and upload the output to S3. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TrainingStep">TrainingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>SageMaker manages the infrastructure of a Training Job. It provisions resources for the duration of the job, and cleans up when it completes. The Training Container image that SageMaker uses to run a Training Job can either be a SageMaker built-in image or a custom image.</p>
<p><a href="images/training-job.png" target="_blank"> <img src="images/training-job.png" alt="High-level overview of a SageMaker Training Job" style="max-width: 740px;"></a></p>
<p>The <a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md">Available Deep Learning Container Images</a> page contains the list of available containers for each region.</p>
<p>Our training script uses <a href="https://www.comet.com/site/?utm_source=svpino_course&amp;utm_medium=partner&amp;utm_content=github">Comet</a> to track metrics from the Training Job. We need to create a <code>requirements.txt</code> file to install the Comet library in the training container.</p>
<div id="requirements.txt" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="30">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>comet_ml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>SageMaker uses the concept of an <a href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html">Estimator</a> to handle end-to-end training and deployment tasks. For this example, we will use the built-in <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html#tensorflow-estimator">TensorFlow Estimator</a> to run the training script we wrote before.</p>
<p>Notice the list of hyperparameters defined below. SageMaker will pass these hyperparameters as arguments to the entry point of the training script.</p>
<p>We are going to use <a href="https://www.comet.com/site/?utm_source=svpino_course&amp;utm_medium=partner&amp;utm_content=github">Comet</a> and <a href="https://sagemaker.readthedocs.io/en/v2.174.0/experiments/sagemaker.experiments.html">SageMaker Experiments</a> to track metrics from the Training Job. SageMaker Experiments will use the list of metric definitions to decide which metrics to track and how to parse them from the Training Job logs. For more information, check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/experiments.html">Manage Machine Learning with Amazon SageMaker Experiments</a> and the <a href="https://sagemaker.readthedocs.io/en/v2.174.0/experiments/sagemaker.experiments.html">SageMaker Experiments’ SDK documentation</a>.</p>
<p>Here are the environment variables we need to set on the traininng container:</p>
<ul>
<li><code>COMET_API_KEY</code>: This is your <a href="https://www.comet.com/site/?utm_source=svpino_course&amp;utm_medium=partner&amp;utm_content=github">Comet</a> API key.</li>
<li><code>COMET_PROJECT_NAME</code>: The name of the project where you want to track the experiments.</li>
</ul>
<div id="90fe82ae-6a2c-4461-bc83-bb52d8871e3b" class="cell" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow <span class="im">import</span> TensorFlow</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>estimator <span class="op">=</span> TensorFlow(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"training"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"script.py"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>(CODE_FOLDER <span class="op">/</span> <span class="st">'training'</span>)<span class="sc">.</span>as_posix()<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will pass these hyperparameters as arguments</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to the entry point of the training script.</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    hyperparameters<span class="op">=</span>{</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epochs"</span>: <span class="dv">50</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"batch_size"</span>: <span class="dv">32</span>,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will create these environment variables on the</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Training Job instance.</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span>{</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"COMET_API_KEY"</span>: COMET_API_KEY,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"COMET_PROJECT_NAME"</span>: COMET_PROJECT_NAME,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker will track these metrics as part of the experiment</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># associated to this pipeline. The metric definitions tells</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker how to parse the values from the Training Job logs.</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    metric_definitions<span class="op">=</span>[</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"loss"</span>, <span class="st">"Regex"</span>: <span class="st">"loss: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_loss"</span>, <span class="st">"Regex"</span>: <span class="st">"val_loss: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"Name"</span>: <span class="st">"val_accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"val_accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>},</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span>config[<span class="st">"py_version"</span>],</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    disable_profiler<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    debugger_hook_config<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a>. This Training Step will create a SageMaker Training Job in the background, run the training script, and upload the output to S3. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TrainingStep">TrainingStep</a> SageMaker’s SDK documentation for more information.</p>
<p>This step will receive the train and validation split from the preprocessing step as inputs.</p>
<p>Here, we are using three input channels, <code>train</code>, <code>validation</code>, and <code>pipeline</code>. SageMaker will automatically create an environment variable corresponding to each of these channels following the format <code>SM_CHANNEL_[channel_name]</code>:</p>
<ul>
<li><code>SM_CHANNEL_TRAIN</code>: This environment variable will contain the path to the training data coming from the preprocessing step.</li>
<li><code>SM_CHANNEL_VALIDATION</code>: This environment variable will contain the path to the validation data comimng from the preprocessing step.</li>
<li><code>SM_CHANNEL_PIPELINE</code>: This environment variable will contain the path to the transformation pipeline that we saved in the preprocessing step.</li>
</ul>
<p>Notice that we are creating a function that we can later reuse to create a training step using a different estimator.</p>
<div id="99e4850c-83d6-4f4e-a813-d5a3f4bb7486" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="32">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.inputs <span class="im">import</span> TrainingInput</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TrainingStep</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_training_step(estimator):</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a SageMaker TrainingStep using the provided estimator."""</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TrainingStep(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"train-model"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        step_args<span class="op">=</span>estimator.fit(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>            inputs<span class="op">=</span>{</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">"train"</span>: TrainingInput(</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                    s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"train"</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                    ].S3Output.S3Uri,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                    content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">"validation"</span>: TrainingInput(</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                    s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"validation"</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>                    ].S3Output.S3Uri,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>                    content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"pipeline"</span>: TrainingInput(</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>                    s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"model"</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>                    ].S3Output.S3Uri,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>                    content_type<span class="op">=</span><span class="st">"application/tar+gzip"</span>,</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        cache_config<span class="op">=</span>cache_config,</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>train_model_step <span class="op">=</span> create_training_step(estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-3---creating-the-pipeline">Step 3 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="d92cac3d" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="33">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>session4_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session4-pipeline"</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>session4_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-5---custom-training-container" class="level2">
<h2 class="anchored" data-anchor-id="session-5---custom-training-container">Session 5 - Custom Training Container</h2>
<p>This session creates a custom Docker image to train the model and have full control of the environment where the training script runs.</p>
<p>For this example, we’ll run the training script using <a href="https://keras.io">Keras 3</a> with a <a href="https://jax.readthedocs.io/en/latest/index.html">JAX</a> backend. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/docker-containers-adapt-your-own.html">Adapting your own Docker container to work with SageMaker</a> for more information about using your own Docker containers.</p>
<section id="step-1---preparing-the-docker-image" class="level3">
<h3 class="anchored" data-anchor-id="step-1---preparing-the-docker-image">Step 1 - Preparing the Docker Image</h3>
<p>The first step is to copy the training script to a folder where we’ll prepare the Docker image. We are going to reuse the training script we created before, since it’s compatible with the latest version of Keras.</p>
<div id="57c2915c" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"containers"</span> <span class="op">/</span> <span class="st">"training"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>shutil.copy2(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    CODE_FOLDER <span class="op">/</span> <span class="st">"training"</span> <span class="op">/</span> <span class="st">"script.py"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    CODE_FOLDER <span class="op">/</span> <span class="st">"containers"</span> <span class="op">/</span> <span class="st">"training"</span> <span class="op">/</span> <span class="st">"train.py"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>PosixPath('code/containers/training/train.py')</code></pre>
</div>
</div>
<p>Since we are creating a new Docker image, we need to install the libraries we need in the training container. We’ll use a <code>requirements.txt</code> file to install these libraries. Notice that we are installing <code>jax</code> to run it as our backend.</p>
<p>The <code>sagemaker-training</code> library contains the common functionality necessary to create a container compatible with SageMaker and its Python SDK.</p>
<div id="3ffa9250" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="35">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>sagemaker<span class="op">-</span>training</span>
<span id="cb39-2"><a href="#cb39-2"></a>packaging</span>
<span id="cb39-3"><a href="#cb39-3"></a>keras</span>
<span id="cb39-4"><a href="#cb39-4"></a>pandas</span>
<span id="cb39-5"><a href="#cb39-5"></a>scikit<span class="op">-</span>learn</span>
<span id="cb39-6"><a href="#cb39-6"></a>comet_ml</span>
<span id="cb39-7"><a href="#cb39-7"></a>jax[cpu]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can now create the Dockerfile containing the instructions to build the training image. Notice how this image will automatically run the <code>train.py</code> script when it starts.</p>
<p>To use JAX as the backend for our model, we need to set the <code>KERAS_BACKEND</code> environment variable to <code>jax</code>.</p>
<div id="de5d473c" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="36">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1"></a>FROM python:<span class="fl">3.10</span><span class="op">-</span>slim</span>
<span id="cb40-2"><a href="#cb40-2"></a></span>
<span id="cb40-3"><a href="#cb40-3"></a>RUN apt<span class="op">-</span>get <span class="op">-</span>y update <span class="op">&amp;&amp;</span> apt<span class="op">-</span>get install <span class="op">-</span>y <span class="op">--</span>no<span class="op">-</span>install<span class="op">-</span>recommends <span class="op">\</span></span>
<span id="cb40-4"><a href="#cb40-4"></a>    python3 <span class="op">\</span></span>
<span id="cb40-5"><a href="#cb40-5"></a>    build<span class="op">-</span>essential libssl<span class="op">-</span>dev pkg<span class="op">-</span>config libhdf5<span class="op">-</span>dev</span>
<span id="cb40-6"><a href="#cb40-6"></a></span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="co"># Let's install the required Python packages from </span></span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="co"># the requirements.txt file.</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>COPY requirements.txt .</span>
<span id="cb40-10"><a href="#cb40-10"></a>RUN pip install <span class="op">--</span>user <span class="op">--</span>upgrade pip</span>
<span id="cb40-11"><a href="#cb40-11"></a>RUN pip3 install <span class="op">-</span>r requirements.txt</span>
<span id="cb40-12"><a href="#cb40-12"></a></span>
<span id="cb40-13"><a href="#cb40-13"></a><span class="co"># We are going to be running the training script</span></span>
<span id="cb40-14"><a href="#cb40-14"></a><span class="co"># as the entrypoint of this container.</span></span>
<span id="cb40-15"><a href="#cb40-15"></a>COPY train.py <span class="op">/</span>opt<span class="op">/</span>ml<span class="op">/</span>code<span class="op">/</span>train.py</span>
<span id="cb40-16"><a href="#cb40-16"></a>ENV SAGEMAKER_PROGRAM train.py</span>
<span id="cb40-17"><a href="#cb40-17"></a></span>
<span id="cb40-18"><a href="#cb40-18"></a><span class="co"># We want to use JAX as the backend for Keras.</span></span>
<span id="cb40-19"><a href="#cb40-19"></a>ENV KERAS_BACKEND<span class="op">=</span>jax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="step-2---building-the-docker-image" class="level3">
<h3 class="anchored" data-anchor-id="step-2---building-the-docker-image">Step 2 - Building the Docker Image</h3>
<p>We can now build the Docker image using the <code>docker build</code> command. We are going to define the name of this image using the <code>IMAGE_NAME</code> variable.</p>
<div id="e37a06ac" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>IMAGE_NAME <span class="op">=</span> <span class="st">"keras-custom-training-container"</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> LOCAL_MODE:</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we aren't running the code in Local Mode, we need</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to specify we want to build the Docker image for the</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># linux/amd64 architecture before uploading it to ECR.</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Building Docker image for linux/amd64 architecture..."</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>docker build <span class="op">--</span>platform<span class="op">=</span><span class="st">"linux/amd64"</span> <span class="op">-</span>t $IMAGE_NAME <span class="op">\</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        $CODE_FOLDER<span class="op">/</span>containers<span class="op">/</span>training<span class="op">/</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If we are running in Local Mode, we can use the</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># default Docker build command.</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Building Docker image for arm64 architecture..."</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>docker build <span class="op">-</span>t $IMAGE_NAME <span class="op">\</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        $CODE_FOLDER<span class="op">/</span>containers<span class="op">/</span>training<span class="op">/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---pushing-docker-image-to-ecr" class="level3">
<h3 class="anchored" data-anchor-id="step-3---pushing-docker-image-to-ecr">Step 3 - Pushing Docker Image to ECR</h3>
<p>We can now push the Docker image to Amazon Elastic Container Registry (ECR). This is a fully-managed Docker container registry where we can manage Docker container images. This step is necessary to make the image available to SageMaker when running the pipeline.</p>
<div id="ceede5e2" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>algorithm_name<span class="op">=</span>$<span class="dv">2</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>account<span class="op">=</span>$(aws sts get<span class="op">-</span>caller<span class="op">-</span>identity <span class="op">--</span>query Account <span class="op">--</span>output text)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the region defined in the current configuration</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (default to us-east-1 if none defined)</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>region<span class="op">=</span>$(aws configure get region)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>region<span class="op">=</span>${region:<span class="op">-</span>us<span class="op">-</span>east<span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>repository<span class="op">=</span><span class="st">"$</span><span class="sc">{account}</span><span class="st">.dkr.ecr.$</span><span class="sc">{region}</span><span class="st">.amazonaws.com/$</span><span class="sc">{algorithm_name}</span><span class="st">:latest"</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># We only want to push the Docker image to ECR if</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co"># we are not running in Local Mode.</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> [ $<span class="dv">1</span> <span class="op">=</span> <span class="st">"False"</span> ]</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>then</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the repository if it doesn't exist in ECR</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    aws ecr describe<span class="op">-</span>repositories <span class="op">\</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>repository<span class="op">-</span>names <span class="st">"$</span><span class="sc">{algorithm_name}</span><span class="st">"</span> <span class="op">&gt;</span> <span class="op">/</span>dev<span class="op">/</span>null <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> [ $? <span class="op">-</span>ne <span class="dv">0</span> ]</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    then</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>        aws ecr create<span class="op">-</span>repository <span class="op">\</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">--</span>repository<span class="op">-</span>name <span class="st">"$</span><span class="sc">{algorithm_name}</span><span class="st">"</span> <span class="op">&gt;</span> <span class="op">/</span>dev<span class="op">/</span>null</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    fi</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the login command from ECR to run the</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Docker push command.</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    aws ecr get<span class="op">-</span>login<span class="op">-</span>password <span class="op">\</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">--</span>region ${region}<span class="op">|</span>docker <span class="op">\</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        login <span class="op">--</span>username AWS <span class="op">--</span>password<span class="op">-</span>stdin ${repository}</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Push the Docker image to the ECR repository</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    docker tag ${algorithm_name} ${repository}</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    docker push ${repository}</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>fi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---setting-up-the-training-step" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-the-training-step">Step 4 - Setting up the Training Step</h3>
<p>Let’s now compute the name of the training image we’ll use to run the Training Job.</p>
<p>If we are running in <code>LOCAL_MODE</code>, we’ll use the name of the image we built before (<code>IMAGE_NAME</code>). Otherwise, we’ll use the name of the image we pushed to ECR.</p>
<div id="49d9ab0e" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>account_id <span class="op">=</span> boto3.client(<span class="st">"sts"</span>).get_caller_identity().get(<span class="st">"Account"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>tag <span class="op">=</span> <span class="st">":latest"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>uri_suffix <span class="op">=</span> <span class="st">"amazonaws.com"</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> region <span class="kw">in</span> [<span class="st">"cn-north-1"</span>, <span class="st">"cn-northwest-1"</span>]:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    uri_suffix <span class="op">=</span> <span class="st">"amazonaws.com.cn"</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>training_container_image <span class="op">=</span> (</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    IMAGE_NAME</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> LOCAL_MODE</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> (<span class="ss">f"</span><span class="sc">{</span>account_id<span class="sc">}</span><span class="ss">.dkr.ecr.</span><span class="sc">{</span>region<span class="sc">}</span><span class="ss">.amazonaws.com/</span><span class="sc">{</span>IMAGE_NAME<span class="sc">}</span><span class="ss">:latest"</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>training_container_image</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>'keras-custom-training-container'</code></pre>
</div>
</div>
<p>We can now create an <a href="https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html">Estimator</a> and a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-training">Training Step</a> using the function we created before.</p>
<div id="f4e17204" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="40">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.estimator <span class="im">import</span> Estimator</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>keras_estimator <span class="op">=</span> Estimator(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>training_container_image,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>keras_train_model_step <span class="op">=</span> create_training_step(keras_estimator)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-the-pipeline-1">Step 5 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="86056197" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>session5_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session5-pipeline"</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This time we want to use the new training step</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we created using the custom Docker image.</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        keras_train_model_step,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>session5_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-6---tuning-the-model" class="level2">
<h2 class="anchored" data-anchor-id="session-6---tuning-the-model">Session 6 - Tuning the Model</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-tuning">step to tune the model</a> using a Hyperparameter Tuning Job.</p>
<p><a href="images/tuning-step.png" target="_blank"> <img src="images/tuning-step.png" alt="High-level overview of the Tuning Step" style="max-width: 740px;"></a></p>
<section id="step-1---enabling-tuning" class="level3">
<h3 class="anchored" data-anchor-id="step-1---enabling-tuning">Step 1 - Enabling Tuning</h3>
<p>Since we could use the Training of the Tuning Step to create a model, we’ll define a constant to indicate which approach we want to run. Notice that the Tuning Step is not supported in Local Mode.</p>
<div id="f367d0e3" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>USE_TUNING_STEP <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---setting-up-a-tuning-step" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-a-tuning-step">Step 2 - Setting up a Tuning Step</h3>
<p>Let’s now create a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-tuning">Tuning Step</a>. This Tuning Step will create a SageMaker Hyperparameter Tuning Job in the background and use the training script to train different model variants and choose the best one. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TuningStep">TuningStep</a> SageMaker’s SDK documentation for more information.</p>
<p>The Tuning Step requires a <a href="https://sagemaker.readthedocs.io/en/stable/api/training/tuner.html">HyperparameterTuner</a> reference to configure the Hyperparameter Tuning Job.</p>
<p>Here is the configuration that we’ll use to find the best model:</p>
<ol type="1">
<li><code>objective_metric_name</code>: This is the name of the metric the tuner will use to determine the best model.</li>
<li><code>objective_type</code>: This is the objective of the tuner. It specifies whether it should minimize the metric or maximize it. In this example, since we are using the validation accuracy of the model, we want the objective to be “Maximize.” If we were using the loss of the model, we would set the objective to “Minimize.”</li>
<li><code>metric_definitions</code>: Defines how the tuner will determine the metric’s value by looking at the output logs of the training process.</li>
</ol>
<p>The tuner expects the list of the hyperparameters you want to explore. You can use subclasses of the <a href="https://sagemaker.readthedocs.io/en/stable/api/training/parameter.html#sagemaker.parameter.ParameterRange">Parameter</a> class to specify different types of hyperparameters. This example explores different values for the <code>epochs</code> hyperparameter.</p>
<p>Finally, you can control the number of jobs and how many of them will run in parallel using the following two arguments:</p>
<ul>
<li><code>max_jobs</code>: Defines the maximum total number of training jobs to start for the hyperparameter tuning job.</li>
<li><code>max_parallel_jobs</code>: Defines the maximum number of parallel training jobs to start.</li>
</ul>
<div id="c8c82750" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.parameter <span class="im">import</span> IntegerParameter</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tuner <span class="im">import</span> HyperparameterTuner</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> HyperparameterTuner(</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    estimator,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    objective_metric_name<span class="op">=</span><span class="st">"val_accuracy"</span>,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    objective_type<span class="op">=</span><span class="st">"Maximize"</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    hyperparameter_ranges<span class="op">=</span>{</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epochs"</span>: IntegerParameter(<span class="dv">10</span>, <span class="dv">50</span>),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    metric_definitions<span class="op">=</span>[{<span class="st">"Name"</span>: <span class="st">"val_accuracy"</span>, <span class="st">"Regex"</span>: <span class="st">"val_accuracy: ([0-9</span><span class="ch">\\</span><span class="st">.]+)"</span>}],</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    max_jobs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    max_parallel_jobs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the Tuning Step using the tuner we configured before. SageMaker will create a Hyperparameter Tuning Job in the background and use the training script to train different model variants and choose the best one.</p>
<p><a href="images/tuning-job.png" target="_blank"> <img src="images/tuning-job.png" alt="High-level overview of SageMaker's Hyperparameter Tuning Jobs" style="max-width: 740px;"></a></p>
<div id="038ff2e5-ed28-445b-bc03-4e996ec2286f" class="cell" data-tags="[]" data-execution_count="44">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TuningStep</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>tune_model_step <span class="op">=</span> TuningStep(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"tune-model"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>tuner.fit(</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train"</span>: TrainingInput(</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"train"</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"validation"</span>: TrainingInput(</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"validation"</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"pipeline"</span>: TrainingInput(</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>                s3_data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"model"</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>                content_type<span class="op">=</span><span class="st">"application/tar+gzip"</span>,</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-3---creating-the-pipeline-1">Step 3 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="9799ab39-fcae-41f4-a68b-85ab71b3ba9a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="45">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>session6_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session6-pipeline"</span>,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>session6_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-7---evaluating-the-model" class="level2">
<h2 class="anchored" data-anchor-id="session-7---evaluating-the-model">Session 7 - Evaluating the Model</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a step to evaluate the model using the holdout set we created during the preprocessing step.</p>
<p><a href="images/evaluation-step.png" target="_blank"> <img src="images/evaluation-step.png" alt="High-level overview of the Evaluation Step" style="max-width: 740px;"></a></p>
<section id="step-1---creating-the-evaluation-script" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-evaluation-script">Step 1 - Creating the Evaluation Script</h3>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> to execute the evaluation script.</p>
<p>This script is responsible for loading the model we created and evaluating it on the test set. Before finishing, this script will generate an evaluation report of the model.</p>
<p>We will store the script in a folder called <code>evaluation</code> and add it to the system path so we can later import it as a module.</p>
<div id="0590fcfa" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"evaluation"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the script inside the folder:</p>
<div id="3ee3ab26-afa5-4ceb-9f7a-005d5fdea646" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="47">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>script.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="im">import</span> json</span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="im">import</span> tarfile</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb52-4"><a href="#cb52-4"></a></span>
<span id="cb52-5"><a href="#cb52-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb52-7"><a href="#cb52-7"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb52-8"><a href="#cb52-8"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb52-9"><a href="#cb52-9"></a></span>
<span id="cb52-10"><a href="#cb52-10"></a></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="kw">def</span> evaluate(model_path, test_path, output_path):</span>
<span id="cb52-12"><a href="#cb52-12"></a>    X_test <span class="op">=</span> pd.read_csv(Path(test_path) <span class="op">/</span> <span class="st">"test.csv"</span>)</span>
<span id="cb52-13"><a href="#cb52-13"></a>    y_test <span class="op">=</span> X_test[X_test.columns[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb52-14"><a href="#cb52-14"></a>    X_test <span class="op">=</span> X_test.drop(X_test.columns[<span class="op">-</span><span class="dv">1</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb52-15"><a href="#cb52-15"></a></span>
<span id="cb52-16"><a href="#cb52-16"></a>    <span class="co"># Let's now extract the model package so we can load</span></span>
<span id="cb52-17"><a href="#cb52-17"></a>    <span class="co"># it in memory.</span></span>
<span id="cb52-18"><a href="#cb52-18"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(Path(model_path) <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb52-19"><a href="#cb52-19"></a>        tar.extractall(path<span class="op">=</span>Path(model_path))</span>
<span id="cb52-20"><a href="#cb52-20"></a></span>
<span id="cb52-21"><a href="#cb52-21"></a>    model <span class="op">=</span> keras.models.load_model(Path(model_path) <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb52-22"><a href="#cb52-22"></a></span>
<span id="cb52-23"><a href="#cb52-23"></a>    predictions <span class="op">=</span> np.argmax(model.predict(X_test), axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb52-24"><a href="#cb52-24"></a>    accuracy <span class="op">=</span> accuracy_score(y_test, predictions)</span>
<span id="cb52-25"><a href="#cb52-25"></a>    <span class="bu">print</span>(<span class="ss">f"Test accuracy: </span><span class="sc">{</span>accuracy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-26"><a href="#cb52-26"></a></span>
<span id="cb52-27"><a href="#cb52-27"></a>    <span class="co"># Let's create an evaluation report using the model accuracy.</span></span>
<span id="cb52-28"><a href="#cb52-28"></a>    evaluation_report <span class="op">=</span> {</span>
<span id="cb52-29"><a href="#cb52-29"></a>        <span class="st">"metrics"</span>: {</span>
<span id="cb52-30"><a href="#cb52-30"></a>            <span class="st">"accuracy"</span>: {<span class="st">"value"</span>: accuracy},</span>
<span id="cb52-31"><a href="#cb52-31"></a>        },</span>
<span id="cb52-32"><a href="#cb52-32"></a>    }</span>
<span id="cb52-33"><a href="#cb52-33"></a></span>
<span id="cb52-34"><a href="#cb52-34"></a>    Path(output_path).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb52-35"><a href="#cb52-35"></a>    <span class="cf">with</span> <span class="bu">open</span>(Path(output_path) <span class="op">/</span> <span class="st">"evaluation.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb52-36"><a href="#cb52-36"></a>        f.write(json.dumps(evaluation_report))</span>
<span id="cb52-37"><a href="#cb52-37"></a></span>
<span id="cb52-38"><a href="#cb52-38"></a></span>
<span id="cb52-39"><a href="#cb52-39"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb52-40"><a href="#cb52-40"></a>    evaluate(</span>
<span id="cb52-41"><a href="#cb52-41"></a>        model_path<span class="op">=</span><span class="st">"/opt/ml/processing/model/"</span>,</span>
<span id="cb52-42"><a href="#cb52-42"></a>        test_path<span class="op">=</span><span class="st">"/opt/ml/processing/test/"</span>,</span>
<span id="cb52-43"><a href="#cb52-43"></a>        output_path<span class="op">=</span><span class="st">"/opt/ml/processing/evaluation/"</span>,</span>
<span id="cb52-44"><a href="#cb52-44"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div id="9a2540d8-278a-4953-bc54-0469d154427d" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> processing.script <span class="im">import</span> preprocess</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training.script <span class="im">import</span> train</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> evaluation.script <span class="im">import</span> evaluate</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>,</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>        pipeline_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>        experiment<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After training a model, we need to prepare a package just like</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker would. This package is what the evaluation script is</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expecting as an input.</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>        tar.add(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>, arcname<span class="op">=</span><span class="st">"001"</span>)</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    evaluate(</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>        model_path<span class="op">=</span>directory,</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>        test_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"test"</span>,</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>        output_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"evaluation"</span>,</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory <span class="op">/</span> <span class="st">"evaluation"</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_evaluate_generates_evaluation_report(directory):</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> os.listdir(directory)</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"evaluation.json"</span> <span class="kw">in</span> output</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_evaluation_report_contains_accuracy(directory):</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"evaluation.json"</span>, <span class="st">"r"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> json.load(<span class="bu">file</span>)</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"metrics"</span> <span class="kw">in</span> report</span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"accuracy"</span> <span class="kw">in</span> report[<span class="st">"metrics"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---referencing-the-model-assets" class="level3">
<h3 class="anchored" data-anchor-id="step-2---referencing-the-model-assets">Step 2 - Referencing the Model Assets</h3>
<p>One of the inputs to the evaluation step is the model coming from the Training or the Tuning step. We can use the <code>USE_TUNING_STEP</code> flag to determine whether we created the model using a Training Step or a Tuning Step.</p>
<p>In case we are using the Tuning Step, we can use the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.TuningStep.get_top_model_s3_uri">TuningStep.get_top_model_s3_uri()</a> function to get the model assets from the top performing training job of the Hyperparameter Tuning Job.</p>
<div id="4f19e15b" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>model_assets <span class="op">=</span> train_model_step.properties.ModelArtifacts.S3ModelArtifacts</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> USE_TUNING_STEP:</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    model_assets <span class="op">=</span> tune_model_step.get_top_model_s3_uri(</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        top_k<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        s3_bucket<span class="op">=</span>config[<span class="st">"session"</span>].default_bucket(),</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---mapping-the-output-to-a-property-file" class="level3">
<h3 class="anchored" data-anchor-id="step-3---mapping-the-output-to-a-property-file">Step 3 - Mapping the Output to a Property File</h3>
<p>SageMaker supports mapping outputs from a Processing Step to property files. This is useful when we want to access a specific property from the pipeline.</p>
<p>We’ll map the evaluation report to a property file. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-propertyfile.html">How to Build and Manage Property Files</a> for more information.</p>
<div id="1f27b2ef" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.properties <span class="im">import</span> PropertyFile</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>evaluation_report <span class="op">=</span> PropertyFile(</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"evaluation-report"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    output_name<span class="op">=</span><span class="st">"evaluation"</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="st">"evaluation.json"</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---setting-up-the-evaluation-step" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-the-evaluation-step">Step 4 - Setting up the Evaluation Step</h3>
<p>To run the evaluation script, we will use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-processing">Processing Step</a> configured with a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/processing-job-frameworks-tensorflow.html">TensorFlowProcessor</a> because the script needs access to TensorFlow.</p>
<div id="2fdff07f" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="51">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow <span class="im">import</span> TensorFlowProcessor</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>evaluation_processor <span class="op">=</span> TensorFlowProcessor(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    base_job_name<span class="op">=</span><span class="st">"evaluation-processor"</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>config[<span class="st">"image"</span>],</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span>config[<span class="st">"py_version"</span>],</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are now ready to define the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.steps.ProcessingStep">Processing Step</a> that will run the evaluation script:</p>
<div id="48139a07-5c8e-4bc6-b666-bf9531f7f520" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="52">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>evaluate_model_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"evaluate-model"</span>,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>evaluation_processor.run(</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>        code<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>(CODE_FOLDER <span class="op">/</span> <span class="st">'evaluation'</span> <span class="op">/</span> <span class="st">'script.py'</span>)<span class="sc">.</span>as_posix()<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>[</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The first input is the test split that we generated on</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the first step of the pipeline when we split and</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            <span class="co"># transformed the data.</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"test"</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/test"</span>,</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The second input is the model that we generated on</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the Training or Tunning Step.</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>            ProcessingInput(</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span>model_assets,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                destination<span class="op">=</span><span class="st">"/opt/ml/processing/model"</span>,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>[</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The output is the evaluation report that we generated</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># in the evaluation script.</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>            ProcessingOutput(</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>                output_name<span class="op">=</span><span class="st">"evaluation"</span>,</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>                source<span class="op">=</span><span class="st">"/opt/ml/processing/evaluation"</span>,</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    property_files<span class="op">=</span>[evaluation_report],</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-the-pipeline-2" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-the-pipeline-2">Step 5 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="21a1ab1f" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="53">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>session7_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session7-pipeline"</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>session7_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-8---registering-the-model" class="level2">
<h2 class="anchored" data-anchor-id="session-8---registering-the-model">Session 8 - Registering the Model</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a step to <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry-version.html">register the model</a> in the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry.html">SageMaker Model Registry</a>.</p>
<p><a href="images/registration-step.png" target="_blank"> <img src="images/registration-step.png" alt="High-level overview of the Registration Step" style="max-width: 740px;"></a></p>
<section id="step-1---configuring-the-model-package-group" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-the-model-package-group">Step 1 - Configuring the Model Package Group</h3>
<p>First, let’s define the name of the group where we’ll register the model. The Model Registry uses groups to organize the versions of a model:</p>
<div id="bb70f907" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>BASIC_MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"basic-penguins"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---creating-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-model">Step 2 - Creating the Model</h3>
<p>Let’s now create the model that we’ll register in the Model Registry. The model we trained uses TensorFlow, so we can use the built-in <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html#tensorflow-serving-model">TensorFlowModel</a> class to create an instance of the model:</p>
<div id="4ca4cb61" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.tensorflow.model <span class="im">import</span> TensorFlowModel</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>tensorflow_model <span class="op">=</span> TensorFlowModel(</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>model_assets,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---configuring-model-metrics" class="level3">
<h3 class="anchored" data-anchor-id="step-3---configuring-model-metrics">Step 3 - Configuring Model Metrics</h3>
<p>When we register a model in the Model Registry, we can attach relevant metadata to it. We’ll use the evaluation report we generated during the evaluation step to populate the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_metrics.ModelMetrics">metrics</a> of this model:</p>
<div id="8c05a7e1" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_metrics <span class="im">import</span> MetricsSource, ModelMetrics</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> Join</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>Join(</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">"/"</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>            values<span class="op">=</span>[</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                evaluate_model_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"evaluation"</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                ].S3Output.S3Uri,</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">"evaluation.json"</span>,</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---registering-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-4---registering-the-model">Step 4 - Registering the Model</h3>
<p>We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-model">Model Step</a> to register the model. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.model_step.ModelStep">ModelStep</a> SageMaker’s SDK documentation for more information.</p>
<div id="c9773a4a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="57">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.model_step <span class="im">import</span> ModelStep</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_registration_step(</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    model_package_group_name,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    approval_status<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    content_types<span class="op">=</span>[<span class="st">"text/csv"</span>],</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    response_types<span class="op">=</span>[<span class="st">"application/json"</span>],</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    drift_check_baselines<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Registration Step using the supplied parameters."""</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ModelStep(</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"register"</span>,</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>        step_args<span class="op">=</span>model.register(</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>            model_package_group_name<span class="op">=</span>model_package_group_name,</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>            approval_status<span class="op">=</span>approval_status,</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>            model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>            drift_check_baselines<span class="op">=</span>drift_check_baselines,</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>            content_types<span class="op">=</span>content_types,</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>            response_types<span class="op">=</span>response_types,</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>            inference_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>            transform_instances<span class="op">=</span>[config[<span class="st">"instance_type"</span>]],</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>            framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>            domain<span class="op">=</span><span class="st">"MACHINE_LEARNING"</span>,</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>            task<span class="op">=</span><span class="st">"CLASSIFICATION"</span>,</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>            framework<span class="op">=</span><span class="st">"TENSORFLOW"</span>,</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> create_registration_step(</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>    tensorflow_model,</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    BASIC_MODEL_PACKAGE_GROUP,</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-the-pipeline-3" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-the-pipeline-3">Step 5 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="4d09cc85" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="58">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>session8_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session8-pipeline"</span>,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location],</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        register_model_step,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>session8_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-9---conditional-registration" class="level2">
<h2 class="anchored" data-anchor-id="session-9---conditional-registration">Session 9 - Conditional Registration</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a condition to register the model only if its accuracy is above a predefined threshold.</p>
<p>Here’s a high-level overview of the Condition Step:</p>
<p><a href="images/condition-step.png" target="_blank"> <img src="images/condition-step.png" alt="High-level overview of the Condition Step" style="max-width: 740px;"></a></p>
<section id="step-1---configuring-the-accuracy-threshold" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-the-accuracy-threshold">Step 1 - Configuring the Accuracy Threshold</h3>
<p>Let’s define a new <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-parameters.html">Pipeline Parameter</a> to specify the minimum accuracy that the model should reach for it to be registered.</p>
<div id="745486b5" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> ParameterFloat</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>accuracy_threshold <span class="op">=</span> ParameterFloat(name<span class="op">=</span><span class="st">"accuracy_threshold"</span>, default_value<span class="op">=</span><span class="fl">0.70</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---setting-up-a-fail-step" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-a-fail-step">Step 2 - Setting up a Fail Step</h3>
<p>If the model’s accuracy is not greater than or equal to our threshold, we will send the pipeline to a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-fail">Fail Step</a> with the appropriate error message. Check the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.fail_step.FailStep">FailStep</a> SageMaker’s SDK documentation for more information.</p>
<div id="c4431bbf" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.fail_step <span class="im">import</span> FailStep</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>fail_step <span class="op">=</span> FailStep(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"fail"</span>,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    error_message<span class="op">=</span>Join(</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">" "</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Execution failed because the model's accuracy was lower than"</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>            accuracy_threshold,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---defining-the-condition" class="level3">
<h3 class="anchored" data-anchor-id="step-3---defining-the-condition">Step 3 - Defining the Condition</h3>
<p>We can use a <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.conditions.ConditionGreaterThanOrEqualTo">ConditionGreaterThanOrEqualTo</a> condition to compare the model’s accuracy with the threshold. Look at the <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_building_pipeline.html#conditions">Conditions</a> section in the documentation for more information about the types of supported conditions.</p>
<div id="bebeecab" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.conditions <span class="im">import</span> ConditionGreaterThanOrEqualTo</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.functions <span class="im">import</span> JsonGet</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>condition <span class="op">=</span> ConditionGreaterThanOrEqualTo(</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    left<span class="op">=</span>JsonGet(</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>        step_name<span class="op">=</span>evaluate_model_step.name,</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        property_file<span class="op">=</span>evaluation_report,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>        json_path<span class="op">=</span><span class="st">"metrics.accuracy.value"</span>,</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    right<span class="op">=</span>accuracy_threshold,</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---setting-up-the-condition-step" class="level3">
<h3 class="anchored" data-anchor-id="step-4---setting-up-the-condition-step">Step 4 - Setting up the Condition Step</h3>
<p>Let’s now use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-condition">Condition Step</a> together with the evaluation report we generated to determine whether the model’s accuracy is above the threshold:</p>
<div id="36e2a2b1-6711-4266-95d8-d2aebd52e199" class="cell" data-tags="[]" data-execution_count="62">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.condition_step <span class="im">import</span> ConditionStep</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step],</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-the-pipeline-4" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-the-pipeline-4">Step 5 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="f70bcd33-b499-4e2b-953e-94d1ed96c10a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="63">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>session9_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session9-pipeline"</span>,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        tune_model_step <span class="cf">if</span> USE_TUNING_STEP <span class="cf">else</span> train_model_step,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>session9_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-10---serving-the-model" class="level2">
<h2 class="anchored" data-anchor-id="session-10---serving-the-model">Session 10 - Serving the Model</h2>
<p>This session builds a simple <a href="https://flask.palletsprojects.com/">Flask</a> application to serve the model.</p>
<p><a href="images/deploying-flask.png" target="_blank"> <img src="images/deploying-flask.png" alt="High-level overview of deploying a model using a Flask wrapper" style="max-width: 740px;"></a></p>
<p>Keep in mind that, while good for development and testing, this is not the best approach for production systems.</p>
<section id="step-1---retrieving-list-of-approved-models" class="level3">
<h3 class="anchored" data-anchor-id="step-1---retrieving-list-of-approved-models">Step 1 - Retrieving List of Approved Models</h3>
<p>We want to serve the latest approved model from the Model Registry. We can use the <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html">boto3</a> API to get this model:</p>
<div id="a67726d7" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> sagemaker_client.list_model_packages(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    ModelPackageGroupName<span class="op">=</span>BASIC_MODEL_PACKAGE_GROUP,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    ModelApprovalStatus<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    SortBy<span class="op">=</span><span class="st">"CreationTime"</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    MaxResults<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>package <span class="op">=</span> (</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    response[<span class="st">"ModelPackageSummaryList"</span>][<span class="dv">0</span>]</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response[<span class="st">"ModelPackageSummaryList"</span>]</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>package</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>{'ModelPackageGroupName': 'basic-penguins',
 'ModelPackageVersion': 6,
 'ModelPackageArn': 'arn:aws:sagemaker:us-east-1:325223348818:model-package/basic-penguins/6',
 'CreationTime': datetime.datetime(2024, 3, 29, 11, 19, 48, 782000, tzinfo=tzlocal()),
 'ModelPackageStatus': 'Completed',
 'ModelApprovalStatus': 'Approved'}</code></pre>
</div>
</div>
</section>
<section id="step-2---downloading-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-2---downloading-the-model">Step 2 - Downloading the Model</h3>
<p>Let’s now download the model assets from the location specified in the Model Registry to your local environment.</p>
<p>We will store this model in a folder called <code>serving</code>:</p>
<div id="f2e94adc" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"serving"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now download the model assets into the folder:</p>
<div id="bd12fbe9" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.s3 <span class="im">import</span> S3Downloader</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> package:</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker_client.describe_model_package(</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>        ModelPackageName<span class="op">=</span>package[<span class="st">"ModelPackageArn"</span>],</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    model_data <span class="op">=</span> response[<span class="st">"InferenceSpecification"</span>][<span class="st">"Containers"</span>][<span class="dv">0</span>][<span class="st">"ModelDataUrl"</span>]</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    S3Downloader.download(model_data, (CODE_FOLDER <span class="op">/</span> <span class="st">"serving"</span>).as_posix())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---creating-the-serving-script" class="level3">
<h3 class="anchored" data-anchor-id="step-3---creating-the-serving-script">Step 3 - Creating the Serving Script</h3>
<p>Let’s now write a simple Flask script to serve the model.</p>
<p>When this application receives the first request, it will unpack and load the model into memory. From there, it will use the model to make predictions on the incoming requests.</p>
<div id="c79a0e74" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="67">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1"></a><span class="im">import</span> tarfile</span>
<span id="cb73-2"><a href="#cb73-2"></a><span class="im">import</span> tempfile</span>
<span id="cb73-3"><a href="#cb73-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb73-4"><a href="#cb73-4"></a></span>
<span id="cb73-5"><a href="#cb73-5"></a><span class="im">from</span> flask <span class="im">import</span> Flask, request, jsonify</span>
<span id="cb73-6"><a href="#cb73-6"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb73-7"><a href="#cb73-7"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb73-8"><a href="#cb73-8"></a></span>
<span id="cb73-9"><a href="#cb73-9"></a></span>
<span id="cb73-10"><a href="#cb73-10"></a>MODEL_PATH <span class="op">=</span> Path(<span class="va">__file__</span>).parent</span>
<span id="cb73-11"><a href="#cb73-11"></a></span>
<span id="cb73-12"><a href="#cb73-12"></a></span>
<span id="cb73-13"><a href="#cb73-13"></a><span class="kw">class</span> Model:</span>
<span id="cb73-14"><a href="#cb73-14"></a>    model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb73-15"><a href="#cb73-15"></a></span>
<span id="cb73-16"><a href="#cb73-16"></a>    <span class="kw">def</span> load(<span class="va">self</span>):</span>
<span id="cb73-17"><a href="#cb73-17"></a>        <span class="co">"""</span></span>
<span id="cb73-18"><a href="#cb73-18"></a><span class="co">        Extracts the model package and loads the model in memory</span></span>
<span id="cb73-19"><a href="#cb73-19"></a><span class="co">        if it hasn't been loaded yet.</span></span>
<span id="cb73-20"><a href="#cb73-20"></a><span class="co">        """</span></span>
<span id="cb73-21"><a href="#cb73-21"></a>        <span class="co"># We want to load the model only if it is not loaded yet.</span></span>
<span id="cb73-22"><a href="#cb73-22"></a>        <span class="cf">if</span> <span class="kw">not</span> Model.model:</span>
<span id="cb73-23"><a href="#cb73-23"></a>            <span class="co"># Before we load the model, we need to extract it in</span></span>
<span id="cb73-24"><a href="#cb73-24"></a>            <span class="co"># a temporal directory.</span></span>
<span id="cb73-25"><a href="#cb73-25"></a></span>
<span id="cb73-26"><a href="#cb73-26"></a>            <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> directory:</span>
<span id="cb73-27"><a href="#cb73-27"></a>                <span class="cf">with</span> tarfile.<span class="bu">open</span>(MODEL_PATH <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb73-28"><a href="#cb73-28"></a>                    tar.extractall(path<span class="op">=</span>directory)</span>
<span id="cb73-29"><a href="#cb73-29"></a></span>
<span id="cb73-30"><a href="#cb73-30"></a>                Model.model <span class="op">=</span> keras.models.load_model(Path(directory) <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb73-31"><a href="#cb73-31"></a></span>
<span id="cb73-32"><a href="#cb73-32"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, data):</span>
<span id="cb73-33"><a href="#cb73-33"></a>        <span class="co">"""</span></span>
<span id="cb73-34"><a href="#cb73-34"></a><span class="co">        Generates predictions for the supplied data.</span></span>
<span id="cb73-35"><a href="#cb73-35"></a><span class="co">        """</span></span>
<span id="cb73-36"><a href="#cb73-36"></a>        <span class="va">self</span>.load()</span>
<span id="cb73-37"><a href="#cb73-37"></a>        <span class="cf">return</span> Model.model.predict(data)</span>
<span id="cb73-38"><a href="#cb73-38"></a></span>
<span id="cb73-39"><a href="#cb73-39"></a></span>
<span id="cb73-40"><a href="#cb73-40"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb73-41"><a href="#cb73-41"></a>model <span class="op">=</span> Model()</span>
<span id="cb73-42"><a href="#cb73-42"></a></span>
<span id="cb73-43"><a href="#cb73-43"></a></span>
<span id="cb73-44"><a href="#cb73-44"></a><span class="at">@app.route</span>(<span class="st">"/predict/"</span>, methods<span class="op">=</span>[<span class="st">"POST"</span>])</span>
<span id="cb73-45"><a href="#cb73-45"></a><span class="kw">def</span> predict():</span>
<span id="cb73-46"><a href="#cb73-46"></a>    data <span class="op">=</span> request.data.decode(<span class="st">"utf-8"</span>)</span>
<span id="cb73-47"><a href="#cb73-47"></a></span>
<span id="cb73-48"><a href="#cb73-48"></a>    data <span class="op">=</span> np.array(data.split(<span class="st">","</span>)).astype(np.float32)</span>
<span id="cb73-49"><a href="#cb73-49"></a>    data <span class="op">=</span> np.expand_dims(data, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb73-50"><a href="#cb73-50"></a></span>
<span id="cb73-51"><a href="#cb73-51"></a>    predictions <span class="op">=</span> model.predict(data<span class="op">=</span>[data])</span>
<span id="cb73-52"><a href="#cb73-52"></a></span>
<span id="cb73-53"><a href="#cb73-53"></a>    prediction <span class="op">=</span> <span class="bu">int</span>(np.argmax(predictions[<span class="dv">0</span>], axis<span class="op">=-</span><span class="dv">1</span>))</span>
<span id="cb73-54"><a href="#cb73-54"></a>    confidence <span class="op">=</span> <span class="bu">float</span>(predictions[<span class="dv">0</span>][prediction])</span>
<span id="cb73-55"><a href="#cb73-55"></a></span>
<span id="cb73-56"><a href="#cb73-56"></a>    <span class="cf">return</span> jsonify({<span class="st">"prediction"</span>: prediction, <span class="st">"confidence"</span>: confidence})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="step-4---running-the-flask-application" class="level3">
<h3 class="anchored" data-anchor-id="step-4---running-the-flask-application">Step 4 - Running the Flask Application</h3>
<p>We can now run the Flask application to serve the model from a terminal using the following command:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> flask <span class="at">--app</span> program/code/serving/app.py <span class="at">--debug</span> run <span class="at">--host</span><span class="op">=</span>0.0.0.0 <span class="at">--port</span><span class="op">=</span>4242</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After the server is running, you can send a POST request to the server to get a prediction. Here is an example using the <code>curl</code> command:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> curl <span class="at">--location</span> <span class="at">--request</span> POST <span class="st">'http://localhost:4242/predict'</span> <span class="dt">\</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--header</span> <span class="st">'Content-Type: text/plain'</span> <span class="dt">\</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--data-raw</span> <span class="st">'0.6569590202313976, -1.0813829646495108, 1.2097102831892812, 0.9226343641317372, 1.0, 0.0, 0.0'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="session-11---deploying-the-model" class="level2">
<h2 class="anchored" data-anchor-id="session-11---deploying-the-model">Session 11 - Deploying the Model</h2>
<p>This session deploys the model from the Model Registry to an endpoint. We’ll do it manually, using the SageMaker SDK. Check <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/using_tf.html#deploy-to-a-sagemaker-endpoint">Deploy to a SageMaker Endpoint</a> for more information about deploying a model to an endpoint.</p>
<p><a href="images/deploying-model.png" target="_blank"> <img src="images/deploying-model.png" alt="High-level overview of deploying a model to a SageMaker endpoint" style="max-width: 740px;"></a></p>
<section id="step-1---configuring-the-endpoint-name" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-the-endpoint-name">Step 1 - Configuring the Endpoint Name</h3>
<p>Let’s start by defining the name of the endpoint where we’ll deploy the model:</p>
<div id="befd5ad3" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.predictor <span class="im">import</span> Predictor</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>ENDPOINT <span class="op">=</span> <span class="st">"penguins-endpoint"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---creating-a-model-package" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-a-model-package">Step 2 - Creating a Model Package</h3>
<p>To deploy a model using the SageMaker’s Python SDK, we need to create a <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model.html#sagemaker.model.ModelPackage">Model Package</a> using the ARN of the model from the Model Registry. Remember we got the ARN of the latest approved model in the previous section.</p>
<div id="dee516e9" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker <span class="im">import</span> ModelPackage</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> package:</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    model_package <span class="op">=</span> ModelPackage(</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>        model_package_arn<span class="op">=</span>package[<span class="st">"ModelPackageArn"</span>],</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(package[<span class="st">"ModelPackageArn"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>arn:aws:sagemaker:us-east-1:325223348818:model-package/basic-penguins/6</code></pre>
</div>
</div>
</section>
<section id="step-3---deploying-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-3---deploying-the-model">Step 3 - Deploying the Model</h3>
<p>Let’s now deploy the model to an endpoint.</p>
<div id="7c8852d5-818a-406c-944d-30bf6de90288" class="cell" data-tags="[]" data-execution_count="70">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>model_package.deploy(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    initial_instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---testing-the-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="step-4---testing-the-endpoint">Step 4 - Testing the Endpoint</h3>
<p>After deploying the model, we can test the endpoint to make sure it works.</p>
<p>Each line of the payload we’ll send to the endpoint contains the information of a penguin. Notice the model expects data that’s already transformed. We can’t provide the original data from our dataset because the model we registered will not work with it.</p>
<p>The endpoint will return the predictions for each of these lines.</p>
<div id="ba7da291" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="st">0.6569590202313976,-1.0813829646495108,1.2097102831892812,0.9226343641317372,1.0,0.0,0.0</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="st">-0.7751048801481084,0.8822689351285553,-1.2168066120762704,0.9226343641317372,0.0,1.0,0.0</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="st">-0.837387834894918,0.3386660813829646,-0.26237731892812,-1.92351941317372,0.0,0.0,1.0</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s send the payload to the endpoint and print its response:</p>
<div id="0817a25e-8224-4911-830b-d659e7458b4a" class="cell" data-tags="[]" data-execution_count="72">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(endpoint_name<span class="op">=</span>ENDPOINT)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(payload, initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Species: </span><span class="sc">{</span>np<span class="sc">.</span>argmax(response[<span class="st">'predictions'</span>], axis<span class="op">=</span><span class="dv">1</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
</section>
</section>
<section id="session-12---deploying-from-the-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="session-12---deploying-from-the-pipeline">Session 12 - Deploying From the Pipeline</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a step to automatically deploy the model to an endpoint.</p>
<p>We’ll use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-lambda">Lambda Step</a> to create an endpoint and deploy the model.</p>
<p>Here’s a high-level overview of the Deploy Step:</p>
<p><a href="images/deploy-step.png" target="_blank"> <img src="images/deploy-step.png" alt="High-level overview of the Deploy Step" style="max-width: 740px;"></a></p>
<section id="step-1---configuring-data-capture-settings" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-data-capture-settings">Step 1 - Configuring Data Capture Settings</h3>
<p>We want to enable <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-data-capture.html">Data Capture</a> as part of the endpoint configuration. With Data Capture we can record the inputs and outputs of the endpoint to use them later for monitoring the model. We need to configuration settings to enable Data Capture:</p>
<ul>
<li><code>DATA_CAPTURE_PERCENTAGE</code>: Represents the percentage of traffic that we want to capture.</li>
<li><code>DATA_CAPTURE_DESTINATION</code>: Specifies the S3 location where we want to store the captured data.</li>
</ul>
<div id="e1dbadb0" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>DATA_CAPTURE_PERCENTAGE <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>DATA_CAPTURE_DESTINATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/data-capture"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---setting-up-the-lambda-function" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-the-lambda-function">Step 2 - Setting up the Lambda Function</h3>
<p>Let’s start by writing a Lambda function that takes the model information and deploys it to an endpoint.</p>
<p>There are three components that make up a SageMaker endpoint:</p>
<p><a href="images/endpoint.png" target="_blank"> <img src="images/endpoint.png" alt="An overview of the three components of an Endpoint" style="max-width: 740px;"></a></p>
<p>We’ll store the code of the function in a folder called <code>lambda</code>:</p>
<div id="ac7630ca" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"lambda"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now write the code of the function:</p>
<div id="44b651af" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="75">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>lambda.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1"></a><span class="im">import</span> os</span>
<span id="cb85-2"><a href="#cb85-2"></a><span class="im">import</span> json</span>
<span id="cb85-3"><a href="#cb85-3"></a><span class="im">import</span> boto3</span>
<span id="cb85-4"><a href="#cb85-4"></a><span class="im">import</span> time</span>
<span id="cb85-5"><a href="#cb85-5"></a></span>
<span id="cb85-6"><a href="#cb85-6"></a>sagemaker <span class="op">=</span> boto3.client(<span class="st">"sagemaker"</span>)</span>
<span id="cb85-7"><a href="#cb85-7"></a></span>
<span id="cb85-8"><a href="#cb85-8"></a></span>
<span id="cb85-9"><a href="#cb85-9"></a><span class="kw">def</span> lambda_handler(event, context):</span>
<span id="cb85-10"><a href="#cb85-10"></a>    <span class="co"># If we are calling this function from EventBridge,</span></span>
<span id="cb85-11"><a href="#cb85-11"></a>    <span class="co"># we need to extract the model package ARN and the</span></span>
<span id="cb85-12"><a href="#cb85-12"></a>    <span class="co"># approval status from the event details. If we are</span></span>
<span id="cb85-13"><a href="#cb85-13"></a>    <span class="co"># calling this function from the pipeline, we can</span></span>
<span id="cb85-14"><a href="#cb85-14"></a>    <span class="co"># assume the model is approved and we can get the</span></span>
<span id="cb85-15"><a href="#cb85-15"></a>    <span class="co"># model package ARN as a direct parameter.</span></span>
<span id="cb85-16"><a href="#cb85-16"></a>    <span class="cf">if</span> <span class="st">"detail"</span> <span class="kw">in</span> event:</span>
<span id="cb85-17"><a href="#cb85-17"></a>        model_package_arn <span class="op">=</span> event[<span class="st">"detail"</span>][<span class="st">"ModelPackageArn"</span>]</span>
<span id="cb85-18"><a href="#cb85-18"></a>        approval_status <span class="op">=</span> event[<span class="st">"detail"</span>][<span class="st">"ModelApprovalStatus"</span>]</span>
<span id="cb85-19"><a href="#cb85-19"></a>    <span class="cf">else</span>:</span>
<span id="cb85-20"><a href="#cb85-20"></a>        model_package_arn <span class="op">=</span> event[<span class="st">"model_package_arn"</span>]</span>
<span id="cb85-21"><a href="#cb85-21"></a>        approval_status <span class="op">=</span> <span class="st">"Approved"</span></span>
<span id="cb85-22"><a href="#cb85-22"></a></span>
<span id="cb85-23"><a href="#cb85-23"></a>    <span class="bu">print</span>(<span class="ss">f"Model: </span><span class="sc">{</span>model_package_arn<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-24"><a href="#cb85-24"></a>    <span class="bu">print</span>(<span class="ss">f"Approval status: </span><span class="sc">{</span>approval_status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb85-25"><a href="#cb85-25"></a></span>
<span id="cb85-26"><a href="#cb85-26"></a>    <span class="cf">if</span> approval_status <span class="op">!=</span> <span class="st">"Approved"</span>:</span>
<span id="cb85-27"><a href="#cb85-27"></a>        response <span class="op">=</span> {</span>
<span id="cb85-28"><a href="#cb85-28"></a>            <span class="st">"message"</span>: <span class="st">"Skipping deployment."</span>,</span>
<span id="cb85-29"><a href="#cb85-29"></a>            <span class="st">"approval_status"</span>: approval_status,</span>
<span id="cb85-30"><a href="#cb85-30"></a>        }</span>
<span id="cb85-31"><a href="#cb85-31"></a></span>
<span id="cb85-32"><a href="#cb85-32"></a>        <span class="bu">print</span>(response)</span>
<span id="cb85-33"><a href="#cb85-33"></a>        <span class="cf">return</span> {<span class="st">"statusCode"</span>: <span class="dv">200</span>, <span class="st">"body"</span>: json.dumps(response)}</span>
<span id="cb85-34"><a href="#cb85-34"></a></span>
<span id="cb85-35"><a href="#cb85-35"></a>    endpoint_name <span class="op">=</span> os.environ[<span class="st">"ENDPOINT"</span>]</span>
<span id="cb85-36"><a href="#cb85-36"></a>    data_capture_percentage <span class="op">=</span> <span class="bu">int</span>(os.environ[<span class="st">"DATA_CAPTURE_PERCENTAGE"</span>])</span>
<span id="cb85-37"><a href="#cb85-37"></a>    data_capture_destination <span class="op">=</span> os.environ[<span class="st">"DATA_CAPTURE_DESTINATION"</span>]</span>
<span id="cb85-38"><a href="#cb85-38"></a>    role <span class="op">=</span> os.environ[<span class="st">"ROLE"</span>]</span>
<span id="cb85-39"><a href="#cb85-39"></a></span>
<span id="cb85-40"><a href="#cb85-40"></a>    timestamp <span class="op">=</span> time.strftime(<span class="st">"%m</span><span class="sc">%d</span><span class="st">%H%M%S"</span>, time.localtime())</span>
<span id="cb85-41"><a href="#cb85-41"></a>    model_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>endpoint_name<span class="sc">}</span><span class="ss">-model-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb85-42"><a href="#cb85-42"></a>    endpoint_config_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>endpoint_name<span class="sc">}</span><span class="ss">-config-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb85-43"><a href="#cb85-43"></a></span>
<span id="cb85-44"><a href="#cb85-44"></a>    sagemaker.create_model(</span>
<span id="cb85-45"><a href="#cb85-45"></a>        ModelName<span class="op">=</span>model_name,</span>
<span id="cb85-46"><a href="#cb85-46"></a>        ExecutionRoleArn<span class="op">=</span>role,</span>
<span id="cb85-47"><a href="#cb85-47"></a>        Containers<span class="op">=</span>[{<span class="st">"ModelPackageName"</span>: model_package_arn}],</span>
<span id="cb85-48"><a href="#cb85-48"></a>    )</span>
<span id="cb85-49"><a href="#cb85-49"></a></span>
<span id="cb85-50"><a href="#cb85-50"></a>    sagemaker.create_endpoint_config(</span>
<span id="cb85-51"><a href="#cb85-51"></a>        EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb85-52"><a href="#cb85-52"></a>        ProductionVariants<span class="op">=</span>[</span>
<span id="cb85-53"><a href="#cb85-53"></a>            {</span>
<span id="cb85-54"><a href="#cb85-54"></a>                <span class="st">"ModelName"</span>: model_name,</span>
<span id="cb85-55"><a href="#cb85-55"></a>                <span class="st">"InstanceType"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb85-56"><a href="#cb85-56"></a>                <span class="st">"InitialVariantWeight"</span>: <span class="dv">1</span>,</span>
<span id="cb85-57"><a href="#cb85-57"></a>                <span class="st">"InitialInstanceCount"</span>: <span class="dv">1</span>,</span>
<span id="cb85-58"><a href="#cb85-58"></a>                <span class="st">"VariantName"</span>: <span class="st">"AllTraffic"</span>,</span>
<span id="cb85-59"><a href="#cb85-59"></a>            }</span>
<span id="cb85-60"><a href="#cb85-60"></a>        ],</span>
<span id="cb85-61"><a href="#cb85-61"></a>        <span class="co"># We can enable Data Capture to record the inputs and outputs</span></span>
<span id="cb85-62"><a href="#cb85-62"></a>        <span class="co"># of the endpoint to use them later for monitoring the model.</span></span>
<span id="cb85-63"><a href="#cb85-63"></a>        DataCaptureConfig<span class="op">=</span>{</span>
<span id="cb85-64"><a href="#cb85-64"></a>            <span class="st">"EnableCapture"</span>: <span class="va">True</span>,</span>
<span id="cb85-65"><a href="#cb85-65"></a>            <span class="st">"InitialSamplingPercentage"</span>: data_capture_percentage,</span>
<span id="cb85-66"><a href="#cb85-66"></a>            <span class="st">"DestinationS3Uri"</span>: data_capture_destination,</span>
<span id="cb85-67"><a href="#cb85-67"></a>            <span class="st">"CaptureOptions"</span>: [</span>
<span id="cb85-68"><a href="#cb85-68"></a>                {<span class="st">"CaptureMode"</span>: <span class="st">"Input"</span>},</span>
<span id="cb85-69"><a href="#cb85-69"></a>                {<span class="st">"CaptureMode"</span>: <span class="st">"Output"</span>},</span>
<span id="cb85-70"><a href="#cb85-70"></a>            ],</span>
<span id="cb85-71"><a href="#cb85-71"></a>            <span class="st">"CaptureContentTypeHeader"</span>: {</span>
<span id="cb85-72"><a href="#cb85-72"></a>                <span class="st">"CsvContentTypes"</span>: [<span class="st">"text/csv"</span>, <span class="st">"application/octect-stream"</span>],</span>
<span id="cb85-73"><a href="#cb85-73"></a>                <span class="st">"JsonContentTypes"</span>: [<span class="st">"application/json"</span>, <span class="st">"application/octect-stream"</span>],</span>
<span id="cb85-74"><a href="#cb85-74"></a>            },</span>
<span id="cb85-75"><a href="#cb85-75"></a>        },</span>
<span id="cb85-76"><a href="#cb85-76"></a>    )</span>
<span id="cb85-77"><a href="#cb85-77"></a></span>
<span id="cb85-78"><a href="#cb85-78"></a>    response <span class="op">=</span> sagemaker.list_endpoints(NameContains<span class="op">=</span>endpoint_name, MaxResults<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb85-79"><a href="#cb85-79"></a></span>
<span id="cb85-80"><a href="#cb85-80"></a>    <span class="cf">if</span> <span class="bu">len</span>(response[<span class="st">"Endpoints"</span>]) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb85-81"><a href="#cb85-81"></a>        <span class="co"># If the endpoint doesn't exist, let's create it.</span></span>
<span id="cb85-82"><a href="#cb85-82"></a>        sagemaker.create_endpoint(</span>
<span id="cb85-83"><a href="#cb85-83"></a>            EndpointName<span class="op">=</span>endpoint_name,</span>
<span id="cb85-84"><a href="#cb85-84"></a>            EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb85-85"><a href="#cb85-85"></a>        )</span>
<span id="cb85-86"><a href="#cb85-86"></a>    <span class="cf">else</span>:</span>
<span id="cb85-87"><a href="#cb85-87"></a>        <span class="co"># If the endpoint already exists, let's update it with the</span></span>
<span id="cb85-88"><a href="#cb85-88"></a>        <span class="co"># new configuration.</span></span>
<span id="cb85-89"><a href="#cb85-89"></a>        sagemaker.update_endpoint(</span>
<span id="cb85-90"><a href="#cb85-90"></a>            EndpointName<span class="op">=</span>endpoint_name,</span>
<span id="cb85-91"><a href="#cb85-91"></a>            EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb85-92"><a href="#cb85-92"></a>        )</span>
<span id="cb85-93"><a href="#cb85-93"></a></span>
<span id="cb85-94"><a href="#cb85-94"></a>    <span class="cf">return</span> {<span class="st">"statusCode"</span>: <span class="dv">200</span>, <span class="st">"body"</span>: json.dumps(<span class="st">"Endpoint deployed successfully"</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="step-3---setting-up-lambda-permissions" class="level3">
<h3 class="anchored" data-anchor-id="step-3---setting-up-lambda-permissions">Step 3 - Setting up Lambda Permissions</h3>
<p>We need to ensure our Lambda function has permission to interact with SageMaker, so let’s create a new role with the appropriate permissions.</p>
<div id="200d0370" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="76">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>lambda_role_name <span class="op">=</span> <span class="st">"lambda-deployment-role"</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>lambda_role_arn <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> iam_client.create_role(</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span>lambda_role_name,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        AssumeRolePolicyDocument<span class="op">=</span>json.dumps(</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Version"</span>: <span class="st">"2012-10-17"</span>,</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Statement"</span>: [</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Effect"</span>: <span class="st">"Allow"</span>,</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Principal"</span>: {</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Service"</span>: [<span class="st">"lambda.amazonaws.com"</span>, <span class="st">"events.amazonaws.com"</span>],</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Action"</span>: <span class="st">"sts:AssumeRole"</span>,</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>                    },</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>                ],</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>        Description<span class="op">=</span><span class="st">"Lambda Endpoint Deployment"</span>,</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    lambda_role_arn <span class="op">=</span> response[<span class="st">"Role"</span>][<span class="st">"Arn"</span>]</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    iam_client.attach_role_policy(</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>        PolicyArn<span class="op">=</span><span class="st">"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>,</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span>lambda_role_name,</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    iam_client.attach_role_policy(</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>        PolicyArn<span class="op">=</span><span class="st">"arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"</span>,</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>        RoleName<span class="op">=</span>lambda_role_name,</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Role "</span><span class="sc">{</span>lambda_role_name<span class="sc">}</span><span class="ss">" created with ARN "</span><span class="sc">{</span>lambda_role_arn<span class="sc">}</span><span class="ss">".'</span>)</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> iam_client.exceptions.EntityAlreadyExistsException:</span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> iam_client.get_role(RoleName<span class="op">=</span>lambda_role_name)</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>    lambda_role_arn <span class="op">=</span> response[<span class="st">"Role"</span>][<span class="st">"Arn"</span>]</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Role "</span><span class="sc">{</span>lambda_role_name<span class="sc">}</span><span class="ss">" already exists with ARN "</span><span class="sc">{</span>lambda_role_arn<span class="sc">}</span><span class="ss">".'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---creating-the-lambda-function" class="level3">
<h3 class="anchored" data-anchor-id="step-4---creating-the-lambda-function">Step 4 - Creating the Lambda Function</h3>
<p>Let’s now create the Lambda function in AWS. We’ll pass the configuration settings we defined before as environment variables to the Lambda function.</p>
<div id="4a742974" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="77">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.lambda_helper <span class="im">import</span> Lambda</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>deploy_lambda_fn <span class="op">=</span> Lambda(</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    function_name<span class="op">=</span><span class="st">"deployment_fn"</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    execution_role_arn<span class="op">=</span>lambda_role_arn,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    script<span class="op">=</span>(CODE_FOLDER <span class="op">/</span> <span class="st">"lambda"</span> <span class="op">/</span> <span class="st">"lambda.py"</span>).as_posix(),</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">=</span><span class="st">"lambda.lambda_handler"</span>,</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    timeout<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    session<span class="op">=</span>sagemaker_session,</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    runtime<span class="op">=</span><span class="st">"python3.11"</span>,</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    environment<span class="op">=</span>{</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Variables"</span>: {</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ENDPOINT"</span>: ENDPOINT,</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"DATA_CAPTURE_DESTINATION"</span>: DATA_CAPTURE_DESTINATION,</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"DATA_CAPTURE_PERCENTAGE"</span>: <span class="bu">str</span>(DATA_CAPTURE_PERCENTAGE),</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ROLE"</span>: role,</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>deploy_lambda_fn_response <span class="op">=</span> deploy_lambda_fn.upsert()</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>deploy_lambda_fn_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---setting-up-the-lambda-step" class="level3">
<h3 class="anchored" data-anchor-id="step-5---setting-up-the-lambda-step">Step 5 - Setting up the Lambda Step</h3>
<p>We can now define the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.lambda_step.LambdaStep">Lambda Step</a> that will run the function to deploy the model. We’ll do this in a function that we can reuse later.</p>
<p>This step will send the model package ARN we want to deploy to the Lambda function as an input parameter.</p>
<div id="1f86b997" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.lambda_step <span class="im">import</span> LambdaStep</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_deployment_step(register_model_step):</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Deploy Step using the supplied parameters."""</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> LambdaStep(</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"deploy"</span>,</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>        lambda_func<span class="op">=</span>deploy_lambda_fn,</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model_package_arn"</span>: register_model_step.properties.ModelPackageArn,</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>deploy_step <span class="op">=</span> create_deployment_step(register_model_step)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---modifying-the-condition-step" class="level3">
<h3 class="anchored" data-anchor-id="step-6---modifying-the-condition-step">Step 6 - Modifying the Condition Step</h3>
<p>We need to modify the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-condition">Condition Step</a> to include the new deployment step. If the condition succeeds, we will register and deploy the model.</p>
<div id="5cc3e44b" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step, deploy_step],</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-7---creating-the-pipeline">Step 7 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="3d86577a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="80">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>session12_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session12-pipeline"</span>,</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>session12_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-8---testing-the-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="step-8---testing-the-endpoint">Step 8 - Testing the Endpoint</h3>
<p>Let’s test the endpoint to make sure it works.</p>
<p>The <code>wait_for_endpoint</code> function will wait until the endpoint is ready to receive requests.</p>
<div id="1dd5bb33" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wait_for_endpoint():</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Wait for the endpoint to come in service."""</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    waiter <span class="op">=</span> sagemaker_client.get_waiter(<span class="st">"endpoint_in_service"</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    waiter.wait(EndpointName<span class="op">=</span>ENDPOINT, WaiterConfig<span class="op">=</span>{<span class="st">"Delay"</span>: <span class="dv">10</span>, <span class="st">"MaxAttempts"</span>: <span class="dv">30</span>})</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> <span class="st">"0.6569590202313976,-1.0813829646495108,1.2097102831892812,0.9226343641317372,1.0,0.0,0.0"</span>  <span class="co"># noqa: E501</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    wait_for_endpoint()</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    predictor <span class="op">=</span> Predictor(endpoint_name<span class="op">=</span>ENDPOINT)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(payload, initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Waiter EndpointInService failed: Waiter encountered a terminal failure state: Matched expected service error code: ValidationException</code></pre>
</div>
</div>
</section>
</section>
<section id="session-13---deploying-from-an-event" class="level2">
<h2 class="anchored" data-anchor-id="session-13---deploying-from-an-event">Session 13 - Deploying From an Event</h2>
<p>This session modifies the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> to register the model with <code>PendingManualApproval</code> status and deploys it whenever its status changes to <code>Approved</code>.</p>
<p><a href="images/deploying-from-event.png" target="_blank"> <img src="images/deploying-from-event.png" alt="High-level overview of deploying a model using EventBridge" style="max-width: 740px;"></a></p>
<p>We will use <a href="https://aws.amazon.com/pm/eventbridge/">Amazon EventBridge</a> to trigger a Lambda function that will deploy the model whenever its status changes from “PendingManualApproval” to “Approved.”</p>
<section id="step-1---configuring-the-model-package-group-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-the-model-package-group-1">Step 1 - Configuring the Model Package Group</h3>
<p>We need to define the name of a new group where we’ll register models with <code>PendingManualApproval</code> status.</p>
<div id="96751e71" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>PENDING_MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"pending-penguins"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---setting-up-eventbridge" class="level3">
<h3 class="anchored" data-anchor-id="step-2---setting-up-eventbridge">Step 2 - Setting Up EventBridge</h3>
<p>We can now create an EventBridge rule that triggers the deployment process whenever a model approval status becomes <code>Approved</code>. To do this, let’s define the event pattern that will trigger the deployment process. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/automating-sagemaker-with-eventbridge.html#eventbridge-model-package">Model package state change</a> for more information.</p>
<div id="1ee4b9d5" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>event_pattern <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="ss">  "source": ["aws.sagemaker"],</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="ss">  "detail-type": ["SageMaker Model Package State Change"],</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="ss">  "detail": </span><span class="ch">{{</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="ss">    "ModelPackageGroupName": ["</span><span class="sc">{</span>PENDING_MODEL_PACKAGE_GROUP<span class="sc">}</span><span class="ss">"],</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="ss">    "ModelApprovalStatus": ["Approved"]</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="ch">}}</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the EventBridge rule:</p>
<div id="63f294bc" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>rule_name <span class="op">=</span> <span class="st">"PendingModelApprovedRule"</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>events_client <span class="op">=</span> boto3.client(<span class="st">"events"</span>)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>rule_response <span class="op">=</span> events_client.put_rule(</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    Name<span class="op">=</span>rule_name,</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    EventPattern<span class="op">=</span>event_pattern,</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    State<span class="op">=</span><span class="st">"ENABLED"</span>,</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    RoleArn<span class="op">=</span>role,</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to define the target of the rule. The target will trigger whenever the rule matches an event. In this case, we want to trigger the Lambda function we created before:</p>
<div id="9985bd49" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> events_client.put_targets(</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    Rule<span class="op">=</span>rule_name,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    Targets<span class="op">=</span>[</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Id"</span>: <span class="st">"1"</span>,</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Arn"</span>: deploy_lambda_fn_response[<span class="st">"FunctionArn"</span>],</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---configuring-the-lambda-permissions" class="level3">
<h3 class="anchored" data-anchor-id="step-3---configuring-the-lambda-permissions">Step 3 - Configuring the Lambda Permissions</h3>
<p>Finally, we need to give the Lambda function permissions to be triggered by the EventBridge rule:</p>
<div id="32302639" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>lambda_function_name <span class="op">=</span> deploy_lambda_fn_response[<span class="st">"FunctionName"</span>]</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>lambda_client <span class="op">=</span> boto3.client(<span class="st">"lambda"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> lambda_client.add_permission(</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>        Action<span class="op">=</span><span class="st">"lambda:InvokeFunction"</span>,</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>        FunctionName<span class="op">=</span>lambda_function_name,</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>        Principal<span class="op">=</span><span class="st">"events.amazonaws.com"</span>,</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>        SourceArn<span class="op">=</span>rule_response[<span class="st">"RuleArn"</span>],</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>        StatementId<span class="op">=</span><span class="st">"EventBridge"</span>,</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> lambda_client.exceptions.ResourceConflictException:</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Function "</span><span class="sc">{</span>lambda_function_name<span class="sc">}</span><span class="ss">" already has the specified permission.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function "deployment_fn" already has the specified permission.</code></pre>
</div>
</div>
</section>
<section id="step-4---registering-the-model-1" class="level3">
<h3 class="anchored" data-anchor-id="step-4---registering-the-model-1">Step 4 - Registering the Model</h3>
<p>We need to modify the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-model">Model Step</a> to register the model using <code>PendingManualApproval</code> status.</p>
<div id="18adeb93" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="87">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> create_registration_step(</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    tensorflow_model,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    PENDING_MODEL_PACKAGE_GROUP,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    approval_status<span class="op">=</span><span class="st">"PendingManualApproval"</span>,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---modifying-the-condition-step" class="level3">
<h3 class="anchored" data-anchor-id="step-5---modifying-the-condition-step">Step 5 - Modifying the Condition Step</h3>
<p>Let’s modify the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-condition">Condition Step</a> to include the new registration step. If the condition succeeds, we will register the model with <code>PendingManualApproval</code> status.</p>
<div id="fafb5514" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step],</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-6---creating-the-pipeline">Step 6 - Creating the Pipeline</h3>
<p>Let’s define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="b95c22b2" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="89">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>session13_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session13-pipeline"</span>,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>session13_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="session-14---building-an-inference-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="session-14---building-an-inference-pipeline">Session 14 - Building an Inference Pipeline</h2>
<p>This session creates an inference pipeline to control the data that goes in and comes out of the endpoint.</p>
<p>Deploying the model we trained directly to an endpoint doesn’t lets us control the data that goes in and comes out of the endpoint. The TensorFlow model we trained requires transformed data, which makes it useless to other applications:</p>
<p><a href="images/basic-model.png" target="_blank"> <img src="images/basic-model.png" alt="Basic Model" style="max-width: 740px;"></a></p>
<p>To fix this, we can create an Inference Pipeline using SageMaker to control the data that goes in and comes out of the endpoint.</p>
<p>Our inference pipeline will have three components:</p>
<ol type="1">
<li>A preprocessing component that will transform the input data into the format the model expects.</li>
<li>The TensorFlow model.</li>
<li>A postprocessing component that will transform the output of the model into a human-readable format.</li>
</ol>
<p><a href="images/inference-pipeline.png" target="_blank"> <img src="images/inference-pipeline.png" alt="Inference pipeline" style="max-width: 740px;"></a></p>
<p>We want our endpoint to handle unprocessed data in CSV and JSON format and return the penguin’s species. Here is an example of the payload input we want the endpoint to support:</p>
<pre class="{json}"><code>{
    "island": "Biscoe",
    "culmen_length_mm": 48.6,
    "culmen_depth_mm": 16.0,
    "flipper_length_mm": 230.0,
    "body_mass_g": 5800.0
}</code></pre>
<p>And here is an example of the output we’d like to get from the endpoint:</p>
<pre class="{json}"><code>{
    "prediction": "Adelie",
    "confidence": 0.802672
}</code></pre>
<section id="step-1---creating-the-preprocessing-script-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-preprocessing-script-1">Step 1 - Creating the Preprocessing Script</h3>
<p>The first component of our inference pipeline will transform the input data into the format the model expects.</p>
<p>We’ll use the Scikit-Learn transformer we saved when we split and transformed the data. To deploy this component as part of an inference pipeline, we need to write a script that loads the transformer, uses it to modify the input data, and returns the output in the format the TensorFlow model expects.</p>
<p>We’ll store the scripts of every component in a folder called <code>pipeline</code> and add it to the system path so we can later import it as a module.</p>
<div id="a1f25973" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"pipeline"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the script for the preprocessing component:</p>
<div id="c480ae02" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="91">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>preprocessing_component.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1"></a><span class="im">import</span> os</span>
<span id="cb105-2"><a href="#cb105-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb105-3"><a href="#cb105-3"></a><span class="im">import</span> json</span>
<span id="cb105-4"><a href="#cb105-4"></a><span class="im">import</span> joblib</span>
<span id="cb105-5"><a href="#cb105-5"></a></span>
<span id="cb105-6"><a href="#cb105-6"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb105-7"><a href="#cb105-7"></a></span>
<span id="cb105-8"><a href="#cb105-8"></a><span class="cf">try</span>:</span>
<span id="cb105-9"><a href="#cb105-9"></a>    <span class="im">from</span> sagemaker_containers.beta.framework <span class="im">import</span> worker</span>
<span id="cb105-10"><a href="#cb105-10"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb105-11"><a href="#cb105-11"></a>    <span class="co"># We don't have access to the `worker` package when testing locally.</span></span>
<span id="cb105-12"><a href="#cb105-12"></a>    <span class="co"># We'll set it to None so we can change the way functions create</span></span>
<span id="cb105-13"><a href="#cb105-13"></a>    <span class="co"># a response.</span></span>
<span id="cb105-14"><a href="#cb105-14"></a>    worker <span class="op">=</span> <span class="va">None</span></span>
<span id="cb105-15"><a href="#cb105-15"></a></span>
<span id="cb105-16"><a href="#cb105-16"></a></span>
<span id="cb105-17"><a href="#cb105-17"></a>TARGET_COLUMN <span class="op">=</span> <span class="st">"species"</span></span>
<span id="cb105-18"><a href="#cb105-18"></a>FEATURE_COLUMNS <span class="op">=</span> [</span>
<span id="cb105-19"><a href="#cb105-19"></a>    <span class="st">"island"</span>,</span>
<span id="cb105-20"><a href="#cb105-20"></a>    <span class="st">"culmen_length_mm"</span>,</span>
<span id="cb105-21"><a href="#cb105-21"></a>    <span class="st">"culmen_depth_mm"</span>,</span>
<span id="cb105-22"><a href="#cb105-22"></a>    <span class="st">"flipper_length_mm"</span>,</span>
<span id="cb105-23"><a href="#cb105-23"></a>    <span class="st">"body_mass_g"</span>,</span>
<span id="cb105-24"><a href="#cb105-24"></a>    <span class="st">"sex"</span>,</span>
<span id="cb105-25"><a href="#cb105-25"></a>]</span>
<span id="cb105-26"><a href="#cb105-26"></a></span>
<span id="cb105-27"><a href="#cb105-27"></a></span>
<span id="cb105-28"><a href="#cb105-28"></a><span class="kw">def</span> model_fn(model_dir):</span>
<span id="cb105-29"><a href="#cb105-29"></a>    <span class="co">"""</span></span>
<span id="cb105-30"><a href="#cb105-30"></a><span class="co">    Deserializes the model that will be used in this container.</span></span>
<span id="cb105-31"><a href="#cb105-31"></a><span class="co">    """</span></span>
<span id="cb105-32"><a href="#cb105-32"></a></span>
<span id="cb105-33"><a href="#cb105-33"></a>    <span class="cf">return</span> joblib.load(os.path.join(model_dir, <span class="st">"features.joblib"</span>))</span>
<span id="cb105-34"><a href="#cb105-34"></a></span>
<span id="cb105-35"><a href="#cb105-35"></a></span>
<span id="cb105-36"><a href="#cb105-36"></a><span class="kw">def</span> input_fn(input_data, content_type):</span>
<span id="cb105-37"><a href="#cb105-37"></a>    <span class="co">"""</span></span>
<span id="cb105-38"><a href="#cb105-38"></a><span class="co">    Parses the input payload and creates a Pandas DataFrame.</span></span>
<span id="cb105-39"><a href="#cb105-39"></a></span>
<span id="cb105-40"><a href="#cb105-40"></a><span class="co">    This function will check whether the target column is present in the</span></span>
<span id="cb105-41"><a href="#cb105-41"></a><span class="co">    input data and will remove it.</span></span>
<span id="cb105-42"><a href="#cb105-42"></a><span class="co">    """</span></span>
<span id="cb105-43"><a href="#cb105-43"></a></span>
<span id="cb105-44"><a href="#cb105-44"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb105-45"><a href="#cb105-45"></a>        df <span class="op">=</span> pd.read_csv(StringIO(input_data), header<span class="op">=</span><span class="va">None</span>, skipinitialspace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb105-46"><a href="#cb105-46"></a></span>
<span id="cb105-47"><a href="#cb105-47"></a>        <span class="co"># If we find an extra column, it's probably the target</span></span>
<span id="cb105-48"><a href="#cb105-48"></a>        <span class="co"># feature, so let's drop it. We'll assume the target</span></span>
<span id="cb105-49"><a href="#cb105-49"></a>        <span class="co"># is always the first column,</span></span>
<span id="cb105-50"><a href="#cb105-50"></a>        <span class="cf">if</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="bu">len</span>(FEATURE_COLUMNS) <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb105-51"><a href="#cb105-51"></a>            df <span class="op">=</span> df.drop(df.columns[<span class="dv">0</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb105-52"><a href="#cb105-52"></a></span>
<span id="cb105-53"><a href="#cb105-53"></a>        df.columns <span class="op">=</span> FEATURE_COLUMNS</span>
<span id="cb105-54"><a href="#cb105-54"></a>        <span class="cf">return</span> df</span>
<span id="cb105-55"><a href="#cb105-55"></a></span>
<span id="cb105-56"><a href="#cb105-56"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb105-57"><a href="#cb105-57"></a>        df <span class="op">=</span> pd.DataFrame([json.loads(input_data)])</span>
<span id="cb105-58"><a href="#cb105-58"></a></span>
<span id="cb105-59"><a href="#cb105-59"></a>        <span class="cf">if</span> TARGET_COLUMN <span class="kw">in</span> df.columns:</span>
<span id="cb105-60"><a href="#cb105-60"></a>            df <span class="op">=</span> df.drop(TARGET_COLUMN, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb105-61"><a href="#cb105-61"></a></span>
<span id="cb105-62"><a href="#cb105-62"></a>        <span class="cf">return</span> df</span>
<span id="cb105-63"><a href="#cb105-63"></a></span>
<span id="cb105-64"><a href="#cb105-64"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss"> is not supported!"</span>)</span>
<span id="cb105-65"><a href="#cb105-65"></a></span>
<span id="cb105-66"><a href="#cb105-66"></a></span>
<span id="cb105-67"><a href="#cb105-67"></a><span class="kw">def</span> predict_fn(input_data, model):</span>
<span id="cb105-68"><a href="#cb105-68"></a>    <span class="co">"""</span></span>
<span id="cb105-69"><a href="#cb105-69"></a><span class="co">    Preprocess the input using the transformer.</span></span>
<span id="cb105-70"><a href="#cb105-70"></a><span class="co">    """</span></span>
<span id="cb105-71"><a href="#cb105-71"></a></span>
<span id="cb105-72"><a href="#cb105-72"></a>    <span class="cf">try</span>:</span>
<span id="cb105-73"><a href="#cb105-73"></a>        <span class="cf">return</span> model.transform(input_data)</span>
<span id="cb105-74"><a href="#cb105-74"></a>    <span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</span>
<span id="cb105-75"><a href="#cb105-75"></a>        <span class="bu">print</span>(<span class="st">"Error transforming the input data"</span>, e)</span>
<span id="cb105-76"><a href="#cb105-76"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb105-77"><a href="#cb105-77"></a></span>
<span id="cb105-78"><a href="#cb105-78"></a></span>
<span id="cb105-79"><a href="#cb105-79"></a><span class="kw">def</span> output_fn(prediction, accept):</span>
<span id="cb105-80"><a href="#cb105-80"></a>    <span class="co">"""</span></span>
<span id="cb105-81"><a href="#cb105-81"></a><span class="co">    Formats the prediction output to generate a response.</span></span>
<span id="cb105-82"><a href="#cb105-82"></a></span>
<span id="cb105-83"><a href="#cb105-83"></a><span class="co">    The default accept/content-type between containers for serial inference</span></span>
<span id="cb105-84"><a href="#cb105-84"></a><span class="co">    is JSON. Since this model preceeds a TensorFlow model, we want to</span></span>
<span id="cb105-85"><a href="#cb105-85"></a><span class="co">    return a JSON object following TensorFlow's input requirements.</span></span>
<span id="cb105-86"><a href="#cb105-86"></a><span class="co">    """</span></span>
<span id="cb105-87"><a href="#cb105-87"></a></span>
<span id="cb105-88"><a href="#cb105-88"></a>    <span class="cf">if</span> prediction <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb105-89"><a href="#cb105-89"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"There was an error transforming the input data"</span>)</span>
<span id="cb105-90"><a href="#cb105-90"></a></span>
<span id="cb105-91"><a href="#cb105-91"></a>    instances <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> prediction.tolist()]</span>
<span id="cb105-92"><a href="#cb105-92"></a>    response <span class="op">=</span> {<span class="st">"instances"</span>: instances}</span>
<span id="cb105-93"><a href="#cb105-93"></a>    <span class="cf">return</span> (</span>
<span id="cb105-94"><a href="#cb105-94"></a>        worker.Response(json.dumps(response), mimetype<span class="op">=</span>accept)</span>
<span id="cb105-95"><a href="#cb105-95"></a>        <span class="cf">if</span> worker</span>
<span id="cb105-96"><a href="#cb105-96"></a>        <span class="cf">else</span> (response, accept)</span>
<span id="cb105-97"><a href="#cb105-97"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div id="34721e63" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="92">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pipeline.preprocessing_component <span class="im">import</span> input_fn, predict_fn, output_fn, model_fn</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"model.tar.gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>        tar.extractall(path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>)</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory <span class="op">/</span> <span class="st">"model"</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_csv_drops_target_column_if_present():</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="st">    Adelie, Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span> <span class="kw">and</span> <span class="st">"species"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns</span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_json_drops_target_column_if_present():</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.dumps({</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"species"</span>: <span class="st">"Adelie"</span>, </span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Torgersen"</span>,</span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">44.1</span>,</span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.0</span>,</span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">210.0</span>,</span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="fl">4000.0</span>,</span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"application/json"</span>)</span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span> <span class="kw">and</span> <span class="st">"species"</span> <span class="kw">not</span> <span class="kw">in</span> df.columns</span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_csv_works_without_target_column():</span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a><span class="st">    Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_input_json_works_without_target_column():</span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> json.dumps({</span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Torgersen"</span>,</span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">44.1</span>,</span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.0</span>,</span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">210.0</span>,</span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="fl">4000.0</span>,</span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sex"</span>: <span class="st">"MALE"</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"application/json"</span>)</span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(df.columns) <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_raises_exception_if_prediction_is_none():</span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>):</span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a>        output_fn(<span class="va">None</span>, <span class="st">"application/json"</span>)</span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_returns_tensorflow_ready_input():</span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> np.array([</span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a>        [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">0</span>] <span class="op">==</span> {</span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"instances"</span>: [</span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a>            [<span class="op">-</span><span class="fl">1.3944109908736013</span>,<span class="fl">1.15488062669371</span>,<span class="op">-</span><span class="fl">0.7954340636549508</span>,<span class="op">-</span><span class="fl">0.5536447804097907</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>],</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a>            [<span class="fl">1.0557485835338234</span>,<span class="fl">0.5040085971987002</span>,<span class="op">-</span><span class="fl">0.5824506029515057</span>,<span class="op">-</span><span class="fl">0.5851840035995248</span>,<span class="fl">0.0</span>,<span class="fl">1.0</span>,<span class="fl">0.0</span>]</span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">1</span>] <span class="op">==</span> <span class="st">"application/json"</span></span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_transforms_data(directory):</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a><span class="st">    Torgersen, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_fn(directory.as_posix())</span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predict_fn(df, model)</span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">type</span>(response) <span class="kw">is</span> np.ndarray</span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_returns_none_if_invalid_input(directory):</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a><span class="st">    Invalid, 39.1, 18.7, 181, 3750, MALE</span></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model_fn(directory.as_posix())</span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_fn(input_data, <span class="st">"text/csv"</span>)</span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> predict_fn(df, model) <span class="kw">is</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---creating-the-postprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-postprocessing-script">Step 2 - Creating the Postprocessing Script</h3>
<p>The final component of our inference pipeline will transform the output from the model into a human-readable format.</p>
<p>We’ll use the Scikit-Learn target transformer we saved when we split and transformed the data. To deploy this component as part of an inference pipeline, we need to write a script that loads the transformer, uses it to modify the output from the model, and returns a human-readable format.</p>
<div id="d23798aa" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="93">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>postprocessing_component.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1"></a><span class="im">import</span> os</span>
<span id="cb107-2"><a href="#cb107-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb107-3"><a href="#cb107-3"></a><span class="im">import</span> json</span>
<span id="cb107-4"><a href="#cb107-4"></a><span class="im">import</span> joblib</span>
<span id="cb107-5"><a href="#cb107-5"></a></span>
<span id="cb107-6"><a href="#cb107-6"></a></span>
<span id="cb107-7"><a href="#cb107-7"></a><span class="cf">try</span>:</span>
<span id="cb107-8"><a href="#cb107-8"></a>    <span class="im">from</span> sagemaker_containers.beta.framework <span class="im">import</span> encoders, worker</span>
<span id="cb107-9"><a href="#cb107-9"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb107-10"><a href="#cb107-10"></a>    <span class="co"># We don't have access to the `worker` package when testing locally.</span></span>
<span id="cb107-11"><a href="#cb107-11"></a>    <span class="co"># We'll set it to None so we can change the way functions create</span></span>
<span id="cb107-12"><a href="#cb107-12"></a>    <span class="co"># a response.</span></span>
<span id="cb107-13"><a href="#cb107-13"></a>    worker <span class="op">=</span> <span class="va">None</span></span>
<span id="cb107-14"><a href="#cb107-14"></a></span>
<span id="cb107-15"><a href="#cb107-15"></a></span>
<span id="cb107-16"><a href="#cb107-16"></a><span class="kw">def</span> model_fn(model_dir):</span>
<span id="cb107-17"><a href="#cb107-17"></a>    <span class="co">"""</span></span>
<span id="cb107-18"><a href="#cb107-18"></a><span class="co">    Deserializes the target model and returns the list of fitted categories.</span></span>
<span id="cb107-19"><a href="#cb107-19"></a><span class="co">    """</span></span>
<span id="cb107-20"><a href="#cb107-20"></a></span>
<span id="cb107-21"><a href="#cb107-21"></a>    model <span class="op">=</span> joblib.load(os.path.join(model_dir, <span class="st">"target.joblib"</span>))</span>
<span id="cb107-22"><a href="#cb107-22"></a>    <span class="cf">return</span> model.named_transformers_[<span class="st">"species"</span>].categories_[<span class="dv">0</span>]</span>
<span id="cb107-23"><a href="#cb107-23"></a></span>
<span id="cb107-24"><a href="#cb107-24"></a></span>
<span id="cb107-25"><a href="#cb107-25"></a><span class="kw">def</span> input_fn(input_data, content_type):</span>
<span id="cb107-26"><a href="#cb107-26"></a>    <span class="cf">if</span> content_type <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb107-27"><a href="#cb107-27"></a>        <span class="cf">return</span> json.loads(input_data)[<span class="st">"predictions"</span>]</span>
<span id="cb107-28"><a href="#cb107-28"></a>    </span>
<span id="cb107-29"><a href="#cb107-29"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"</span><span class="sc">{</span>content_type<span class="sc">}</span><span class="ss"> is not supported."</span>)</span>
<span id="cb107-30"><a href="#cb107-30"></a></span>
<span id="cb107-31"><a href="#cb107-31"></a></span>
<span id="cb107-32"><a href="#cb107-32"></a><span class="kw">def</span> predict_fn(input_data, model):</span>
<span id="cb107-33"><a href="#cb107-33"></a>    <span class="co">"""</span></span>
<span id="cb107-34"><a href="#cb107-34"></a><span class="co">    Transforms the prediction into its corresponding category.</span></span>
<span id="cb107-35"><a href="#cb107-35"></a><span class="co">    """</span></span>
<span id="cb107-36"><a href="#cb107-36"></a>    predictions <span class="op">=</span> np.argmax(input_data, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb107-37"><a href="#cb107-37"></a>    confidence <span class="op">=</span> np.<span class="bu">max</span>(input_data, axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb107-38"><a href="#cb107-38"></a>    <span class="cf">return</span> [</span>
<span id="cb107-39"><a href="#cb107-39"></a>        (model[prediction], confidence)</span>
<span id="cb107-40"><a href="#cb107-40"></a>        <span class="cf">for</span> confidence, prediction <span class="kw">in</span> <span class="bu">zip</span>(confidence, predictions)</span>
<span id="cb107-41"><a href="#cb107-41"></a>    ]</span>
<span id="cb107-42"><a href="#cb107-42"></a></span>
<span id="cb107-43"><a href="#cb107-43"></a><span class="kw">def</span> output_fn(prediction, accept):</span>
<span id="cb107-44"><a href="#cb107-44"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"text/csv"</span>:</span>
<span id="cb107-45"><a href="#cb107-45"></a>        <span class="cf">return</span> (</span>
<span id="cb107-46"><a href="#cb107-46"></a>            worker.Response(encoders.encode(prediction, accept), mimetype<span class="op">=</span>accept)</span>
<span id="cb107-47"><a href="#cb107-47"></a>            <span class="cf">if</span> worker</span>
<span id="cb107-48"><a href="#cb107-48"></a>            <span class="cf">else</span> (prediction, accept)</span>
<span id="cb107-49"><a href="#cb107-49"></a>        )</span>
<span id="cb107-50"><a href="#cb107-50"></a></span>
<span id="cb107-51"><a href="#cb107-51"></a>    <span class="cf">if</span> accept <span class="op">==</span> <span class="st">"application/json"</span>:</span>
<span id="cb107-52"><a href="#cb107-52"></a>        response <span class="op">=</span> []</span>
<span id="cb107-53"><a href="#cb107-53"></a>        <span class="cf">for</span> p, c <span class="kw">in</span> prediction:</span>
<span id="cb107-54"><a href="#cb107-54"></a>            response.append({<span class="st">"prediction"</span>: p, <span class="st">"confidence"</span>: c})</span>
<span id="cb107-55"><a href="#cb107-55"></a></span>
<span id="cb107-56"><a href="#cb107-56"></a>        <span class="co"># If there's only one prediction, we'll return it</span></span>
<span id="cb107-57"><a href="#cb107-57"></a>        <span class="co"># as a single object.</span></span>
<span id="cb107-58"><a href="#cb107-58"></a>        <span class="cf">if</span> <span class="bu">len</span>(response) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb107-59"><a href="#cb107-59"></a>            response <span class="op">=</span> response[<span class="dv">0</span>]</span>
<span id="cb107-60"><a href="#cb107-60"></a></span>
<span id="cb107-61"><a href="#cb107-61"></a>        <span class="cf">return</span> (</span>
<span id="cb107-62"><a href="#cb107-62"></a>            worker.Response(json.dumps(response), mimetype<span class="op">=</span>accept)</span>
<span id="cb107-63"><a href="#cb107-63"></a>            <span class="cf">if</span> worker</span>
<span id="cb107-64"><a href="#cb107-64"></a>            <span class="cf">else</span> (response, accept)</span>
<span id="cb107-65"><a href="#cb107-65"></a>        )</span>
<span id="cb107-66"><a href="#cb107-66"></a></span>
<span id="cb107-67"><a href="#cb107-67"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"</span><span class="sc">{</span>accept<span class="sc">}</span><span class="ss"> accept type is not supported."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div id="965a6be5" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="94">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pipeline.postprocessing_component <span class="im">import</span> predict_fn, output_fn</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_predict_returns_prediction_as_first_column():</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> [</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.6</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>], </span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span>],</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.7</span>]</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>    categories <span class="op">=</span> [<span class="st">"Adelie"</span>, <span class="st">"Gentoo"</span>, <span class="st">"Chinstrap"</span>]</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predict_fn(input_data, categories)</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response <span class="op">==</span> [</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Adelie"</span>, <span class="fl">0.6</span>),</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Gentoo"</span>, <span class="fl">0.8</span>),</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Chinstrap"</span>, <span class="fl">0.7</span>)</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_does_not_return_array_if_single_prediction():</span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> [(<span class="st">"Adelie"</span>, <span class="fl">0.6</span>)]</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>    response, _ <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="st">"prediction"</span>] <span class="op">==</span> <span class="st">"Adelie"</span></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_output_returns_array_if_multiple_predictions():</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> [(<span class="st">"Adelie"</span>, <span class="fl">0.6</span>), (<span class="st">"Gentoo"</span>, <span class="fl">0.8</span>)]</span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>    response, _ <span class="op">=</span> output_fn(prediction, <span class="st">"application/json"</span>)</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(response) <span class="op">==</span> <span class="dv">2</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">0</span>][<span class="st">"prediction"</span>] <span class="op">==</span> <span class="st">"Adelie"</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">1</span>][<span class="st">"prediction"</span>] <span class="op">==</span> <span class="st">"Gentoo"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-3---setting-up-the-inference-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-3---setting-up-the-inference-pipeline">Step 3 - Setting up the Inference Pipeline</h3>
<p>We can now create a <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/pipeline.html#sagemaker.pipeline.PipelineModel">PipelineModel</a> to define our inference pipeline.</p>
<p>We’ll use the model we generated in the Split and Transform step as the input to the first and last components of the inference pipeline. This <code>model.tar.gz</code> file contains the two transformers we need to preprocess and postprocess the data.</p>
<p>Let’s create a variable with the URI to this file:</p>
<div id="82dafcd0" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>transformation_pipeline_model <span class="op">=</span> Join(</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"/"</span>,</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span>[</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>        preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model"</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>        ].S3Output.S3Uri,</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model.tar.gz"</span>,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the first component of the inference pipeline. It will preprocess the data before sending it to the TensorFlow model:</p>
<div id="8c7dda7a" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.model <span class="im">import</span> SKLearnModel</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>preprocessing_model <span class="op">=</span> SKLearnModel(</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>transformation_pipeline_model,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"preprocessing_component.py"</span>,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span>(CODE_FOLDER <span class="op">/</span> <span class="st">"pipeline"</span>).as_posix(),</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the last component of the inference pipeline. It will postprocess the output from the TensorFlow model before sending it back to the user:</p>
<div id="6c31090e" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>postprocessing_model <span class="op">=</span> SKLearnModel(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>transformation_pipeline_model,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"postprocessing_component.py"</span>,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span>(CODE_FOLDER <span class="op">/</span> <span class="st">"pipeline"</span>).as_posix(),</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">"1.2-1"</span>,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now create the inference pipeline using the three models:</p>
<div id="9fa95ab8" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.pipeline <span class="im">import</span> PipelineModel</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>pipeline_model <span class="op">=</span> PipelineModel(</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"inference-model"</span>,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>[preprocessing_model, tensorflow_model, postprocessing_model],</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---configuring-the-model-package-group" class="level3">
<h3 class="anchored" data-anchor-id="step-4---configuring-the-model-package-group">Step 4 - Configuring the Model Package Group</h3>
<p>Let’s define a new package group to register the Pipeline Model:</p>
<div id="7c052332" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>PIPELINE_MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"pipeline-penguins"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---registering-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-5---registering-the-model">Step 5 - Registering the Model</h3>
<p>We’ll modify the registration step to register the Pipeline Model in the Model Registry.</p>
<div id="3cb0ce9e" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="100">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> create_registration_step(</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    pipeline_model,</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    content_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    response_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---modifying-the-deploy-step" class="level3">
<h3 class="anchored" data-anchor-id="step-6---modifying-the-deploy-step">Step 6 - Modifying the Deploy Step</h3>
<p>Let’s now modify the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.lambda_step.LambdaStep">LambdaStep</a> to use the updated Registration Step.</p>
<div id="8ec7b7d8" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>deploy_step <span class="op">=</span> create_deployment_step(register_model_step)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---modifying-the-condition-step" class="level3">
<h3 class="anchored" data-anchor-id="step-7---modifying-the-condition-step">Step 7 - Modifying the Condition Step</h3>
<p>Since we modified the Registration Step, we also need to modify the Condition Step to use the new registration:</p>
<div id="b9712905-9fe3-4148-ae6d-05b0a48e742e" class="cell" data-tags="[]" data-execution_count="102">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step, deploy_step],</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-8---creating-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="step-8---creating-the-pipeline">Step 8 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="bad9f51d" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="103">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>session14_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session14-pipeline"</span>,</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>session14_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-9---testing-the-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="step-9---testing-the-endpoint">Step 9 - Testing the Endpoint</h3>
<p>Let’s now test the endpoint. Notice that we can now send the raw data to the endpoint, and it will return the penguin’s species in a human-readable format.</p>
<div id="3cc966fb-b611-417f-a8b8-0c5d2f95252c" class="cell" data-tags="[]" data-execution_count="104">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> CSVSerializer</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>CSVSerializer(),</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(DATA_FILEPATH)</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.drop(<span class="st">"species"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> data.iloc[:<span class="dv">3</span>].to_csv(header<span class="op">=</span><span class="va">False</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Payload:</span><span class="ch">\n</span><span class="sc">{</span>payload<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    wait_for_endpoint()</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(payload, initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Payload:
Torgersen,39.1,18.7,181.0,3750.0,MALE
Torgersen,39.5,17.4,186.0,3800.0,FEMALE
Torgersen,40.3,18.0,195.0,3250.0,FEMALE

Waiter EndpointInService failed: Waiter encountered a terminal failure state: Matched expected service error code: ValidationException</code></pre>
</div>
</div>
<p>We can also test the endpoint by sending a JSON payload. Notice how you can use a deserealizer to automatically decode the response from the model.</p>
<div id="ce3d33f0" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.deserializers <span class="im">import</span> JSONDeserializer</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> JSONSerializer</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>sample <span class="op">=</span> {</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"island"</span>: <span class="st">"Biscoe"</span>,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"culmen_length_mm"</span>: <span class="fl">48.6</span>,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"culmen_depth_mm"</span>: <span class="fl">16.0</span>,</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"flipper_length_mm"</span>: <span class="fl">230.0</span>,</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"body_mass_g"</span>: <span class="fl">5800.0</span>,</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span>: <span class="st">"MALE"</span>,</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>JSONSerializer(),</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    deserializer<span class="op">=</span>JSONDeserializer(),</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(sample)</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response)</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
<p>And now let’s send the same payload but return the prediction in CSV format:</p>
<div id="240aaff2" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.deserializers <span class="im">import</span> CSVDeserializer</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>JSONSerializer(),</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    deserializer<span class="op">=</span>CSVDeserializer(),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(sample, initial_args<span class="op">=</span>{<span class="st">"Accept"</span>: <span class="st">"text/csv"</span>})</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response)</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
</section>
</section>
<section id="session-15---custom-inference-script" class="level2">
<h2 class="anchored" data-anchor-id="session-15---custom-inference-script">Session 15 - Custom Inference Script</h2>
<p>This session creates a custom inference script to control the inference process in the SageMaker endpoint. This is an alternative to creating an inference pipeline to preprocess and postprocess the data that comes in and out of the model.</p>
<section id="step-1---creating-the-inference-script" class="level3">
<h3 class="anchored" data-anchor-id="step-1---creating-the-inference-script">Step 1 - Creating the Inference Script</h3>
<p>Let’s create a script where we’ll manage the inference process in the endpoint.</p>
<p>We’ll’ include this code as part of the model assets to control the inference process on the SageMaker endpoint. SageMaker will automatically call the <code>handler()</code> function for every request to the endpoint. Check <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/deploying_tensorflow_serving.html#how-to-implement-the-pre-and-or-post-processing-handler-s">How to implement the pre- and/or post-processing handler(s)</a> for more information.</p>
<p>We can now create the script inside the folder.</p>
<div id="97b3cd80" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="107">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>inference.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1"></a><span class="im">import</span> os</span>
<span id="cb124-2"><a href="#cb124-2"></a><span class="im">import</span> json</span>
<span id="cb124-3"><a href="#cb124-3"></a><span class="im">import</span> requests</span>
<span id="cb124-4"><a href="#cb124-4"></a><span class="im">import</span> joblib</span>
<span id="cb124-5"><a href="#cb124-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb124-6"><a href="#cb124-6"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb124-7"><a href="#cb124-7"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb124-8"><a href="#cb124-8"></a></span>
<span id="cb124-9"><a href="#cb124-9"></a></span>
<span id="cb124-10"><a href="#cb124-10"></a><span class="kw">def</span> handler(data, context, directory<span class="op">=</span>Path(<span class="st">"/opt/ml/model"</span>)):</span>
<span id="cb124-11"><a href="#cb124-11"></a>    <span class="co">"""</span></span>
<span id="cb124-12"><a href="#cb124-12"></a><span class="co">    This is the entrypoint that will be called by SageMaker</span></span>
<span id="cb124-13"><a href="#cb124-13"></a><span class="co">    when the endpoint receives a request.</span></span>
<span id="cb124-14"><a href="#cb124-14"></a><span class="co">    """</span></span>
<span id="cb124-15"><a href="#cb124-15"></a>    <span class="bu">print</span>(<span class="st">"Handling endpoint request"</span>)</span>
<span id="cb124-16"><a href="#cb124-16"></a></span>
<span id="cb124-17"><a href="#cb124-17"></a>    processed_input <span class="op">=</span> _process_input(data, context, directory)</span>
<span id="cb124-18"><a href="#cb124-18"></a>    output <span class="op">=</span> _predict(processed_input, context, directory) <span class="cf">if</span> processed_input <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb124-19"><a href="#cb124-19"></a>    <span class="cf">return</span> _process_output(output, context, directory)</span>
<span id="cb124-20"><a href="#cb124-20"></a></span>
<span id="cb124-21"><a href="#cb124-21"></a></span>
<span id="cb124-22"><a href="#cb124-22"></a><span class="kw">def</span> _process_input(data, context, directory):</span>
<span id="cb124-23"><a href="#cb124-23"></a>    <span class="bu">print</span>(<span class="st">"Processing input data..."</span>)</span>
<span id="cb124-24"><a href="#cb124-24"></a></span>
<span id="cb124-25"><a href="#cb124-25"></a>    <span class="cf">if</span> context <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb124-26"><a href="#cb124-26"></a>        <span class="co"># The context will be None when we are testing the code</span></span>
<span id="cb124-27"><a href="#cb124-27"></a>        <span class="co"># directly from a notebook. In that case, we can use the</span></span>
<span id="cb124-28"><a href="#cb124-28"></a>        <span class="co"># data directly.</span></span>
<span id="cb124-29"><a href="#cb124-29"></a>        endpoint_input <span class="op">=</span> data</span>
<span id="cb124-30"><a href="#cb124-30"></a>    <span class="cf">elif</span> context.request_content_type <span class="kw">in</span> (</span>
<span id="cb124-31"><a href="#cb124-31"></a>        <span class="st">"application/json"</span>,</span>
<span id="cb124-32"><a href="#cb124-32"></a>        <span class="st">"application/octet-stream"</span>,</span>
<span id="cb124-33"><a href="#cb124-33"></a>    ):</span>
<span id="cb124-34"><a href="#cb124-34"></a>        <span class="co"># When the endpoint is running, we will receive a context</span></span>
<span id="cb124-35"><a href="#cb124-35"></a>        <span class="co"># object. We need to parse the input and turn it into</span></span>
<span id="cb124-36"><a href="#cb124-36"></a>        <span class="co"># JSON in that case.</span></span>
<span id="cb124-37"><a href="#cb124-37"></a>        endpoint_input <span class="op">=</span> data.read().decode(<span class="st">"utf-8"</span>)</span>
<span id="cb124-38"><a href="#cb124-38"></a>    <span class="cf">else</span>:</span>
<span id="cb124-39"><a href="#cb124-39"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb124-40"><a href="#cb124-40"></a>            <span class="ss">f"Unsupported content type: </span><span class="sc">{</span>context<span class="sc">.</span>request_content_type <span class="kw">or</span> <span class="st">'unknown'</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb124-41"><a href="#cb124-41"></a>        )</span>
<span id="cb124-42"><a href="#cb124-42"></a></span>
<span id="cb124-43"><a href="#cb124-43"></a>    <span class="co"># Let's now transform the input data using the features pipeline.</span></span>
<span id="cb124-44"><a href="#cb124-44"></a>    <span class="cf">try</span>:</span>
<span id="cb124-45"><a href="#cb124-45"></a>        endpoint_input <span class="op">=</span> json.loads(endpoint_input)</span>
<span id="cb124-46"><a href="#cb124-46"></a>        df <span class="op">=</span> pd.json_normalize(endpoint_input)</span>
<span id="cb124-47"><a href="#cb124-47"></a>        features_pipeline <span class="op">=</span> joblib.load(directory <span class="op">/</span> <span class="st">"features.joblib"</span>)</span>
<span id="cb124-48"><a href="#cb124-48"></a>        result <span class="op">=</span> features_pipeline.transform(df)</span>
<span id="cb124-49"><a href="#cb124-49"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb124-50"><a href="#cb124-50"></a>        <span class="bu">print</span>(<span class="ss">f"There was an error processing the input data. </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb124-51"><a href="#cb124-51"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb124-52"><a href="#cb124-52"></a></span>
<span id="cb124-53"><a href="#cb124-53"></a>    <span class="cf">return</span> result[<span class="dv">0</span>].tolist()</span>
<span id="cb124-54"><a href="#cb124-54"></a></span>
<span id="cb124-55"><a href="#cb124-55"></a></span>
<span id="cb124-56"><a href="#cb124-56"></a><span class="kw">def</span> _predict(instance, context, directory):</span>
<span id="cb124-57"><a href="#cb124-57"></a>    <span class="bu">print</span>(<span class="st">"Sending input data to model to make a prediction..."</span>)</span>
<span id="cb124-58"><a href="#cb124-58"></a></span>
<span id="cb124-59"><a href="#cb124-59"></a>    <span class="cf">if</span> context <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb124-60"><a href="#cb124-60"></a>        <span class="co"># The context will be None when we are testing the code</span></span>
<span id="cb124-61"><a href="#cb124-61"></a>        <span class="co"># directly from a notebook. In that case, we want to load the</span></span>
<span id="cb124-62"><a href="#cb124-62"></a>        <span class="co"># model we trained and make a prediction using it.</span></span>
<span id="cb124-63"><a href="#cb124-63"></a>        <span class="im">import</span> keras</span>
<span id="cb124-64"><a href="#cb124-64"></a></span>
<span id="cb124-65"><a href="#cb124-65"></a>        model <span class="op">=</span> keras.models.load_model(Path(directory) <span class="op">/</span> <span class="st">"001"</span>)</span>
<span id="cb124-66"><a href="#cb124-66"></a>        predictions <span class="op">=</span> model.predict(np.array([instance]))</span>
<span id="cb124-67"><a href="#cb124-67"></a>        result <span class="op">=</span> {<span class="st">"predictions"</span>: predictions.tolist()}</span>
<span id="cb124-68"><a href="#cb124-68"></a>    <span class="cf">else</span>:</span>
<span id="cb124-69"><a href="#cb124-69"></a>        <span class="co"># When the endpoint is running, we will receive a context</span></span>
<span id="cb124-70"><a href="#cb124-70"></a>        <span class="co"># object. In that case we need to send the instance to the</span></span>
<span id="cb124-71"><a href="#cb124-71"></a>        <span class="co"># model to get a prediction back.</span></span>
<span id="cb124-72"><a href="#cb124-72"></a>        model_input <span class="op">=</span> json.dumps({<span class="st">"instances"</span>: [instance]})</span>
<span id="cb124-73"><a href="#cb124-73"></a>        response <span class="op">=</span> requests.post(context.rest_uri, data<span class="op">=</span>model_input)</span>
<span id="cb124-74"><a href="#cb124-74"></a></span>
<span id="cb124-75"><a href="#cb124-75"></a>        <span class="cf">if</span> response.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb124-76"><a href="#cb124-76"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(response.content.decode(<span class="st">"utf-8"</span>))</span>
<span id="cb124-77"><a href="#cb124-77"></a></span>
<span id="cb124-78"><a href="#cb124-78"></a>        result <span class="op">=</span> json.loads(response.content)</span>
<span id="cb124-79"><a href="#cb124-79"></a></span>
<span id="cb124-80"><a href="#cb124-80"></a>    <span class="bu">print</span>(<span class="ss">f"Response: </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb124-81"><a href="#cb124-81"></a>    <span class="cf">return</span> result</span>
<span id="cb124-82"><a href="#cb124-82"></a></span>
<span id="cb124-83"><a href="#cb124-83"></a></span>
<span id="cb124-84"><a href="#cb124-84"></a><span class="kw">def</span> _process_output(output, context, directory):</span>
<span id="cb124-85"><a href="#cb124-85"></a>    <span class="bu">print</span>(<span class="st">"Processing prediction received from the model..."</span>)</span>
<span id="cb124-86"><a href="#cb124-86"></a></span>
<span id="cb124-87"><a href="#cb124-87"></a>    <span class="cf">if</span> output:</span>
<span id="cb124-88"><a href="#cb124-88"></a>        prediction <span class="op">=</span> np.argmax(output[<span class="st">"predictions"</span>][<span class="dv">0</span>])</span>
<span id="cb124-89"><a href="#cb124-89"></a>        confidence <span class="op">=</span> output[<span class="st">"predictions"</span>][<span class="dv">0</span>][prediction]</span>
<span id="cb124-90"><a href="#cb124-90"></a></span>
<span id="cb124-91"><a href="#cb124-91"></a>        target_pipeline <span class="op">=</span> joblib.load(directory <span class="op">/</span> <span class="st">"target.joblib"</span>)</span>
<span id="cb124-92"><a href="#cb124-92"></a>        classes <span class="op">=</span> target_pipeline.named_transformers_[<span class="st">"species"</span>].categories_[<span class="dv">0</span>]</span>
<span id="cb124-93"><a href="#cb124-93"></a></span>
<span id="cb124-94"><a href="#cb124-94"></a>        result <span class="op">=</span> {</span>
<span id="cb124-95"><a href="#cb124-95"></a>            <span class="st">"prediction"</span>: classes[prediction],</span>
<span id="cb124-96"><a href="#cb124-96"></a>            <span class="st">"confidence"</span>: confidence,</span>
<span id="cb124-97"><a href="#cb124-97"></a>        }</span>
<span id="cb124-98"><a href="#cb124-98"></a>    <span class="cf">else</span>:</span>
<span id="cb124-99"><a href="#cb124-99"></a>        result <span class="op">=</span> {<span class="st">"prediction"</span>: <span class="va">None</span>}</span>
<span id="cb124-100"><a href="#cb124-100"></a></span>
<span id="cb124-101"><a href="#cb124-101"></a>    <span class="bu">print</span>(result)</span>
<span id="cb124-102"><a href="#cb124-102"></a></span>
<span id="cb124-103"><a href="#cb124-103"></a>    response_content_type <span class="op">=</span> (</span>
<span id="cb124-104"><a href="#cb124-104"></a>        <span class="st">"application/json"</span> <span class="cf">if</span> context <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> context.accept_header</span>
<span id="cb124-105"><a href="#cb124-105"></a>    )</span>
<span id="cb124-106"><a href="#cb124-106"></a>    <span class="cf">return</span> json.dumps(result), response_content_type</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s test the script to ensure everything is working as expected:</p>
<div id="91786cc7" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="108">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tarfile</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> processing.script <span class="im">import</span> preprocess</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> training.script <span class="im">import</span> train</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pipeline.inference <span class="im">import</span> handler</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> directory():</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> tempfile.mkdtemp()</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>    input_directory <span class="op">=</span> Path(directory) <span class="op">/</span> <span class="st">"input"</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>    input_directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>    shutil.copy2(DATA_FILEPATH, input_directory <span class="op">/</span> <span class="st">"data.csv"</span>)</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>    directory <span class="op">=</span> Path(directory)</span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>    preprocess(base_directory<span class="op">=</span>directory)</span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>    train(</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>        model_directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>        train_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"train"</span>,</span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>        validation_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"validation"</span>,</span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a>        pipeline_path<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a>        experiment<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># After training a model, we need to prepare a package just like</span></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SageMaker would. This package is what the evaluation script is</span></span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expecting as an input.</span></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tarfile.<span class="bu">open</span>(directory <span class="op">/</span> <span class="st">"model.tar.gz"</span>, <span class="st">"w:gz"</span>) <span class="im">as</span> tar:</span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a>        tar.add(directory <span class="op">/</span> <span class="st">"model"</span> <span class="op">/</span> <span class="st">"001"</span>, arcname<span class="op">=</span><span class="st">"001"</span>)</span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> directory</span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a>    shutil.rmtree(directory)</span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a><span class="at">@pytest.fixture</span>(scope<span class="op">=</span><span class="st">"function"</span>, autouse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb125-44"><a href="#cb125-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> payload():</span>
<span id="cb125-45"><a href="#cb125-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dumps({</span>
<span id="cb125-46"><a href="#cb125-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"island"</span>: <span class="st">"Biscoe"</span>,</span>
<span id="cb125-47"><a href="#cb125-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_length_mm"</span>: <span class="fl">48.6</span>,</span>
<span id="cb125-48"><a href="#cb125-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"culmen_depth_mm"</span>: <span class="fl">16.0</span>,</span>
<span id="cb125-49"><a href="#cb125-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"flipper_length_mm"</span>: <span class="fl">230.0</span>,</span>
<span id="cb125-50"><a href="#cb125-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"body_mass_g"</span>: <span class="dv">5800</span>,</span>
<span id="cb125-51"><a href="#cb125-51" aria-hidden="true" tabindex="-1"></a>    }).encode(<span class="st">"utf-8"</span>)</span>
<span id="cb125-52"><a href="#cb125-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-53"><a href="#cb125-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-54"><a href="#cb125-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_handler_response_contains_prediction_and_confidence(directory, payload):</span>
<span id="cb125-55"><a href="#cb125-55" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> handler(</span>
<span id="cb125-56"><a href="#cb125-56" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>payload,</span>
<span id="cb125-57"><a href="#cb125-57" aria-hidden="true" tabindex="-1"></a>        context<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-58"><a href="#cb125-58" aria-hidden="true" tabindex="-1"></a>        directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb125-59"><a href="#cb125-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb125-60"><a href="#cb125-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-61"><a href="#cb125-61" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response[<span class="dv">0</span>])</span>
<span id="cb125-62"><a href="#cb125-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"prediction"</span> <span class="kw">in</span> response</span>
<span id="cb125-63"><a href="#cb125-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">"confidence"</span> <span class="kw">in</span> response</span>
<span id="cb125-64"><a href="#cb125-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-65"><a href="#cb125-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-66"><a href="#cb125-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_handler_response_includes_content_type(directory, payload):</span>
<span id="cb125-67"><a href="#cb125-67" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> handler(</span>
<span id="cb125-68"><a href="#cb125-68" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>payload,</span>
<span id="cb125-69"><a href="#cb125-69" aria-hidden="true" tabindex="-1"></a>        context<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-70"><a href="#cb125-70" aria-hidden="true" tabindex="-1"></a>        directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb125-71"><a href="#cb125-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb125-72"><a href="#cb125-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-73"><a href="#cb125-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="dv">1</span>] <span class="op">==</span> <span class="st">"application/json"</span></span>
<span id="cb125-74"><a href="#cb125-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-75"><a href="#cb125-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-76"><a href="#cb125-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_handler_response_prediction_is_categorical(directory, payload):</span>
<span id="cb125-77"><a href="#cb125-77" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> handler(</span>
<span id="cb125-78"><a href="#cb125-78" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>payload,</span>
<span id="cb125-79"><a href="#cb125-79" aria-hidden="true" tabindex="-1"></a>        context<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-80"><a href="#cb125-80" aria-hidden="true" tabindex="-1"></a>        directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb125-81"><a href="#cb125-81" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb125-82"><a href="#cb125-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-83"><a href="#cb125-83" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response[<span class="dv">0</span>])</span>
<span id="cb125-84"><a href="#cb125-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="st">"prediction"</span>] <span class="kw">in</span> [<span class="st">"Adelie"</span>, <span class="st">"Gentoo"</span>, <span class="st">"Chinstrap"</span>]</span>
<span id="cb125-85"><a href="#cb125-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-86"><a href="#cb125-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-87"><a href="#cb125-87" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_handler_deals_with_an_invalid_payload(directory):</span>
<span id="cb125-88"><a href="#cb125-88" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> handler(</span>
<span id="cb125-89"><a href="#cb125-89" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span><span class="st">"invalid payload"</span>,</span>
<span id="cb125-90"><a href="#cb125-90" aria-hidden="true" tabindex="-1"></a>        context<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb125-91"><a href="#cb125-91" aria-hidden="true" tabindex="-1"></a>        directory<span class="op">=</span>directory <span class="op">/</span> <span class="st">"model"</span>,</span>
<span id="cb125-92"><a href="#cb125-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb125-93"><a href="#cb125-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-94"><a href="#cb125-94" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(response[<span class="dv">0</span>])</span>
<span id="cb125-95"><a href="#cb125-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> response[<span class="st">"prediction"</span>] <span class="kw">is</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2---creating-the-model-1" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-model-1">Step 2 - Creating the Model</h3>
<p>We can now create a new <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/sagemaker.tensorflow.html#tensorflow-serving-model">TensorFlowModel</a> including the <code>inference.py</code> file.</p>
<p>SageMaker triggers a repack operation whenever we specify the <code>source_dir</code> attribute in a model. We want that attribute to point to the local folder containing the <code>inference.py</code> file. SageMaker will automatically modify the original <code>model.tar.gz</code> package to include a <code>/code</code> folder containing the file.</p>
<p>Since we need access to Scikit-Learn in our script, we can include a <code>requirements.txt</code> file in the same location where the <code>inference.py</code> script is, and SageMaker will install everything in it.</p>
<p>To repack the model assets, SageMaker will automatically include a new step in the pipeline right before registering the model.</p>
<p>Here is what the new <code>model.tar.gz</code> package will look like:</p>
<pre><code>model/
    |--[model_version_number]
        |--assets/
        |--variables/
        |--saved_model.pb
    |--features.joblib
    |--target.joblib
code/
    |--inference.py
    |--requirements.txt</code></pre>
<p>Let’s create a <code>requirements.txt</code> file with all the libraries we want SageMaker to install in the inference container.</p>
<div id="603cb8f5" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="109">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1"></a>numpy</span>
<span id="cb127-2"><a href="#cb127-2"></a>pandas</span>
<span id="cb127-3"><a href="#cb127-3"></a>scikit<span class="op">-</span>learn<span class="op">==</span><span class="fl">1.2.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We can now create the model using the <code>inference.py</code> script.</p>
<div id="b5015c75" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>custom_tensorflow_model <span class="op">=</span> TensorFlowModel(</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"penguins"</span>,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>train_model_step.properties.ModelArtifacts.S3ModelArtifacts,</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">"inference.py"</span>,</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span>(CODE_FOLDER <span class="op">/</span> <span class="st">"pipeline"</span>).as_posix(),</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span>config[<span class="st">"framework_version"</span>],</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---configuring-the-model-package-group" class="level3">
<h3 class="anchored" data-anchor-id="step-3---configuring-the-model-package-group">Step 3 - Configuring the Model Package Group</h3>
<p>Let’s define a new group where we’ll register the model using the custom <code>inference.py</code> script.</p>
<div id="7ee3cdb6" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>CUSTOM_MODEL_PACKAGE_GROUP <span class="op">=</span> <span class="st">"custom-penguins"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---registering-the-model-2" class="level3">
<h3 class="anchored" data-anchor-id="step-4---registering-the-model-2">Step 4 - Registering the Model</h3>
<p>We can now modify the registration step to register the custom model in the Model Registry.</p>
<div id="21fb3e2c" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="112">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> create_registration_step(</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    custom_tensorflow_model,</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    model_package_group_name<span class="op">=</span>CUSTOM_MODEL_PACKAGE_GROUP,</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    content_types<span class="op">=</span>[<span class="st">"application/json"</span>],</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    response_types<span class="op">=</span>[<span class="st">"application/json"</span>],</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>model_metrics,</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---modifying-the-deploy-step" class="level3">
<h3 class="anchored" data-anchor-id="step-5---modifying-the-deploy-step">Step 5 - Modifying the Deploy Step</h3>
<p>Let’s now modify the <a href="https://sagemaker.readthedocs.io/en/stable/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.lambda_step.LambdaStep">LambdaStep</a> to use the updated Registration Step.</p>
<div id="9e8162b7" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>deploy_step <span class="op">=</span> create_deployment_step(register_model_step)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---modifying-the-condition-step-1" class="level3">
<h3 class="anchored" data-anchor-id="step-6---modifying-the-condition-step-1">Step 6 - Modifying the Condition Step</h3>
<p>Since we modified the Registration Step, we also need to modify the Condition Step to use the new registration:</p>
<div id="849b379f" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step, deploy_step],</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-7---creating-the-pipeline-1">Step 7 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="f64921ee" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="115">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>session15_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session15-pipeline"</span>,</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>session15_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-8---testing-the-endpoint-1" class="level3">
<h3 class="anchored" data-anchor-id="step-8---testing-the-endpoint-1">Step 8 - Testing the Endpoint</h3>
<p>Let’s test the endpoint to make sure it works.</p>
<div id="1d63ce59" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.deserializers <span class="im">import</span> JSONDeserializer</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    wait_for_endpoint()</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    predictor <span class="op">=</span> Predictor(</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>        endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>        serializer<span class="op">=</span>JSONSerializer(),</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>        deserializer<span class="op">=</span>JSONDeserializer(),</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(</span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"island"</span>: <span class="st">"Dream"</span>,</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"culmen_length_mm"</span>: <span class="fl">46.4</span>,</span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"culmen_depth_mm"</span>: <span class="fl">18.6</span>,</span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"flipper_length_mm"</span>: <span class="fl">190.0</span>,</span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"body_mass_g"</span>: <span class="fl">3450.0</span>,</span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response)</span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Waiter EndpointInService failed: Waiter encountered a terminal failure state: Matched expected service error code: ValidationException</code></pre>
</div>
</div>
</section>
</section>
<section id="session-16---data-quality-baseline" class="level2">
<h2 class="anchored" data-anchor-id="session-16---data-quality-baseline">Session 16 - Data Quality Baseline</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">Quality Check Step</a> to compute a baseline for the data the endpoint expects.</p>
<p>This step will compute statistics and constraints from the data. We’ll’ later use this information as the baseline to detect data drift and other data quality issues.</p>
<p><a href="images/data-quality-baseline.png" target="_blank"> <img src="images/data-quality-baseline.png" alt="Data Quality Baseline" style="max-width: 740px;"></a></p>
<p>Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-data-quality.html">Monitor data quality</a> for more information about monitoring data quality in SageMaker.</p>
<section id="step-1---configuring-baseline-location" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-baseline-location">Step 1 - Configuring Baseline Location</h3>
<p>Let’s start by defining the location where SageMaker will store the baseline data:</p>
<div id="f4747fc7" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>DATA_QUALITY_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/data-quality"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---generating-data-quality-baseline" class="level3">
<h3 class="anchored" data-anchor-id="step-2---generating-data-quality-baseline">Step 2 - Generating Data Quality Baseline</h3>
<p>Let’s configure a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">QualityCheck Step</a> to compute the general statistics of the data we used to build our model.</p>
<p>We can configure the instance that will run the quality check using the <a href="https://sagemaker.readthedocs.io/en/v2.73.0/workflows/pipelines/sagemaker.workflow.pipelines.html#sagemaker.workflow.check_job_config.CheckJobConfig">CheckJobConfig</a> class, and we can use the <code>DataQualityCheckConfig</code> class to configure the job.</p>
<p>We are running this step with the following configuration:</p>
<ul>
<li><p><code>skip_check = True</code>: This parameter controls whether the step should skip checking the data against a previous baseline. Since we want to generate the baseline for the first time, we set it to <code>True</code>. After running the pipeline once to generate the baseline, we can set this parameter to <code>False</code> to ensure any new data follows the same distribution as the baseline.</p></li>
<li><p><code>register_new_baseline = True</code>: This parameter controls whether the new calculated baseline will be registered in the Model Registry.</p></li>
</ul>
<p>For more information about these configuration parameters, check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-quality-clarify-baseline-lifecycle.html">Baseline calculation and registration</a>.</p>
<div id="3fc728fa" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="118">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor.dataset_format <span class="im">import</span> DatasetFormat</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.check_job_config <span class="im">import</span> CheckJobConfig</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.quality_check_step <span class="im">import</span> (</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    DataQualityCheckConfig,</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>    QualityCheckStep,</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>data_quality_baseline_step <span class="op">=</span> QualityCheckStep(</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-data-quality-baseline"</span>,</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>    check_job_config<span class="op">=</span>CheckJobConfig(</span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.c5.xlarge"</span>,</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>        volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>    quality_check_config<span class="op">=</span>DataQualityCheckConfig(</span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>        baseline_dataset<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train-baseline"</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>        ].S3Output.S3Uri,</span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a>        dataset_format<span class="op">=</span>DatasetFormat.csv(header<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a>        output_s3_uri<span class="op">=</span>DATA_QUALITY_LOCATION,</span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>    model_package_group_name<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a>    skip_check<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a>    register_new_baseline<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---setting-up-model-metrics" class="level3">
<h3 class="anchored" data-anchor-id="step-3---setting-up-model-metrics">Step 3 - Setting up Model Metrics</h3>
<p>We can configure a new set of <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_metrics.ModelMetrics">ModelMetrics</a> using the results of the Quality Step. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-quality-clarify-baseline-lifecycle.html#pipelines-quality-clarify-baseline-evolution">Baseline and model version lifecycle and evolution with SageMaker Pipelines</a> for an explanation of how SageMaker uses the <code>DriftCheckBaselines</code>.</p>
<div id="2d5d8133" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.drift_check_baselines <span class="im">import</span> DriftCheckBaselines</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>data_quality_model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>data_quality_drift_check_baselines <span class="op">=</span> DriftCheckBaselines(</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---registering-the-model-3" class="level3">
<h3 class="anchored" data-anchor-id="step-4---registering-the-model-3">Step 4 - Registering the Model</h3>
<p>Let’s modify the registration step to use the new metrics and the drift baseline:</p>
<div id="fc5c4325" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="120">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> create_registration_step(</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>    pipeline_model,</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    content_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    response_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>data_quality_model_metrics,</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    drift_check_baselines<span class="op">=</span>data_quality_drift_check_baselines,</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---modifying-the-condition-step-1" class="level3">
<h3 class="anchored" data-anchor-id="step-5---modifying-the-condition-step-1">Step 5 - Modifying the Condition Step</h3>
<p>Since we modified the Registration Step, we also need to modify the Condition Step to use the new registration:</p>
<div id="be9d6de7" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_model_step],</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-6---creating-the-pipeline-1">Step 6 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="fb9b8d1e" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="122">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>session16_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session16-pipeline"</span>,</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>        data_quality_baseline_step,</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>session16_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---checking-constraints-and-statistics" class="level3">
<h3 class="anchored" data-anchor-id="step-7---checking-constraints-and-statistics">Step 7 - Checking Constraints and Statistics</h3>
<p>Our pipeline generated data baseline statistics and constraints. We can take a look at what these values look like by downloading them from S3. You need to wait for the pipeline to finish running before these files are available.</p>
<p>Here are the data quality statistics:</p>
<div id="c2b95d03" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>        S3Downloader.read_file(<span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/statistics.json"</span>),</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response[<span class="st">"features"</span>][<span class="dv">0</span>], indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:  <span class="co"># noqa: S110</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "name": "island",
  "inferred_type": "String",
  "string_statistics": {
    "common": {
      "num_present": 236,
      "num_missing": 0
    },
    "distinct_count": 3.0,
    "distribution": {
      "categorical": {
        "buckets": [
          {
            "value": "Dream",
            "count": 84
          },
          {
            "value": "Torgersen",
            "count": 32
          },
          {
            "value": "Biscoe",
            "count": 120
          }
        ]
      }
    }
  }
}</code></pre>
</div>
</div>
<p>Here are the data quality constraints:</p>
<div id="63908598" class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>        S3Downloader.read_file(<span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>),</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:  <span class="co"># noqa: S110</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "version": 0.0,
  "features": [
    {
      "name": "island",
      "inferred_type": "String",
      "completeness": 1.0,
      "string_constraints": {
        "domains": [
          "Dream",
          "Torgersen",
          "Biscoe"
        ]
      }
    },
    {
      "name": "culmen_length_mm",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "culmen_depth_mm",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "flipper_length_mm",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "body_mass_g",
      "inferred_type": "Fractional",
      "completeness": 1.0,
      "num_constraints": {
        "is_non_negative": true
      }
    },
    {
      "name": "sex",
      "inferred_type": "String",
      "completeness": 1.0,
      "string_constraints": {
        "domains": [
          "FEMALE",
          ".",
          "MALE"
        ]
      }
    }
  ],
  "monitoring_config": {
    "evaluate_constraints": "Enabled",
    "emit_metrics": "Enabled",
    "datatype_check_threshold": 1.0,
    "domain_content_threshold": 1.0,
    "distribution_constraints": {
      "perform_comparison": "Enabled",
      "comparison_threshold": 0.1,
      "comparison_method": "Robust",
      "categorical_comparison_threshold": 0.1,
      "categorical_drift_method": "LInfinity"
    }
  }
}</code></pre>
</div>
</div>
</section>
</section>
<section id="session-17---model-quality-baseline" class="level2">
<h2 class="anchored" data-anchor-id="session-17---model-quality-baseline">Session 17 - Model Quality Baseline</h2>
<p>This session extends the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-sdk.html">SageMaker Pipeline</a> with a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">QualityCheck Step</a> to compute a baseline for the model performance.</p>
<p>This step will compute the baseline metrics we will later use as the baseline to detect model drift.</p>
<p>To create a baseline to compare the model performance, we must create predictions for the test set and compare the model’s metrics with the model performance on production data. We can do this by running a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html">Batch Transform Job</a> to predict every sample from the test set. We can use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a> as part of the pipeline to run this job.</p>
<p><a href="images/model-quality-baseline.png" target="_blank"> <img src="images/model-quality-baseline.png" alt="Model Quality Baseline" style="max-width: 740px;"></a></p>
<p>Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality.html">Monitor model quality</a> for more information about monitoring model quality in SageMaker.</p>
<section id="step-1---configuring-baseline-location-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-baseline-location-1">Step 1 - Configuring Baseline Location</h3>
<p>Let’s start by defining the location where SageMaker will store the baseline data:</p>
<div id="69e115c3" class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>MODEL_QUALITY_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/model-quality"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---creating-the-model-2" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-model-2">Step 2 - Creating the Model</h3>
<p>The <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a> requires a model to generate predictions, so we need a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-model">Model Step</a> that creates a model:</p>
<div id="f93f2751" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="126">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>create_model_step <span class="op">=</span> ModelStep(</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"create-model"</span>,</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>pipeline_model.create(instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>]),</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---setting-up-the-transform-step" class="level3">
<h3 class="anchored" data-anchor-id="step-3---setting-up-the-transform-step">Step 3 - Setting up the Transform Step</h3>
<p>We are going to use a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html">Batch Transform Job</a> to generate predictions for every sample from the test set.</p>
<p>This Batch Transform Job will run every sample from the training dataset through the model so we can compute the baseline metrics. Check <a href="https://sagemaker.readthedocs.io/en/stable/frameworks/tensorflow/using_tf.html#run-a-batch-transform-job">Run a Batch Transform Job</a> for more information about running a Batch Transform Job.</p>
<p>Let’s start by configuring a <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/transformer.html">Transformer</a> instance:</p>
<div id="2a530d12" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.transformer <span class="im">import</span> Transformer</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>transformer <span class="op">=</span> Transformer(</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    model_name<span class="op">=</span>create_model_step.properties.ModelName,</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>    strategy<span class="op">=</span><span class="st">"MultiRecord"</span>,</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>    accept<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>    assemble_with<span class="op">=</span><span class="st">"Line"</span>,</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>    output_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/transform"</span>,</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now set up the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-transform">Transform Step</a> using the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/transformer.html">Transformer</a> we configured before.</p>
<p>Notice the following:</p>
<ul>
<li>We’ll generate predictions for the baseline test data that we generated when we split and transformed the data. This baseline is the same data we used to test the model, but it’s in raw format.</li>
<li>The output of this Batch Transform Job will have two fields. The first one will be the ground truth label, and the second one will be the prediction of the model.</li>
</ul>
<div id="653c6ec8" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="128">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TransformStep</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>generate_test_predictions_step <span class="op">=</span> TransformStep(</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-test-predictions"</span>,</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    step_args<span class="op">=</span>transformer.transform(</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We will use the baseline set we generated when we split the data.</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This set corresponds to the test split before the transformation step.</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>preprocessing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"test-baseline"</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>        ].S3Output.S3Uri,</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>        join_source<span class="op">=</span><span class="st">"Input"</span>,</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>        split_type<span class="op">=</span><span class="st">"Line"</span>,</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"text/csv"</span>,</span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We want to output the first and the second to last field from</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the joint set. The first field corresponds to the groundtruth,</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and the second to last field corresponds to the prediction.</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">#</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Here is an example of the data the Transform Job will generate</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># after joining the input with the output from the model:</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#</span></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gentoo,39.1,18.7,181.0,3750.0,MALE,Gentoo,0.52</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Notice how the first field is the groundtruth coming from the</span></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># test set. The second to last field is the prediction coming the</span></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># model.</span></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>        output_filter<span class="op">=</span><span class="st">"$[0,-2]"</span>,</span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-4---generating-model-quality-baseline" class="level3">
<h3 class="anchored" data-anchor-id="step-4---generating-model-quality-baseline">Step 4 - Generating Model Quality Baseline</h3>
<p>Let’s now configure the <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/build-and-manage-steps.html#step-type-quality-check">Quality Check Step</a> and feed it the data we generated in the Transform Step. This step will automatically compute the performance metrics of the model on the test set.</p>
<p>We are running this step with the following configuration:</p>
<ul>
<li><p><code>skip_check = True</code>: This parameter controls whether the step should skip checking the data against a previous baseline. Since we want to generate the baseline for the first time, we set it to <code>True</code>. After running the pipeline once to generate the baseline, we can set this parameter to <code>False</code> to ensure any new data follows the same distribution as the baseline.</p></li>
<li><p><code>register_new_baseline = True</code>: This parameter controls whether the new calculated baseline will be registered in the Model Registry.</p></li>
</ul>
<div id="b50a9ed5" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="129">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.quality_check_step <span class="im">import</span> ModelQualityCheckConfig</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>model_quality_baseline_step <span class="op">=</span> QualityCheckStep(</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"generate-model-quality-baseline"</span>,</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    check_job_config<span class="op">=</span>CheckJobConfig(</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>        instance_type<span class="op">=</span><span class="st">"ml.c5.xlarge"</span>,</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>        instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>        volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>        sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>role,</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    quality_check_config<span class="op">=</span>ModelQualityCheckConfig(</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We are going to use the output of the Transform Step to generate</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the model quality baseline.</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>        baseline_dataset<span class="op">=</span>generate_test_predictions_step.properties.TransformOutput.S3OutputPath,</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>        dataset_format<span class="op">=</span>DatasetFormat.csv(header<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to specify the problem type and the fields where the prediction</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and groundtruth are so the process knows how to interpret the results.</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>        problem_type<span class="op">=</span><span class="st">"MulticlassClassification"</span>,</span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Since the data doesn't have headers, SageMaker will autocreate headers for it.</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># _c0 corresponds to the first column, and _c1 corresponds to the second column.</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>        ground_truth_attribute<span class="op">=</span><span class="st">"_c0"</span>,</span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>        inference_attribute<span class="op">=</span><span class="st">"_c1"</span>,</span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>        output_s3_uri<span class="op">=</span>MODEL_QUALITY_LOCATION,</span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>    model_package_group_name<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>    skip_check<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>    register_new_baseline<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config,</span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---setting-up-model-metrics" class="level3">
<h3 class="anchored" data-anchor-id="step-5---setting-up-model-metrics">Step 5 - Setting up Model Metrics</h3>
<p>We can configure a new set of <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_metrics.ModelMetrics">ModelMetrics</a> using the results of the Quality Step. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-quality-clarify-baseline-lifecycle.html#pipelines-quality-clarify-baseline-evolution">Baseline and model version lifecycle and evolution with SageMaker Pipelines</a> for an explanation of how SageMaker uses the <code>DriftCheckBaselines</code>.</p>
<div id="3aecc022" class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.drift_check_baselines <span class="im">import</span> DriftCheckBaselines</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>model_quality_model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>    model_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineStatistics,</span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.CalculatedBaselineConstraints,</span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>model_quality_drift_check_baselines <span class="op">=</span> DriftCheckBaselines(</span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>    model_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>model_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>    model_data_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckStatistics,</span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-34"><a href="#cb151-34" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-35"><a href="#cb151-35" aria-hidden="true" tabindex="-1"></a>    model_data_constraints<span class="op">=</span>MetricsSource(</span>
<span id="cb151-36"><a href="#cb151-36" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span>data_quality_baseline_step.properties.BaselineUsedForDriftCheckConstraints,</span>
<span id="cb151-37"><a href="#cb151-37" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span>,</span>
<span id="cb151-38"><a href="#cb151-38" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb151-39"><a href="#cb151-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---registering-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-6---registering-the-model">Step 6 - Registering the Model</h3>
<p>Let’s modify the registration step to use the new metrics and the drift baseline:</p>
<div id="20154a1a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="131">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>register_model_step <span class="op">=</span> create_registration_step(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    pipeline_model,</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    content_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    response_types<span class="op">=</span>[<span class="st">"text/csv"</span>, <span class="st">"application/json"</span>],</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>model_quality_model_metrics,</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>    drift_check_baselines<span class="op">=</span>model_quality_drift_check_baselines,</span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-7---modifying-the-condition-step-1" class="level3">
<h3 class="anchored" data-anchor-id="step-7---modifying-the-condition-step-1">Step 7 - Modifying the Condition Step</h3>
<p>We need to modify the Condition Step to include the new Registration Step and the Transform and Quality Check Steps.</p>
<div id="cd84e567" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"check-model-accuracy"</span>,</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[condition],</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>(</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>            create_model_step,</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>            generate_test_predictions_step,</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>            model_quality_baseline_step,</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>            register_model_step,</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[fail_step],</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-8---creating-the-pipeline-1" class="level3">
<h3 class="anchored" data-anchor-id="step-8---creating-the-pipeline-1">Step 8 - Creating the Pipeline</h3>
<p>We can now define the SageMaker Pipeline and submit its definition to the SageMaker Pipelines service to create the pipeline if it doesn’t exist or update it if it does.</p>
<div id="c244e206" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="133">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>session17_pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"session17-pipeline"</span>,</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[dataset_location, accuracy_threshold],</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>        preprocessing_step,</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>        train_model_step,</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>        evaluate_model_step,</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>        data_quality_baseline_step,</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>        condition_step,</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>    pipeline_definition_config<span class="op">=</span>pipeline_definition_config,</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>config[<span class="st">"session"</span>],</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>session17_pipeline.upsert(role_arn<span class="op">=</span>role)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-9---checking-constraints" class="level3">
<h3 class="anchored" data-anchor-id="step-9---checking-constraints">Step 9 - Checking Constraints</h3>
<p>Our pipeline generated model baseline constraints. We can take a look at what these values look like by downloading them from S3. You need to wait for the pipeline to finish running before the file is available.</p>
<div id="dc31aa28" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> json.loads(</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>        S3Downloader.read_file(<span class="ss">f"</span><span class="sc">{</span>MODEL_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>),</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span>:  <span class="co"># noqa: S110</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "version": 0.0,
  "multiclass_classification_constraints": {
    "accuracy": {
      "threshold": 1.0,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_recall": {
      "threshold": 1.0,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_precision": {
      "threshold": 1.0,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_f0_5": {
      "threshold": 1.0,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_f1": {
      "threshold": 1.0,
      "comparison_operator": "LessThanThreshold"
    },
    "weighted_f2": {
      "threshold": 1.0,
      "comparison_operator": "LessThanThreshold"
    }
  }
}</code></pre>
</div>
</div>
</section>
</section>
<section id="session-18---data-monitoring" class="level2">
<h2 class="anchored" data-anchor-id="session-18---data-monitoring">Session 18 - Data Monitoring</h2>
<p>This session creates a Monitoring Job to monitor the quality of the data received by the endpoint. This schedule will run periodically and check the data that goes into the endpoint against the baseline we generated before.</p>
<p>Check <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_monitoring.html">Amazon SageMaker Model Monitor</a> for an explanation of how to use SageMaker’s Model Monitoring functionality. <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor.html">Monitor models for data and model quality, bias, and explainability</a> is a much more extensive guide to monitoring in Amazon SageMaker.</p>
<section id="step-1---deploying-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-1---deploying-the-model">Step 1 - Deploying the Model</h3>
<p>Let’s deploy the latest approved model to an endpoint.</p>
<p>Since we need to do the same later, we can create a function to deploy the model. Notice how we need to enable Data Capture to monitor the data that goes in and out of the endpoint.</p>
<div id="57cc8903" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> DataCaptureConfig</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deploy_model():</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Deploy the latest model registered in the Model Registry."""</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> sagemaker_client.list_model_packages(</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>        ModelPackageGroupName<span class="op">=</span>PIPELINE_MODEL_PACKAGE_GROUP,</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>        ModelApprovalStatus<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>        SortBy<span class="op">=</span><span class="st">"CreationTime"</span>,</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>        MaxResults<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    package <span class="op">=</span> (</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>        response[<span class="st">"ModelPackageSummaryList"</span>][<span class="dv">0</span>]</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> response[<span class="st">"ModelPackageSummaryList"</span>]</span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> package:</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>        model_package <span class="op">=</span> ModelPackage(</span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>            model_package_arn<span class="op">=</span>package[<span class="st">"ModelPackageArn"</span>],</span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>            sagemaker_session<span class="op">=</span>sagemaker_session,</span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>            role<span class="op">=</span>role,</span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>        model_package.deploy(</span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>            endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>            initial_instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>            instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We must enable Data Capture to monitor the model.</span></span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>            data_capture_config<span class="op">=</span>DataCaptureConfig(</span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>                enable_capture<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>                sampling_percentage<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>                destination_s3_uri<span class="op">=</span>DATA_CAPTURE_DESTINATION,</span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>                capture_options<span class="op">=</span>[<span class="st">"REQUEST"</span>, <span class="st">"RESPONSE"</span>],</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>                csv_content_types<span class="op">=</span>[<span class="st">"text/csv"</span>],</span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a>                json_content_types<span class="op">=</span>[<span class="st">"application/json"</span>],</span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4966c9c2" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="136">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>deploy_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---generating-fake-traffic" class="level3">
<h3 class="anchored" data-anchor-id="step-2---generating-fake-traffic">Step 2 - Generating Fake Traffic</h3>
<p>To test the monitoring functionality, we need to generate traffic to the endpoint. To generate traffic, we will send every sample from the dataset to the endpoint to simulate real prediction requests:</p>
<div id="cea757af" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="137">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> JSONSerializer</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_fake_traffic():</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate fake traffic to the endpoint."""</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> data.iterrows():</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>            payload <span class="op">=</span> <span class="st">","</span>.join([<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> row.to_list()])</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>            predictor.predict(</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>                payload,</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>                initial_args<span class="op">=</span>{<span class="st">"ContentType"</span>: <span class="st">"text/csv"</span>, <span class="st">"Accept"</span>: <span class="st">"text/csv"</span>},</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>                <span class="co"># The `inference_id` field is important to match</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>                <span class="co"># it later with a corresponding ground-truth label.</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>                inference_id<span class="op">=</span><span class="bu">str</span>(index),</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(e)</span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>generate_fake_traffic()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the location where the endpoint stores the captured data, download a file, and display its content. It may take a few minutes for the first few files to show up in S3.</p>
<p>These files contain the data captured by the endpoint in a SageMaker-specific JSON-line format. Each inference request is captured in a single line in the <code>jsonl</code> file. The line contains both the input and output merged together:</p>
<div id="caee992c" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> S3Downloader.<span class="bu">list</span>(DATA_CAPTURE_DESTINATION)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(files):</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> S3Downloader.read_file(files[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"File: </span><span class="sc">{</span>files[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(json.loads(lines.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)[<span class="dv">0</span>]), indent<span class="op">=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File: s3://mlschool/penguins/monitoring/data-capture/penguins-endpoint/AllTraffic/2024/03/30/18/40-45-068-0f144be9-ac73-4c4e-a0c7-82b1ba7db88b.jsonl
{
  "captureData": {
    "endpointInput": {
      "observedContentType": "text/csv",
      "mode": "INPUT",
      "data": "Torgersen,39.1,18.7,181.0,3750.0,MALE",
      "encoding": "CSV"
    },
    "endpointOutput": {
      "observedContentType": "text/csv; charset=utf-8",
      "mode": "OUTPUT",
      "data": "Adelie,0.964408875\n",
      "encoding": "CSV"
    }
  },
  "eventMetadata": {
    "eventId": "08a239af-c98c-4984-b9bf-4ea049d88617",
    "inferenceId": "0",
    "inferenceTime": "2024-03-30T18:40:45Z"
  },
  "eventVersion": "0"
}</code></pre>
</div>
</div>
</section>
<section id="step-3---creating-custom-preprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="step-3---creating-custom-preprocessing-script">Step 3 - Creating Custom Preprocessing Script</h3>
<p>SageMaker looks for violations in the data captured by the endpoint. By default, it combines the input data with the endpoint output and compares the result with the baseline we generated before. If we let SageMaker do this, we will get a few violations, for example an “extra column check” violation because the field <code>confidence</code> doesn’t exist in the baseline data.</p>
<p>We can fix these violations by creating a preprocessing script configuring the data we want the monitoring job to use. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-pre-and-post-processing.html">Preprocessing and Postprocessing</a> for more information about how to configure these scripts.</p>
<p>We’ll store the script in a folder called <code>monitoring</code>:</p>
<div id="7b48cd49" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>DATA_QUALITY_PREPROCESSOR <span class="op">=</span> <span class="st">"data_quality_preprocessor.py"</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>(CODE_FOLDER <span class="op">/</span> <span class="st">"monitoring"</span>).mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now define the preprocessing script. Notice that this script will return a JSON object with a name for each feature and their value.</p>
<div id="0114a817" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="140">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>data_quality_preprocessor.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1"></a><span class="im">import</span> json</span>
<span id="cb163-2"><a href="#cb163-2"></a></span>
<span id="cb163-3"><a href="#cb163-3"></a></span>
<span id="cb163-4"><a href="#cb163-4"></a><span class="kw">def</span> preprocess_handler(inference_record, logger):</span>
<span id="cb163-5"><a href="#cb163-5"></a>    input_data <span class="op">=</span> inference_record.endpoint_input.data</span>
<span id="cb163-6"><a href="#cb163-6"></a>    <span class="cf">return</span> {<span class="bu">str</span>(i).zfill(<span class="dv">2</span>): d <span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(input_data.split(<span class="st">","</span>))}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="step-4---uploading-preprocessing-script" class="level3">
<h3 class="anchored" data-anchor-id="step-4---uploading-preprocessing-script">Step 4 - Uploading Preprocessing Script</h3>
<p>The monitoring schedule expects an S3 location pointing to the preprocessing script. Let’s upload the script to the default bucket.</p>
<div id="21240214" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="141">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> boto3.Session().resource(<span class="st">"s3"</span>).Bucket(config[<span class="st">"session"</span>].default_bucket())</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>prefix <span class="op">=</span> Path(<span class="st">"penguins/monitoring"</span>)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>bucket.Object((prefix <span class="op">/</span> DATA_QUALITY_PREPROCESSOR).as_posix()).upload_file(</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    (CODE_FOLDER <span class="op">/</span> <span class="st">"monitoring"</span> <span class="op">/</span> DATA_QUALITY_PREPROCESSOR).as_posix(),</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>data_quality_preprocessor <span class="op">=</span> <span class="ss">f"s3://</span><span class="sc">{</span>(bucket.name <span class="op">/</span> prefix <span class="op">/</span> DATA_QUALITY_PREPROCESSOR)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>data_quality_preprocessor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-monitoring-schedule" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-monitoring-schedule">Step 5 - Creating Monitoring Schedule</h3>
<p>We can now set up the Data Quality Monitoring Job using the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.DefaultModelMonitor">DefaultModelMonitor</a> class.</p>
<div id="b9df3d16" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> DefaultModelMonitor</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>data_monitor <span class="op">=</span> DefaultModelMonitor(</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">1800</span>,</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>    volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:sagemaker.image_uris:Defaulting to the only supported framework/algorithm version: .
INFO:sagemaker.image_uris:Ignoring unnecessary instance type: None.</code></pre>
</div>
</div>
<p>Let’s now create the monitoring schedule. Notice how we specify the <code>record_preprocessor_script</code> using the S3 location where we uploaded our script.</p>
<p>We are going to set up the monitoring schedule to run every hour. Keep in mind that SageMaker has a buffer period of 20 minutes to schedule an execution.</p>
<div id="c2b3fe69" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="143">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> CronExpressionGenerator</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>data_monitor.create_monitoring_schedule(</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    monitor_schedule_name<span class="op">=</span><span class="st">"penguins-data-monitoring-schedule"</span>,</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>    endpoint_input<span class="op">=</span>ENDPOINT,</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>    record_preprocessor_script<span class="op">=</span>data_quality_preprocessor,</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>    statistics<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/statistics.json"</span>,</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>DATA_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>,</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>    schedule_cron_expression<span class="op">=</span>CronExpressionGenerator.hourly(),</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>    output_s3_uri<span class="op">=</span>DATA_QUALITY_LOCATION,</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>    enable_cloudwatch_metrics<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's give SageMaker some time to process the</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a><span class="co"># monitoring job before we start it.</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">10</span>)</span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>data_monitor.start_monitoring_schedule()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---checking-violations" class="level3">
<h3 class="anchored" data-anchor-id="step-6---checking-violations">Step 6 - Checking Violations</h3>
<p>After the monitoring schedule runs for the first time, we can check the results of the last execution. If the job completed successfully, we can check if there are any violations.</p>
<div id="5cedff08" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_execution(monitoring_schedule):</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check the execution of the Monitoring Job.</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function checks the execution of the Monitoring</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Job and prints out the list of violations if the job</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="co">    completed.</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>        executions <span class="op">=</span> monitoring_schedule.list_executions()</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> executions:</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>            execution <span class="op">=</span> executions[<span class="op">-</span><span class="dv">1</span>].describe()</span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processing Job Status: </span><span class="sc">{</span>execution[<span class="st">'ProcessingJobStatus'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> execution[<span class="st">"ProcessingJobStatus"</span>] <span class="op">==</span> <span class="st">"Completed"</span>:</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Exit Message: </span><span class="ch">\"</span><span class="sc">{</span>execution[<span class="st">'ExitMessage'</span>]<span class="sc">}</span><span class="ch">\"</span><span class="ss">"</span>)</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Last Modified Time: </span><span class="sc">{</span>execution[<span class="st">'LastModifiedTime'</span>]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>                    end<span class="op">=</span><span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>,</span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Execution:"</span>)</span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(json.dumps(execution, default<span class="op">=</span><span class="bu">str</span>, indent<span class="op">=</span><span class="dv">2</span>), end<span class="op">=</span><span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>                latest_monitoring_violations <span class="op">=</span> (</span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>                    monitoring_schedule.latest_monitoring_constraint_violations()</span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>                response <span class="op">=</span> json.loads(</span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>                    S3Downloader.read_file(latest_monitoring_violations.file_s3_uri),</span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Violations:"</span>)</span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(e)</span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a>check_execution(data_monitor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter validation failed:
Invalid type for parameter MonitoringScheduleName, value: None, type: &lt;class 'NoneType'&gt;, valid types: &lt;class 'str'&gt;</code></pre>
</div>
</div>
</section>
<section id="step-7---deleting-monitoring-schedule" class="level3">
<h3 class="anchored" data-anchor-id="step-7---deleting-monitoring-schedule">Step 7 - Deleting Monitoring Schedule</h3>
<p>Once we are done with it, we can delete the Data Monitoring schedule.</p>
<div id="7ff8bfc3" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>    data_monitor.delete_monitoring_schedule()</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:sagemaker:Deleting Monitoring Schedule with name: None</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter validation failed:
Invalid type for parameter MonitoringScheduleName, value: None, type: &lt;class 'NoneType'&gt;, valid types: &lt;class 'str'&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="session-19---model-monitoring" class="level2">
<h2 class="anchored" data-anchor-id="session-19---model-monitoring">Session 19 - Model Monitoring</h2>
<p>This session creates a Monitoring Job to monitor the quality of the model outputs. This schedule will run periodically and check the data that goes into the endpoint against the baseline we generated before.</p>
<p>Check <a href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_monitoring.html">Amazon SageMaker Model Monitor</a> for an explanation of how to use SageMaker’s Model Monitoring functionality. <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor.html">Monitor models for data and model quality, bias, and explainability</a> is a much more extensive guide to monitoring in Amazon SageMaker.</p>
<section id="step-1---configuring-ground-truth-location" class="level3">
<h3 class="anchored" data-anchor-id="step-1---configuring-ground-truth-location">Step 1 - Configuring Ground Truth Location</h3>
<p>Let’s start by defining the location where SageMaker will store the ground-truth generated by labeling the data received by the endpoint.</p>
<div id="5ddca53e" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>GROUND_TRUTH_LOCATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/monitoring/groundtruth"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2---deploying-the-model" class="level3">
<h3 class="anchored" data-anchor-id="step-2---deploying-the-model">Step 2 - Deploying the Model</h3>
<p>Let’s deploy the latest approved model to an endpoint.</p>
<p>Here, we can reuse the function we created before to deploy the model.</p>
<div id="c2089ba4" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="147">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>deploy_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3---generating-fake-traffic" class="level3">
<h3 class="anchored" data-anchor-id="step-3---generating-fake-traffic">Step 3 - Generating Fake Traffic</h3>
<p>To test the monitoring functionality, we need to generate traffic to the endpoint. We can use the function we created before to generate fake traffic to the endpoint.</p>
<div id="c4545041" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="148">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>generate_fake_traffic()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check the location where the endpoint stores the captured data, download a file, and display its content. It may take a few minutes for the first few files to show up in S3.</p>
<p>These files contain the data captured by the endpoint in a SageMaker-specific JSON-line format. Each inference request is captured in a single line in the <code>jsonl</code> file. The line contains both the input and output merged together:</p>
<div id="49bc662a" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> S3Downloader.<span class="bu">list</span>(DATA_CAPTURE_DESTINATION)</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(files):</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> S3Downloader.read_file(files[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"File: </span><span class="sc">{</span>files[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(json.loads(lines.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)[<span class="dv">0</span>]), indent<span class="op">=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File: s3://mlschool/penguins/monitoring/data-capture/penguins-endpoint/AllTraffic/2024/03/30/18/40-45-068-0f144be9-ac73-4c4e-a0c7-82b1ba7db88b.jsonl
{
  "captureData": {
    "endpointInput": {
      "observedContentType": "text/csv",
      "mode": "INPUT",
      "data": "Torgersen,39.1,18.7,181.0,3750.0,MALE",
      "encoding": "CSV"
    },
    "endpointOutput": {
      "observedContentType": "text/csv; charset=utf-8",
      "mode": "OUTPUT",
      "data": "Adelie,0.964408875\n",
      "encoding": "CSV"
    }
  },
  "eventMetadata": {
    "eventId": "08a239af-c98c-4984-b9bf-4ea049d88617",
    "inferenceId": "0",
    "inferenceTime": "2024-03-30T18:40:45Z"
  },
  "eventVersion": "0"
}</code></pre>
</div>
</div>
</section>
<section id="step-4---generating-fake-labels" class="level3">
<h3 class="anchored" data-anchor-id="step-4---generating-fake-labels">Step 4 - Generating Fake Labels</h3>
<p>To test the performance of the model, we need to label the samples captured by the endpoint. We can simulate the labeling process by generating a random label for every sample. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-monitor-model-quality-merge.html">Ingest Ground Truth Labels and Merge Them With Predictions</a> for more information about this.</p>
<div id="a4a32d8c" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="150">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timezone</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.s3 <span class="im">import</span> S3Uploader</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> []</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> inference_id <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data)):</span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    random.seed(inference_id)</span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>    records.append(</span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a>        json.dumps(</span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">"groundTruthData"</span>: {</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># For testing purposes, we will generate a random</span></span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># label for each request.</span></span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"data"</span>: random.choice([<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>]),</span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"encoding"</span>: <span class="st">"CSV"</span>,</span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"eventMetadata"</span>: {</span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># This value should match the id of the request</span></span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># captured by the endpoint.</span></span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"eventId"</span>: <span class="bu">str</span>(inference_id),</span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb178-24"><a href="#cb178-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"eventVersion"</span>: <span class="st">"0"</span>,</span>
<span id="cb178-25"><a href="#cb178-25" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb178-26"><a href="#cb178-26" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb178-27"><a href="#cb178-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb178-28"><a href="#cb178-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-29"><a href="#cb178-29" aria-hidden="true" tabindex="-1"></a>groundtruth_payload <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(records)</span>
<span id="cb178-30"><a href="#cb178-30" aria-hidden="true" tabindex="-1"></a>upload_time <span class="op">=</span> datetime.now(tz<span class="op">=</span>timezone.utc)</span>
<span id="cb178-31"><a href="#cb178-31" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>GROUND_TRUTH_LOCATION<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>upload_time<span class="sc">:</span><span class="op">%</span>Y<span class="op">/%</span>m<span class="op">/%</span>d<span class="op">/%</span>H<span class="op">/%</span>M<span class="op">%</span>S<span class="sc">}</span><span class="ss">.jsonl"</span></span>
<span id="cb178-32"><a href="#cb178-32" aria-hidden="true" tabindex="-1"></a>S3Uploader.upload_string_as_file_body(groundtruth_payload, uri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---creating-monitoring-schedule-1" class="level3">
<h3 class="anchored" data-anchor-id="step-5---creating-monitoring-schedule-1">Step 5 - Creating Monitoring Schedule</h3>
<p>To set up a Model Quality Monitoring Job, we can use the <a href="https://sagemaker.readthedocs.io/en/stable/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.ModelQualityMonitor">ModelQualityMonitor</a> class.</p>
<p>Check <a href="https://sagemaker-examples.readthedocs.io/en/latest/sagemaker_model_monitor/model_quality/model_quality_churn_sdk.html">Amazon SageMaker Model Quality Monitor</a> for a complete tutorial on how to run a Model Monitoring Job in SageMaker.</p>
<div id="54762759" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="151">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> ModelQualityMonitor</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>model_monitor <span class="op">=</span> ModelQualityMonitor(</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>config[<span class="st">"instance_type"</span>],</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">1800</span>,</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>    volume_size_in_gb<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the monitoring schedule. The <a href="https://sagemaker.readthedocs.io/en/v2.24.2/api/inference/model_monitor.html#sagemaker.model_monitor.model_monitoring.EndpointInput">EndpointInput</a> instance configures the attribute the monitoring job should use to determine the prediction from the model.</p>
<p>We are going to set up the monitoring schedule to run every hour. Keep in mind that SageMaker has a buffer period of 20 minutes to schedule an execution.</p>
<div id="9665c61a" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="152">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_monitor <span class="im">import</span> CronExpressionGenerator, EndpointInput</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>model_monitor.create_monitoring_schedule(</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>    monitor_schedule_name<span class="op">=</span><span class="st">"penguins-model-monitoring-schedule"</span>,</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>    endpoint_input<span class="op">=</span>EndpointInput(</span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>        endpoint_name<span class="op">=</span>ENDPOINT,</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The first attribute is the prediction made</span></span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># by the model. For example, here is a</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># potential output from the model:</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># [Adelie,0.977324724\n]</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>        inference_attribute<span class="op">=</span><span class="st">"0"</span>,</span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>        destination<span class="op">=</span><span class="st">"/opt/ml/processing/input_data"</span>,</span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>    problem_type<span class="op">=</span><span class="st">"MulticlassClassification"</span>,</span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>    ground_truth_input<span class="op">=</span>GROUND_TRUTH_LOCATION,</span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a>    constraints<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>MODEL_QUALITY_LOCATION<span class="sc">}</span><span class="ss">/constraints.json"</span>,</span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>    schedule_cron_expression<span class="op">=</span>CronExpressionGenerator.hourly(),</span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>    output_s3_uri<span class="op">=</span>MODEL_QUALITY_LOCATION,</span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a>    enable_cloudwatch_metrics<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's give SageMaker some time to process the</span></span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a><span class="co"># monitoring job before we start it.</span></span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">10</span>)</span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a>model_monitor.start_monitoring_schedule()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6---checking-violations-1" class="level3">
<h3 class="anchored" data-anchor-id="step-6---checking-violations-1">Step 6 - Checking Violations</h3>
<p>After the monitoring schedule runs for the first time, we can check the results of the last execution. If the job completed successfully, we can check if there are any violations.</p>
<div id="34ba56d9" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>check_execution(model_monitor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter validation failed:
Invalid type for parameter MonitoringScheduleName, value: None, type: &lt;class 'NoneType'&gt;, valid types: &lt;class 'str'&gt;</code></pre>
</div>
</div>
</section>
<section id="step-7---deleting-monitoring-schedule-1" class="level3">
<h3 class="anchored" data-anchor-id="step-7---deleting-monitoring-schedule-1">Step 7 - Deleting Monitoring Schedule</h3>
<p>Once we are done with it, we can delete the Data Monitoring schedule.</p>
<div id="7f250115" class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>    model_monitor.delete_monitoring_schedule()</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:sagemaker:Deleting Monitoring Schedule with name: None</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter validation failed:
Invalid type for parameter MonitoringScheduleName, value: None, type: &lt;class 'NoneType'&gt;, valid types: &lt;class 'str'&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="session-20---shadow-deployments" class="level2">
<h2 class="anchored" data-anchor-id="session-20---shadow-deployments">Session 20 - Shadow Deployments</h2>
<p>This session configures an endpoint running a production and a shadow variant. Check <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-validation.html">Safely validate models in production</a> for more information.</p>
<p><a href="images/shadow-deployment.png" target="_blank"> <img src="images/shadow-deployment.png" alt="Shadow Deployment" style="max-width: 740px;"></a></p>
<section id="step-1---getting-the-latest-models" class="level3">
<h3 class="anchored" data-anchor-id="step-1---getting-the-latest-models">Step 1 - Getting The Latest Models</h3>
<p>We want to deploy the two latest approved models from the Model Registry to the same endpoint. The latest version of the model will act as the Shadow variant, and the previous version will act as the Production variant.</p>
<div id="d322d415" class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> sagemaker_client.list_model_packages(</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>    ModelPackageGroupName<span class="op">=</span>BASIC_MODEL_PACKAGE_GROUP,</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    ModelApprovalStatus<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>    SortBy<span class="op">=</span><span class="st">"CreationTime"</span>,</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>    MaxResults<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> response[<span class="st">"ModelPackageSummaryList"</span>]:</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>    production_package <span class="op">=</span> response[<span class="st">"ModelPackageSummaryList"</span>][<span class="dv">1</span>][<span class="st">"ModelPackageArn"</span>]</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>    shadow_package <span class="op">=</span> response[<span class="st">"ModelPackageSummaryList"</span>][<span class="dv">0</span>][<span class="st">"ModelPackageArn"</span>]</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>    production_package <span class="op">=</span> <span class="va">None</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>    shadow_package <span class="op">=</span> <span class="va">None</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Production package: </span><span class="sc">{</span>production_package<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Shadow package: </span><span class="sc">{</span>shadow_package<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Production package: arn:aws:sagemaker:us-east-1:325223348818:model-package/basic-penguins/5
Shadow package: arn:aws:sagemaker:us-east-1:325223348818:model-package/basic-penguins/6</code></pre>
</div>
</div>
</section>
<section id="step-2---creating-the-models" class="level3">
<h3 class="anchored" data-anchor-id="step-2---creating-the-models">Step 2 - Creating the Models</h3>
<p>We want to deploy the two packages to a new endpoint. We’ll use the boto3 API to deploy these models.</p>
<p>Let’s start by creating the SageMaker Models.</p>
<div id="6c8aea09" class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll use a different name for this endpoint.</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>SHADOW_DEPLOYMENT_ENDPOINT <span class="op">=</span> <span class="st">"shadow-penguins-endpoint"</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The timestamp will help us create unique name for the</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a><span class="co"># name of the models.</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>timestamp <span class="op">=</span> time.strftime(<span class="st">"%m</span><span class="sc">%d</span><span class="st">%H%M%S"</span>, time.localtime())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now create the Production model.</p>
<div id="dd20b354" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="157">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>production_model_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>SHADOW_DEPLOYMENT_ENDPOINT<span class="sc">}</span><span class="ss">-production-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>sagemaker_client.create_model(</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>    ModelName<span class="op">=</span>production_model_name,</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    ExecutionRoleArn<span class="op">=</span>role,</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>    Containers<span class="op">=</span>[{<span class="st">"ModelPackageName"</span>: production_package}],</span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we can create the second model.</p>
<div id="d2024f35" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>shadow_model_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>SHADOW_DEPLOYMENT_ENDPOINT<span class="sc">}</span><span class="ss">-shadow-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>sagemaker_client.create_model(</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    ModelName<span class="op">=</span>shadow_model_name,</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>    ExecutionRoleArn<span class="op">=</span>role,</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    Containers<span class="op">=</span>[{<span class="st">"ModelPackageName"</span>: shadow_package}],</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="158">
<pre><code>{'ModelArn': 'arn:aws:sagemaker:us-east-1:325223348818:model/shadow-penguins-endpoint-shadow-0521203542',
 'ResponseMetadata': {'RequestId': 'c9905dba-09bf-4e77-b3d9-7f09ad308c81',
  'HTTPStatusCode': 200,
  'HTTPHeaders': {'x-amzn-requestid': 'c9905dba-09bf-4e77-b3d9-7f09ad308c81',
   'content-type': 'application/x-amz-json-1.1',
   'content-length': '104',
   'date': 'Wed, 22 May 2024 00:35:48 GMT'},
  'RetryAttempts': 1}}</code></pre>
</div>
</div>
</section>
<section id="step-3---creating-the-endpoint-configuration" class="level3">
<h3 class="anchored" data-anchor-id="step-3---creating-the-endpoint-configuration">Step 3 - Creating the Endpoint Configuration</h3>
<p>We can now create the Endpoint Configuration using the two models</p>
<p>Let’s define the location where SageMaker will output the information captured by the Shadow variant.</p>
<div id="85769b3e" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>SHADOW_DATA_DESTINATION <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>S3_LOCATION<span class="sc">}</span><span class="ss">/endpoint/"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can create the Endpoint Configuration now.</p>
<div id="969df4f8" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>endpoint_config_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>SHADOW_DEPLOYMENT_ENDPOINT<span class="sc">}</span><span class="ss">-config-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>sagemaker_client.create_endpoint_config(</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    ProductionVariants<span class="op">=</span>[</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ModelName"</span>: production_model_name,</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InstanceType"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialVariantWeight"</span>: <span class="dv">1</span>,</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialInstanceCount"</span>: <span class="dv">1</span>,</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"VariantName"</span>: <span class="st">"ProductionTraffic"</span>,</span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>    ShadowProductionVariants<span class="op">=</span>[</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ModelName"</span>: shadow_model_name,</span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InstanceType"</span>: <span class="st">"ml.m5.xlarge"</span>,</span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialVariantWeight"</span>: <span class="dv">1</span>,</span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"InitialInstanceCount"</span>: <span class="dv">1</span>,</span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"VariantName"</span>: <span class="st">"ShadowTraffic"</span>,</span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a>    DataCaptureConfig<span class="op">=</span>{</span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EnableCapture"</span>: <span class="va">True</span>,</span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"InitialSamplingPercentage"</span>: <span class="dv">100</span>,</span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"DestinationS3Uri"</span>: SHADOW_DATA_DESTINATION,</span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CaptureOptions"</span>: [</span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"CaptureMode"</span>: <span class="st">"Input"</span>},</span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"CaptureMode"</span>: <span class="st">"Output"</span>},</span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb193-31"><a href="#cb193-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CaptureContentTypeHeader"</span>: {</span>
<span id="cb193-32"><a href="#cb193-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CsvContentTypes"</span>: [<span class="st">"text/csv"</span>, <span class="st">"application/octect-stream"</span>],</span>
<span id="cb193-33"><a href="#cb193-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"JsonContentTypes"</span>: [<span class="st">"application/json"</span>, <span class="st">"application/octect-stream"</span>],</span>
<span id="cb193-34"><a href="#cb193-34" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb193-35"><a href="#cb193-35" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb193-36"><a href="#cb193-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="160">
<pre><code>{'EndpointConfigArn': 'arn:aws:sagemaker:us-east-1:325223348818:endpoint-config/shadow-penguins-endpoint-config-0521203542',
 'ResponseMetadata': {'RequestId': '721699dd-8e93-4e9f-b784-ce06f1dd0fed',
  'HTTPStatusCode': 200,
  'HTTPHeaders': {'x-amzn-requestid': '721699dd-8e93-4e9f-b784-ce06f1dd0fed',
   'content-type': 'application/x-amz-json-1.1',
   'content-length': '123',
   'date': 'Wed, 22 May 2024 00:35:48 GMT'},
  'RetryAttempts': 0}}</code></pre>
</div>
</div>
</section>
<section id="step-4---creating-the-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="step-4---creating-the-endpoint">Step 4 - Creating the Endpoint</h3>
<p>Finally, we can create the Endpoint using the Endpoint Configuration we created before.</p>
<div id="33e8d886" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>sagemaker_client.create_endpoint(</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>    EndpointName<span class="op">=</span>SHADOW_DEPLOYMENT_ENDPOINT,</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    EndpointConfigName<span class="op">=</span>endpoint_config_name,</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-5---generating-traffic" class="level3">
<h3 class="anchored" data-anchor-id="step-5---generating-traffic">Step 5 - Generating Traffic</h3>
<p>Let’s generate some traffic to the endpoint so we can test the Shadow variant.</p>
<div id="069afdae" class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="st">0.6569590202313976,-1.0813829646495108,1.2097102831892812,0.9226343641317372,1.0,0.0,0.0</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="st">-0.7751048801481084,0.8822689351285553,-1.2168066120762704,0.9226343641317372,0.0,1.0,0.0</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a><span class="st">-0.837387834894918,0.3386660813829646,-0.26237731892812,-1.92351941317372,0.0,0.0,1.0</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>SHADOW_DEPLOYMENT_ENDPOINT,</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>CSVSerializer(),</span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>    deserializer<span class="op">=</span>JSONDeserializer(),</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> predictor.predict(payload)</span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(response, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationError) when calling the InvokeEndpoint operation: Endpoint shadow-penguins-endpoint of account 325223348818 not found.</code></pre>
</div>
</div>
</section>
<section id="step-6---checking-captured-data" class="level3">
<h3 class="anchored" data-anchor-id="step-6---checking-captured-data">Step 6 - Checking Captured Data</h3>
<p>Let’s check the location where the endpoint stores the captured data, download a file, and display its content. It may take a few minutes for the first few files to show up in S3.</p>
<p>The endpoint will capture the data for both the Production and the Shadow variants.</p>
<div id="9ffadf06" class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> S3Downloader.<span class="bu">list</span>(</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>SHADOW_DATA_DESTINATION<span class="sc">}{</span>SHADOW_DEPLOYMENT_ENDPOINT<span class="sc">}</span><span class="ss">/ShadowTraffic/"</span>,</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(files):</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> S3Downloader.read_file(files[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"File: </span><span class="sc">{</span>files[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(json.dumps(json.loads(lines.split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)[<span class="dv">0</span>]), indent<span class="op">=</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File: s3://mlschool/penguins/endpoint/shadow-penguins-endpoint/ShadowTraffic/2024/03/31/16/57-29-141-b62d2c9e-bf7b-4660-8086-e2f28a7c3181.jsonl
{
  "captureData": {
    "endpointInput": {
      "observedContentType": "text/csv",
      "mode": "INPUT",
      "data": "\n0.6569590202313976,-1.0813829646495108,1.2097102831892812,0.9226343641317372,1.0,0.0,0.0\n-0.7751048801481084,0.8822689351285553,-1.2168066120762704,0.9226343641317372,0.0,1.0,0.0\n-0.837387834894918,0.3386660813829646,-0.26237731892812,-1.92351941317372,0.0,0.0,1.0\n",
      "encoding": "CSV"
    },
    "endpointOutput": {
      "observedContentType": "application/json",
      "mode": "OUTPUT",
      "data": "{    \"predictions\": [[0.124825425, 0.0847824216, 0.79039216], [0.766525269, 0.220783874, 0.0126908608], [0.944253445, 0.0292692278, 0.0264772158]    ]}",
      "encoding": "JSON"
    }
  },
  "eventMetadata": {
    "eventId": "706af7e2-4746-4c81-82f9-3b34120142b8",
    "invocationSource": "ShadowExperiment",
    "inferenceTime": "2024-03-31T16:57:29Z"
  },
  "eventVersion": "0"
}</code></pre>
</div>
</div>
</section>
<section id="step-7---deleting-the-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="step-7---deleting-the-endpoint">Step 7 - Deleting the Endpoint</h3>
<p>Let’s now delete the endpoint.</p>
<div id="2ee1ce12" class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>    sagemaker_client.delete_endpoint(EndpointName<span class="op">=</span>SHADOW_DEPLOYMENT_ENDPOINT)</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>An error occurred (ValidationException) when calling the DeleteEndpoint operation: Could not find endpoint "shadow-penguins-endpoint".</code></pre>
</div>
</div>
</section>
</section>
<section id="running-the-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="running-the-pipeline">Running the Pipeline</h2>
<p>We can run any of the pipelines we defined before by enabling the cell below and specifying the pipeline we want to run.</p>
<div id="59d1e634" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="165">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>session3_pipeline.start()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deleting-the-endpoint" class="level2">
<h2 class="anchored" data-anchor-id="deleting-the-endpoint">Deleting the Endpoint</h2>
<p>After testing the endpoint, we need to ensure we delete it.</p>
<div id="6b32c3a4-312e-473c-a217-33606f77d1e9" class="cell" data-tags="[&quot;hide-output&quot;]" data-execution_count="166">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>    sagemaker_client.delete_endpoint(EndpointName<span class="op">=</span>ENDPOINT)</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/svpino\.github\.io\/ml\.school");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/svpino/ml.school/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>